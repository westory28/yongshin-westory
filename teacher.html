<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì‚¬ ëŒ€ì‹œë³´ë“œ - ë°©ì¬ì„</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f5f5f4; margin: 0; padding: 0; }
        .admin-table th, .admin-table td { border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        .admin-table th:not(:last-child), .admin-table td:not(:last-child) { border-right: 2px solid #d6d3d1; }
        .col-answer { background-color: #fffbeb; color: #b45309; font-weight: bold; }
        .rate-bar-bg { background-color: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden; width: 100%; margin-top: 4px; }
        .rate-bar-fill { height: 100%; transition: width 0.5s ease; }
        .page-btn { padding: 6px 12px; margin: 0 2px; border: 1px solid #d1d5db; border-radius: 4px; background: white; cursor: pointer; font-size: 0.9rem; }
        .page-btn.active { background-color: #4b5563; color: white; border-color: #4b5563; font-weight: bold; }
        .choice-btn { width: 100%; text-align: left; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; background-color: white; margin-bottom: 0.5rem; }
        .choice-btn.selected { border: 2px solid #d97706; background-color: #fffbeb; color: #92400e; font-weight: bold; }
        .ox-btn { height: 60px; font-size: 1.5rem; font-weight: bold; width: 100%; border: 1px solid #ccc; border-radius: 8px; }
        
        #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; color: white; }
        
        .q-image-thumb { max-width: 100%; max-height: 200px; border-radius: 4px; border: 1px solid #ddd; cursor: zoom-in; }
        #image-zoom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; cursor: zoom-out; }
        #image-zoom-content { max-width: 95%; max-height: 95%; border-radius: 4px; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        
        /* í•™ìƒ ê´€ë¦¬ í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
        .student-row:hover { background-color: #f3f4f6; }
        .student-name-link { color: #2563eb; font-weight: bold; cursor: pointer; text-decoration: underline; }
        .student-name-link:hover { color: #1e40af; }
    </style>
</head>
<body class="text-stone-800 min-h-screen">

    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-white border-solid mb-4"></div>
        <p class="text-xl font-bold">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</p>
        <p class="text-sm mt-2">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</p>
    </div>

    <div id="image-zoom-modal" onclick="document.getElementById('image-zoom-modal').style.display='none'"><img id="image-zoom-content" src=""></div>

    <div id="view-login-screen" style="display: flex;" class="items-center justify-center min-h-screen flex-col bg-stone-100 p-4">
        <div class="bg-white p-8 rounded-xl shadow-xl max-w-sm w-full text-center border-t-4 border-amber-600">
            <h1 class="text-2xl font-bold mb-2">êµì‚¬ ì¸ì¦</h1>
            <p class="text-stone-500 mb-8 text-sm">êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.<br>(60ë¶„ ë¯¸í™œë™ ì‹œ ìë™ ë¡œê·¸ì•„ì›ƒ)</p>
            <button onclick="app.login()" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-3 px-4 rounded shadow hover:bg-gray-50 flex items-center justify-center gap-2 transition cursor-pointer">
                <i class="fab fa-google text-red-500"></i> êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
            </button>
            <p class="text-xs text-gray-400 mt-4">ìš©ì‹ ì¤‘í•™êµ ì—­ì‚¬ê³¼ ë°©ì¬ì„</p>
        </div>
    </div>

    <div id="view-dashboard" style="display: none;" class="p-6 max-w-7xl mx-auto">
        <div class="bg-white p-6 rounded shadow-xl border border-stone-300">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div class="flex items-center gap-4">
                    <div>
                        <h2 class="font-bold text-2xl text-stone-800"><i class="fas fa-chalkboard-teacher text-amber-600 mr-2"></i>êµì‚¬ ëŒ€ì‹œë³´ë“œ</h2>
                        <p class="text-xs text-stone-500 mt-1">Firebase ì—°ë™ë¨ (ìë™ ë¡œê·¸ì•„ì›ƒ ì„¤ì •ë¨)</p>
                    </div>
                    <div class="flex bg-stone-100 p-1 rounded border border-stone-300 ml-4">
                        <input type="text" id="search-student-name" placeholder="í•™ìƒ ì´ë¦„ ê²€ìƒ‰" class="bg-transparent px-2 py-1 text-sm outline-none" onkeypress="if(event.key==='Enter') app.searchStudent()">
                        <button onclick="app.searchStudent()" class="bg-stone-800 text-white px-3 py-1 rounded text-xs font-bold hover:bg-stone-700">ê²€ìƒ‰</button>
                    </div>
                </div>
                <button onclick="app.logout()" class="bg-stone-200 hover:bg-stone-300 text-stone-700 px-4 py-2 rounded text-sm font-bold">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <div class="flex flex-wrap gap-2 mb-6">
                <button onclick="app.setTeacherTab('log')" id="btn-tab-log" class="px-5 py-2 rounded-full bg-stone-800 text-white text-sm font-bold shadow transition">ì‹¤ì‹œê°„ ê¸°ë¡</button>
                <button onclick="app.setTeacherTab('bank')" id="btn-tab-bank" class="px-5 py-2 rounded-full bg-stone-100 text-stone-600 text-sm font-bold shadow transition">ë¬¸ì œ ì€í–‰</button>
                <button onclick="app.setTeacherTab('add')" id="btn-tab-add" class="px-5 py-2 rounded-full bg-stone-100 text-stone-600 text-sm font-bold shadow transition">ë¬¸ì œ ì¶”ê°€</button>
                <button onclick="app.setTeacherTab('student')" id="btn-tab-student" class="px-5 py-2 rounded-full bg-stone-100 text-stone-600 text-sm font-bold shadow transition">í•™ìƒ ê´€ë¦¬</button>
            </div>

            <div id="tab-log">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <h3 class="font-bold text-lg flex items-center">ì œì¶œ í˜„í™© <span id="log-count" class="text-sm font-normal text-stone-500 ml-2"></span></h3>
                    <div class="flex gap-2 items-center flex-wrap">
                        <span class="text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded">â–¼ ë°˜ ì„ íƒ</span>
                        <select id="select-class-trigger" onchange="app.loadByClass(this.value)" class="p-2 border-2 border-amber-500 rounded text-sm font-bold bg-amber-50 cursor-pointer">
                            <option value="">ì„ íƒ ëŒ€ê¸°</option>
                            <option value="1">1ë°˜</option><option value="2">2ë°˜</option><option value="3">3ë°˜</option><option value="4">4ë°˜</option><option value="5">5ë°˜</option>
                            <option value="6">6ë°˜</option><option value="7">7ë°˜</option><option value="8">8ë°˜</option><option value="9">9ë°˜</option><option value="10">10ë°˜</option>
                            <option value="all">ì „ì²´ (ìµœê·¼ 50ê°œ)</option>
                        </select>
                        <button onclick="app.analyzeClassStats()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded text-sm font-bold shadow"><i class="fas fa-chart-bar mr-1"></i> í†µê³„ ë¶„ì„</button>
                        <select id="sort-logs" onchange="app.renderLogs()" class="p-2 border rounded text-sm"><option value="time">ìµœì‹ ìˆœ</option><option value="number">ë²ˆí˜¸ìˆœ</option><option value="score_desc">ì ìˆ˜ ë†’ì€ìˆœ</option></select>
                        <button onclick="app.loadByClass(document.getElementById('select-class-trigger').value)" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded text-sm font-bold"><i class="fas fa-sync-alt"></i></button>
                        <button onclick="app.deleteSelectedLogs()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm font-bold"><i class="fas fa-trash"></i></button>
                        <button onclick="app.downloadExcel()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm font-bold"><i class="fas fa-file-excel"></i> ì—‘ì…€</button>
                    </div>
                </div>
                <div class="overflow-auto max-h-[600px] border rounded bg-stone-50">
                    <table class="w-full text-sm text-left admin-table"><thead class="bg-stone-200 text-stone-700 sticky top-0 font-bold"><tr><th class="p-3 w-10 text-center"><input type="checkbox" onchange="document.querySelectorAll('.log-checkbox').forEach(cb=>cb.checked=this.checked)"></th><th class="p-3">ì‹œê°„</th><th class="p-3">ì •ë³´</th><th class="p-3">ì ìˆ˜</th><th class="p-3">ìƒíƒœ</th><th class="p-3">ì‚­ì œ</th></tr></thead><tbody id="teacher-log-body" class="bg-white"><tr><td colspan="6" class="p-10 text-center text-stone-500 font-bold">ğŸ‘† ìœ„ì—ì„œ ë°˜ì„ ì„ íƒí•˜ë©´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</td></tr></tbody></table>
                </div>
                <div id="pagination-controls" class="flex justify-center gap-2 mt-4"></div>
            </div>

            <div id="tab-bank" style="display:none;">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 bg-stone-50 p-3 rounded border border-stone-200 gap-3">
                    <h3 class="font-bold text-lg">ì „ì²´ ë¬¸ì œ <span id="total-q-count" class="text-sm text-stone-500"></span></h3>
                    <div class="flex gap-2 flex-wrap">
                        <span class="text-xs text-gray-500 flex items-center bg-white px-2 rounded border">ğŸ’¡ ì „ì²´ í†µê³„ëŠ” [ê°±ì‹ ] ë²„íŠ¼ì„ ëˆ„ë¥¼ ë•Œë§Œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</span>
                        <button onclick="app.calculateGlobalStats()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded text-xs font-bold shadow-md flex items-center"><i class="fas fa-sync mr-1"></i> ì „ì²´ í†µê³„ ê°±ì‹  (ì„œë²„ ì €ì¥)</button>
                        <select id="bank-sort" onchange="app.renderBank()" class="p-2 border rounded text-xs">
                            <option value="id">ë²ˆí˜¸ìˆœ</option>
                            <option value="unit">ë‹¨ì›ìˆœ</option>
                            <option value="type">ìœ í˜•ìˆœ</option>
                            <option value="rate_asc">ì·¨ì•½ ìœ í˜•ìˆœ (ì •ë‹µë¥  ë‚®ìŒ)</option>
                            <option value="rate_desc">ì •ë‹µë¥  ë†’ì€ ìˆœ</option>
                        </select>
                        <select id="bank-filter-unit" onchange="app.renderBank()" class="p-2 border rounded text-xs w-32"><option value="all">ëª¨ë“  ë‹¨ì›</option><option value="I.">I. ê³ ëŒ€</option><option value="II.">II. ì¢…êµ/ë¬¸í™”</option><option value="III.">III. ì§€ì—­êµë¥˜</option><option value="IV.">IV. ì œêµ­ì£¼ì˜</option><option value="V.">V. ì„¸ê³„ëŒ€ì „</option></select>
                        <button onclick="app.deleteSelectedQuestions()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-xs font-bold"><i class="fas fa-trash"></i> ì‚­ì œ</button>
                    </div>
                </div>
                <div class="overflow-auto max-h-[500px] border rounded bg-stone-50">
                    <table class="w-full text-sm text-left admin-table"><thead class="bg-stone-200 text-stone-700 sticky top-0 font-bold"><tr><th class="p-3 w-10 text-center"><input type="checkbox" onchange="document.querySelectorAll('.q-checkbox').forEach(cb=>cb.checked=this.checked)"></th><th class="p-3 w-16 text-center">ID</th><th class="p-3 w-32">ë‹¨ì›</th><th class="p-3 w-20 text-center">ìœ í˜•</th><th class="p-3">ë¬¸ì œ</th><th class="p-3 w-20 text-center">ë³´ê¸°</th><th class="p-3 w-32 col-answer text-center">ì •ë‹µ</th><th class="p-3 w-24 text-center">ì •ë‹µë¥  (ì „ì²´)</th></tr></thead><tbody id="bank-body" class="bg-white"></tbody></table>
                </div>
            </div>

            <div id="tab-add" style="display:none;">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-stone-50 p-6 rounded border border-stone-200">
                        <div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="font-bold text-xl">ë¬¸ì œ ë§Œë“¤ê¸°</h3><span id="next-q-id-display" class="bg-amber-100 text-amber-800 text-xs font-bold px-3 py-1 rounded-full border border-amber-200"></span></div>
                        <div class="space-y-4">
                            <div><label class="block text-sm font-bold mb-1">ë‹¨ì›</label><select id="new-q-unit" class="w-full p-2 border rounded"><option value="I. ë¬¸ëª…ì˜ ë°œìƒê³¼ ê³ ëŒ€ ì„¸ê³„ì˜ í˜•ì„±">I. ê³ ëŒ€ ì„¸ê³„</option><option value="II. ì„¸ê³„ ì¢…êµì˜ í™•ì‚°ê³¼ ì§€ì—­ ë¬¸í™”ì˜ í˜•ì„±">II. ì„¸ê³„ ì¢…êµ</option><option value="III. ì§€ì—­ ì„¸ê³„ì˜ êµë¥˜ì™€ ë³€í™”">III. ì§€ì—­ ì„¸ê³„</option><option value="IV. ì œêµ­ì£¼ì˜ ì¹¨ëµê³¼ êµ­ë¯¼ êµ­ê°€ ê±´ì„¤ ìš´ë™">IV. ì œêµ­ì£¼ì˜</option><option value="V. ì„¸ê³„ ëŒ€ì „ê³¼ ì‚¬íšŒ ë³€ë™">V. ì„¸ê³„ ëŒ€ì „</option></select></div>
                            <div><label class="block text-sm font-bold mb-1">ìœ í˜•</label><select id="new-q-type" class="w-full p-2 border rounded" onchange="app.toggleOptionInput('new')"><option value="choice">ê°ê´€ì‹</option><option value="word">ë‹¨ë‹µí˜•</option><option value="order">ìˆœì„œ ë§ì¶”ê¸°</option><option value="ox">O/X í€´ì¦ˆ</option></select></div>
                            <div><label class="block text-sm font-bold mb-1">ì´ë¯¸ì§€</label><input type="file" id="new-q-image" accept="image/*" class="w-full text-xs" onchange="app.handleImageUpload(this, 'new')"><img id="new-q-image-preview" style="display:none;" class="mt-2 h-20 rounded border"><input type="hidden" id="new-q-image-base64"></div>
                            <div><label class="block text-sm font-bold mb-1">ë¬¸ì œ</label><textarea id="new-q-text" class="w-full p-2 border rounded h-20"></textarea></div>
                            <div id="option-container-new"><label class="block text-sm font-bold mb-1">ë³´ê¸°</label><input type="text" id="new-q-options" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm font-bold mb-1">ì •ë‹µ</label><input type="text" id="new-q-answer" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm font-bold mb-1">í•´ì„¤</label><input type="text" id="new-q-exp" class="w-full p-2 border rounded"></div>
                            <button onclick="app.addCustomQuestion()" class="w-full bg-amber-600 text-white font-bold py-3 rounded hover:bg-amber-700">ì¶”ê°€í•˜ê¸°</button>
                        </div>
                    </div>
                    <div class="bg-green-50 p-6 rounded border border-green-200 h-fit">
                        <h3 class="font-bold text-xl mb-4 border-b pb-2 text-green-800">ì—‘ì…€ ì—…ë¡œë“œ</h3>
                        <input type="file" id="excel-file" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500 mb-4"/>
                        <button onclick="app.uploadExcel()" class="w-full bg-green-600 text-white font-bold py-3 rounded hover:bg-green-700 mb-4">ì—‘ì…€ ì—…ë¡œë“œ ì‹œì‘</button>
                        <div class="text-center"><button onclick="app.downloadTemplate()" class="text-xs text-gray-500 underline">ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button></div>
                    </div>
                </div>
            </div>

            <div id="tab-student" style="display:none;">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 bg-stone-50 p-3 rounded border border-stone-200 gap-3">
                    <h3 class="font-bold text-lg">ê°€ì… í•™ìƒ ëª©ë¡ <span id="student-total-count" class="text-sm text-stone-500"></span></h3>
                    <div class="flex gap-2">
                        <input type="text" id="search-student-mgmt" placeholder="ì´ë¦„/ë°˜ ê²€ìƒ‰" class="p-2 border rounded text-xs w-40" onkeypress="if(event.key==='Enter') app.filterStudents()">
                        <button onclick="app.filterStudents()" class="bg-stone-800 text-white px-3 py-2 rounded text-xs font-bold">ê²€ìƒ‰</button>
                        <button onclick="app.loadStudents()" class="bg-indigo-600 text-white px-3 py-2 rounded text-xs font-bold"><i class="fas fa-sync"></i> ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                </div>
                <div class="overflow-auto max-h-[600px] border rounded bg-stone-50">
                    <table class="w-full text-sm text-left admin-table">
                        <thead class="bg-stone-200 text-stone-700 sticky top-0 font-bold">
                            <tr>
                                <th class="p-3 w-16 text-center">ë°˜</th>
                                <th class="p-3 w-16 text-center">ë²ˆí˜¸</th>
                                <th class="p-3">ì´ë¦„ (í´ë¦­ ì‹œ ë§ˆì´í˜ì´ì§€)</th>
                                <th class="p-3">ì´ë©”ì¼</th>
                                <th class="p-3 text-center">ê°€ì…/ìˆ˜ì •ì¼</th>
                                <th class="p-3 text-center w-32">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody id="student-list-body" class="bg-white">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="student-detail-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center"><div class="modal-overlay absolute inset-0" onclick="document.getElementById('student-detail-modal').style.display='none'"></div><div class="bg-white p-8 rounded-lg shadow-2xl z-10 w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto"><h3 class="font-bold text-xl mb-4 border-b pb-2">ìƒì„¸ ì •ë³´</h3><div id="student-detail-content"></div><div class="mt-4 text-center"><button onclick="document.getElementById('student-detail-modal').style.display='none'" class="bg-gray-200 px-4 py-2 rounded">ë‹«ê¸°</button></div></div></div>
    <div id="preview-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center"><div class="modal-overlay absolute inset-0" onclick="document.getElementById('preview-modal').style.display='none'"></div><div class="bg-white p-8 rounded-lg shadow-2xl z-10 w-full max-w-lg mx-4 max-h-[80vh] overflow-y-auto"><div id="preview-content"></div><div class="mt-6 text-center"><button onclick="document.getElementById('preview-modal').style.display='none'" class="bg-gray-200 px-4 py-2 rounded">ë‹«ê¸°</button></div></div></div>
    <div id="edit-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center"><div class="modal-overlay absolute inset-0" onclick="app.closeEditModal()"></div><div class="bg-white p-6 rounded-lg shadow-xl z-10 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto"><h3 class="font-bold text-xl mb-4 border-b pb-2">ë¬¸ì œ ìˆ˜ì •</h3><input type="hidden" id="edit-q-id"><div class="space-y-4"><div><label class="block text-sm font-bold mb-1">ë‹¨ì›</label><select id="edit-q-unit" class="w-full p-2 border rounded"><option value="I. ë¬¸ëª…ì˜ ë°œìƒê³¼ ê³ ëŒ€ ì„¸ê³„ì˜ í˜•ì„±">I. ê³ ëŒ€ ì„¸ê³„</option><option value="II. ì„¸ê³„ ì¢…êµì˜ í™•ì‚°ê³¼ ì§€ì—­ ë¬¸í™”ì˜ í˜•ì„±">II. ì„¸ê³„ ì¢…êµ</option><option value="III. ì§€ì—­ ì„¸ê³„ì˜ êµë¥˜ì™€ ë³€í™”">III. ì§€ì—­ ì„¸ê³„</option><option value="IV. ì œêµ­ì£¼ì˜ ì¹¨ëµê³¼ êµ­ë¯¼ êµ­ê°€ ê±´ì„¤ ìš´ë™">IV. ì œêµ­ì£¼ì˜</option><option value="V. ì„¸ê³„ ëŒ€ì „ê³¼ ì‚¬íšŒ ë³€ë™">V. ì„¸ê³„ ëŒ€ì „</option></select></div><div><label class="block text-sm font-bold mb-1">ìœ í˜•</label><select id="edit-q-type" class="w-full p-2 border rounded" onchange="app.toggleOptionInput('edit')"><option value="choice">ê°ê´€ì‹</option><option value="word">ë‹¨ë‹µí˜•</option><option value="order">ìˆœì„œ ë§ì¶”ê¸°</option><option value="ox">O/X í€´ì¦ˆ</option></select></div><div><label class="block text-sm font-bold mb-1">ì´ë¯¸ì§€</label><input type="file" id="edit-q-image-input" accept="image/*" class="w-full text-xs" onchange="app.handleImageUpload(this, 'edit')"><img id="edit-q-image-preview" class="hidden q-image-thumb mt-2"><input type="hidden" id="edit-q-image-base64"><button onclick="document.getElementById('edit-q-image-preview').style.display='none';document.getElementById('edit-q-image-base64').value='';" class="text-red-500 text-xs">ì´ë¯¸ì§€ ì‚­ì œ</button></div><div><label class="block text-sm font-bold mb-1">ë¬¸ì œ</label><textarea id="edit-q-text" class="w-full p-2 border rounded h-20"></textarea></div><div id="option-container-edit"><label class="block text-sm font-bold mb-1">ë³´ê¸°</label><input type="text" id="edit-q-options" class="w-full p-2 border rounded"></div><div><label class="block text-sm font-bold mb-1">ì •ë‹µ</label><input type="text" id="edit-q-answer" class="w-full p-2 border rounded"></div><div><label class="block text-sm font-bold mb-1">í•´ì„¤</label><input type="text" id="edit-q-exp" class="w-full p-2 border rounded"></div><div class="flex gap-2 pt-2"><button onclick="app.saveEditedQuestion()" class="flex-1 bg-green-600 text-white font-bold py-3 rounded">ì €ì¥</button><button onclick="app.closeEditModal()" class="flex-1 bg-stone-200 text-stone-700 font-bold py-3 rounded">ì·¨ì†Œ</button></div></div></div></div>
    <div id="stats-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center"><div class="modal-overlay absolute inset-0" onclick="document.getElementById('stats-modal').style.display='none'"></div><div class="bg-white p-8 rounded-lg shadow-2xl z-10 w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto"><h3 class="font-bold text-xl mb-4 border-b pb-2">í†µê³„ ë¶„ì„ (í•™ìƒë³„ ì •ë‹µë¥ )</h3><div id="stats-content"></div><div class="mt-4 text-center"><button onclick="document.getElementById('stats-modal').style.display='none'" class="bg-gray-200 px-4 py-2 rounded">ë‹«ê¸°</button></div></div></div>

    <div id="student-edit-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="modal-overlay absolute inset-0" onclick="document.getElementById('student-edit-modal').style.display='none'"></div>
        <div class="bg-white p-6 rounded-lg shadow-xl z-10 w-full max-w-sm mx-4">
            <h3 class="font-bold text-xl mb-4 border-b pb-2">í•™ìƒ ì •ë³´ ìˆ˜ì •</h3>
            <input type="hidden" id="edit-std-docId">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-1">ì´ë©”ì¼</label>
                    <input type="text" id="edit-std-email" class="w-full p-2 border rounded bg-gray-100" readonly>
                </div>
                <div class="flex gap-2">
                    <div class="flex-1">
                        <label class="block text-sm font-bold mb-1">ë°˜</label>
                        <input type="number" id="edit-std-class" class="w-full p-2 border rounded">
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-bold mb-1">ë²ˆí˜¸</label>
                        <input type="number" id="edit-std-number" class="w-full p-2 border rounded">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1">ì´ë¦„</label>
                    <input type="text" id="edit-std-name" class="w-full p-2 border rounded">
                </div>
                <div class="flex gap-2 pt-2">
                    <button onclick="app.saveStudentInfo()" class="flex-1 bg-green-600 text-white font-bold py-3 rounded">ì €ì¥</button>
                    <button onclick="document.getElementById('student-edit-modal').style.display='none'" class="flex-1 bg-stone-200 text-stone-700 font-bold py-3 rounded">ì·¨ì†Œ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="student-profile-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="modal-overlay absolute inset-0" onclick="document.getElementById('student-profile-modal').style.display='none'"></div>
        <div class="bg-white p-6 rounded-lg shadow-xl z-10 w-full max-w-2xl mx-4 max-h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="font-bold text-xl text-stone-800"><i class="fas fa-user-graduate text-amber-600 mr-2"></i>í•™ìƒ ë§ˆì´í˜ì´ì§€</h3>
                <button onclick="document.getElementById('student-profile-modal').style.display='none'" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="student-profile-content">
                </div>
            <div class="mt-4 text-center">
                <button onclick="document.getElementById('student-profile-modal').style.display='none'" class="bg-gray-200 px-6 py-2 rounded font-bold text-gray-700">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAOlPQ5PFmL0zxmGrGcuEBnqBXisph7kPU", authDomain: "history-quiz-yongsin.firebaseapp.com", projectId: "history-quiz-yongsin", storageBucket: "history-quiz-yongsin.firebasestorage.app", messagingSenderId: "177587430482", appId: "1:177587430482:web:d79cc145c11e335cc3ab8b", measurementId: "G-LHN97D7R2R" };
        let db; 
        try { 
            if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); } 
            db = firebase.firestore(); 
        } catch(e) { console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨", e); }

        const TEACHER_EMAIL = "westoria28@gmail.com";
        const SESSION_TIMEOUT = 60 * 60 * 1000; // 60ë¶„

        const app = {
            state: { allQuestions:[], logs:[], students: [], questionStats: {}, logPage: 1, logsPerPage: 50 },
            idleTimer: null,

            init: function() {
                if (typeof firebase === 'undefined' || !firebase.auth) { alert("Firebase ë¡œë“œ ì‹¤íŒ¨"); return; }
                
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        if(user.email === TEACHER_EMAIL) {
                            document.getElementById('view-login-screen').style.display = 'none';
                            document.getElementById('view-dashboard').style.display = 'block';
                            this.loadQuestionsFromFirebase();
                            this.setTeacherTab('log');
                            this.startIdleTimer();
                        } else {
                            alert("í—ˆìš©ë˜ì§€ ì•Šì€ ê³„ì •: " + user.email);
                            firebase.auth().signOut();
                        }
                    } else {
                        this.stopIdleTimer();
                        document.getElementById('view-login-screen').style.display = 'flex';
                        document.getElementById('view-dashboard').style.display = 'none';
                    }
                });
            },

            startIdleTimer: function() {
                this.resetIdleTimer();
                ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(evt => {
                    document.addEventListener(evt, this.resetIdleTimerWrapper);
                });
            },

            stopIdleTimer: function() {
                clearTimeout(this.idleTimer);
                ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(evt => {
                    document.removeEventListener(evt, this.resetIdleTimerWrapper);
                });
            },

            resetIdleTimerWrapper: function() {
                app.resetIdleTimer();
            },

            resetIdleTimer: function() {
                clearTimeout(this.idleTimer);
                this.idleTimer = setTimeout(() => {
                    alert("60ë¶„ ë™ì•ˆ í™œë™ì´ ì—†ì–´ ìë™ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.");
                    app.logout();
                }, SESSION_TIMEOUT);
            },

            login: function() {
                firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
                    .then(() => {
                        const provider = new firebase.auth.GoogleAuthProvider();
                        return firebase.auth().signInWithPopup(provider);
                    })
                    .catch((error) => {
                        alert("ë¡œê·¸ì¸ ì—ëŸ¬: " + error.message);
                    });
            },
            logout: function() {
                firebase.auth().signOut().then(() => location.reload());
            },
            showLoading: function(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; },
            
            setTeacherTab: function(tab) {
                // 'student' ì¶”ê°€ë¨
                ['log','bank','add', 'student'].forEach(t => {
                    document.getElementById('tab-'+t).style.display = 'none'; 
                    const btn = document.getElementById('btn-tab-'+t);
                    if(t===tab) btn.className = "px-5 py-2 rounded-full bg-stone-800 text-white text-sm font-bold shadow transition";
                    else btn.className = "px-5 py-2 rounded-full bg-stone-100 text-stone-600 text-sm font-bold shadow transition";
                });
                document.getElementById('tab-'+tab).style.display = 'block'; 
                
                if (tab === 'add') this.updateNextQuestionNumber(); 
                else if (tab === 'bank') this.renderBank();
                else if (tab === 'student') this.loadStudents(); // í•™ìƒ íƒ­ í´ë¦­ ì‹œ ë¡œë“œ
            },
            loadByClass: function(cls) {
                if(!db || !cls) return;
                this.showLoading(true);
                let query = db.collection("quiz_results");
                if (cls === 'all') { query = query.orderBy("timestamp", "desc").limit(50); } 
                else { query = query.where("class", "==", cls).orderBy("timestamp", "desc"); } 

                query.get().then((querySnapshot) => {
                    let logs = []; 
                    querySnapshot.forEach((doc) => { let d = doc.data(); d.docId = doc.id; logs.push(d); });
                    this.state.logs = logs; this.state.logPage = 1; this.renderLogs(); 
                    document.getElementById('log-count').innerText = `(${logs.length}ê±´)`;
                    this.showLoading(false);
                }).catch(e => {
                    this.showLoading(false);
                    if(e.message.includes("index")) alert("âš ï¸ ì¸ë±ìŠ¤ ì„¤ì • í•„ìš”: F12 ì½˜ì†” ë§í¬ í´ë¦­");
                    else alert("ë¡œë“œ ì‹¤íŒ¨: " + e.message);
                });
            },
            searchStudent: function() {
                const name = document.getElementById('search-student-name').value.trim();
                if(!name) { alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"); return; }
                this.showLoading(true);
                db.collection("quiz_results").where("name", "==", name).orderBy("timestamp", "desc").get().then(snapshot => {
                    let logs = [];
                    snapshot.forEach(doc => { let d = doc.data(); d.docId = doc.id; logs.push(d); });
                    if(logs.length === 0) { alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."); this.showLoading(false); return; }
                    
                    let totalScore = logs.reduce((sum, l) => sum + l.score, 0);
                    let avg = Math.round(totalScore / logs.length);
                    let html = `<div class="bg-blue-50 p-4 rounded mb-4 border border-blue-200">
                        <h4 class="font-bold text-lg text-blue-800">${name} í•™ìƒ ê²€ìƒ‰ ê²°ê³¼</h4>
                        <p class="text-sm">ì´ ì‘ì‹œ: <b>${logs.length}íšŒ</b> / í‰ê·  ì ìˆ˜: <b>${avg}ì </b></p>
                    </div><div class="space-y-2">`;
                    
                    logs.forEach(l => {
                        html += `<div class="border p-3 rounded flex justify-between items-center hover:bg-stone-50 cursor-pointer" onclick="app.showStudentDetail('${l.docId}')">
                            <div><span class="font-bold">${l.class}ë°˜ ${l.number}ë²ˆ</span> <span class="text-xs text-gray-500">${l.timeString}</span></div>
                            <div class="font-bold text-amber-600">${l.score}ì </div>
                        </div>`;
                    });
                    html += `</div>`;
                    
                    document.getElementById('stats-content').innerHTML = html;
                    document.getElementById('stats-modal').style.display = 'flex';
                    this.showLoading(false);
                }).catch(e => {
                    this.showLoading(false);
                    if(e.message.includes("index")) alert("âš ï¸ ì¸ë±ìŠ¤ ì„¤ì • í•„ìš”: ì½˜ì†”ì°½ í™•ì¸");
                    else alert("ê²€ìƒ‰ ì‹¤íŒ¨: " + e.message);
                });
            },
            analyzeClassStats: function() {
                if(!this.state.logs || this.state.logs.length === 0) { alert("ë¨¼ì € ë°˜ì„ ì„ íƒí•˜ì—¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”."); return; }
                const studentMap = {};
                this.state.logs.forEach(log => {
                    const key = `${log.class}-${log.number}-${log.name}`;
                    if(!studentMap[key]) studentMap[key] = { name: log.name, cls: log.class, num: log.number, total: 0, count: 0 };
                    studentMap[key].total += log.score;
                    studentMap[key].count++;
                });

                const list = Object.values(studentMap).map(s => ({
                    ...s, avg: Math.round(s.total / s.count)
                })).sort((a, b) => b.avg - a.avg);

                let html = `<div class="mb-2 text-sm text-gray-500">í˜„ì¬ ëª©ë¡ì— ìˆëŠ” í•™ìƒë“¤ì˜ í‰ê·  ì ìˆ˜ì…ë‹ˆë‹¤.</div>
                <table class="w-full text-sm text-left border"><thead class="bg-stone-100"><tr><th class="p-2 border">ìˆœìœ„</th><th class="p-2 border">í•™ìƒ</th><th class="p-2 border">ì‘ì‹œ íšŸìˆ˜</th><th class="p-2 border">í‰ê·  ì ìˆ˜</th></tr></thead><tbody>`;
                
                list.forEach((s, i) => {
                    let rankColor = i < 3 ? 'bg-yellow-50 font-bold' : '';
                    html += `<tr class="${rankColor} border-b"><td class="p-2 border text-center">${i+1}</td><td class="p-2 border">${s.cls}ë°˜ ${s.num}ë²ˆ ${s.name}</td><td class="p-2 border text-center">${s.count}</td><td class="p-2 border text-center text-blue-600 font-bold">${s.avg}ì </td></tr>`;
                });
                html += `</tbody></table>`;

                document.getElementById('stats-content').innerHTML = html;
                document.getElementById('stats-modal').style.display = 'flex';
            },
            renderLogs: function() {
                const sortType = document.getElementById('sort-logs').value;
                let filtered = [...this.state.logs];
                if (sortType === 'number') filtered.sort((a,b) => parseInt(a.number) - parseInt(b.number));
                else if (sortType === 'score_desc') filtered.sort((a,b) => b.score - a.score);
                const start = (this.state.logPage - 1) * this.state.logsPerPage;
                const end = start + this.state.logsPerPage;
                const pageData = filtered.slice(start, end);
                let html = '';
                if(filtered.length===0) html='<tr><td colspan="6" class="p-10 text-center text-stone-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                else pageData.forEach((d) => { html += `<tr class="border-b hover:bg-stone-50 cursor-pointer" onclick="app.showStudentDetail('${d.docId}')"><td class="p-3 text-center"><input type="checkbox" class="log-checkbox" value="${d.docId}" onclick="event.stopPropagation()"></td><td class="p-3 text-stone-500 text-xs">${d.timeString}</td><td class="p-3 font-medium">${d.class}ë°˜ ${d.number}ë²ˆ ${d.name}</td><td class="p-3 font-bold text-amber-600">${d.score}</td><td class="p-3 text-xs">${d.status}</td><td class="p-3 text-center"><button onclick="app.deleteLog('${d.docId}')" class="text-red-500" onclick="event.stopPropagation()"><i class="fas fa-trash-alt"></i></button></td></tr>`; });
                document.getElementById('teacher-log-body').innerHTML = html;
                const totalPages = Math.ceil(filtered.length / this.state.logsPerPage);
                let pHtml = ''; if(totalPages > 1) { for(let i=1; i<=totalPages; i++) pHtml += `<button class="page-btn ${i===this.state.logPage ? 'active' : ''}" onclick="app.changeLogPage(${i})">${i}</button>`; }
                document.getElementById('pagination-controls').innerHTML = pHtml;
            },
            changeLogPage: function(p) { this.state.logPage = p; this.renderLogs(); },
            
            loadQuestionsFromFirebase: function() {
                this.showLoading(true);
                db.collection("quiz_questions").get().then((querySnapshot) => {
                    const loadedData = []; querySnapshot.forEach((doc) => { let data = doc.data(); data.id = parseInt(doc.id); loadedData.push(data); });
                    loadedData.sort((a, b) => a.id - b.id); this.state.allQuestions = loadedData; 
                    if(document.getElementById('tab-bank').style.display !== 'none') this.renderBank();
                    this.showLoading(false);
                }).catch((e) => { 
                    console.error("ë¬¸ì œ ë¡œë“œ ì—ëŸ¬:", e); 
                    this.showLoading(false);
                });
            },
            calculateGlobalStats: function() {
                if(!confirm("âš ï¸ ê²½ê³ : ì´ ì‘ì—…ì€ ëª¨ë“  í•™ìƒ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.\në°ì´í„° ì–‘ì— ë”°ë¼ ì‹œê°„ì´ ê±¸ë¦¬ê±°ë‚˜ ë¹„ìš©ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                
                this.showLoading(true);
                db.collection("quiz_results").get().then(snapshot => {
                    const stats = {}; 
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.details) {
                            data.details.forEach(item => {
                                const qId = String(item.id);
                                if (!stats[qId]) stats[qId] = { total: 0, correct: 0 };
                                stats[qId].total++;
                                if (item.correct) stats[qId].correct++;
                            });
                        }
                    });

                    const batch = db.batch();
                    Object.keys(stats).forEach(qId => {
                        const ref = db.collection("quiz_questions").doc(qId);
                        batch.update(ref, {
                            stat_total: stats[qId].total,
                            stat_correct: stats[qId].correct
                        });
                    });

                    return batch.commit();
                }).then(() => {
                    alert("âœ… ì „ì²´ í†µê³„ê°€ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    this.loadQuestionsFromFirebase(); 
                }).catch(e => {
                    this.showLoading(false);
                    alert("í†µê³„ ê°±ì‹  ì‹¤íŒ¨: " + e.message);
                });
            },
            renderBank: function() {
                let filtered = [...this.state.allQuestions];
                const unitFilter = document.getElementById('bank-filter-unit').value; 
                if (unitFilter !== 'all') filtered = filtered.filter(q => (q.unit || "").indexOf(unitFilter) !== -1);
                
                const sortType = document.getElementById('bank-sort').value;
                if (sortType === 'id') filtered.sort((a, b) => a.id - b.id);
                else if (sortType === 'unit') filtered.sort((a, b) => (a.unit || "").localeCompare(b.unit || ""));
                else if (sortType === 'type') filtered.sort((a, b) => (a.type || "").localeCompare(b.type || ""));
                else if (sortType.startsWith('rate')) {
                    filtered.sort((a, b) => { 
                        const rA = (a.stat_total > 0) ? a.stat_correct / a.stat_total : 0;
                        const rB = (b.stat_total > 0) ? b.stat_correct / b.stat_total : 0;
                        return (sortType === 'rate_asc') ? rA - rB : rB - rA; 
                    }); 
                }

                document.getElementById('total-q-count').innerText = `(${filtered.length}ë¬¸í•­)`;
                document.getElementById('bank-body').innerHTML = filtered.map(q => {
                    const total = q.stat_total || 0;
                    const correct = q.stat_correct || 0;
                    const rate = total > 0 ? Math.round((correct / total) * 100) : 0;
                    let barColor = 'bg-green-500';
                    if(rate < 40) barColor = 'bg-red-500';
                    else if(rate < 70) barColor = 'bg-yellow-500';

                    return `<tr class="border-b hover:bg-stone-50">
                        <td class="p-3 text-center"><input type="checkbox" class="q-checkbox" value="${q.id}"></td>
                        <td class="p-3 text-xs text-center">${q.id}</td>
                        <td class="p-3 text-xs text-gray-500">${q.unit || 'ê¸°íƒ€'}</td>
                        <td class="p-3 text-center text-xs">${q.type}</td>
                        <td class="p-3 text-sm cursor-pointer text-blue-600" onclick="app.editQuestion(${q.id})">${q.question}</td>
                        <td class="p-3 text-center"><button onclick="app.previewQuestion(${q.id})"><i class="fas fa-eye"></i></button></td>
                        <td class="p-3 text-xs font-bold text-center col-answer">${q.answer}</td>
                        <td class="p-3 text-center w-24 text-xs font-bold">
                            ${rate}% <span class="text-[10px] font-normal text-gray-400">(${total}ëª…)</span>
                            <div class="rate-bar-bg"><div class="rate-bar-fill ${barColor}" style="width:${rate}%"></div></div>
                        </td>
                    </tr>`;
                }).join('');
            },
            previewQuestion: function(id) { 
                const q = this.state.allQuestions.find(x => x.id === id); 
                if(!q) return; 
                
                let html = `<div class="mb-4 font-bold text-lg text-stone-800">[Q] ${q.question}</div>`;
                if(q.image) {
                    html += `<div class="text-center mb-4"><img src="${q.image}" class="max-w-full h-auto max-h-60 rounded border mx-auto"></div>`;
                }
                
                html += `<div id="preview-interaction-area" class="space-y-2">`;

                if(q.type === 'choice') {
                    q.options.forEach((opt, idx) => {
                        const safeOpt = opt.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
                        const isCorrect = (opt.trim() === q.answer.trim());
                        html += `<div class="choice-btn p-3 border rounded cursor-pointer hover:bg-stone-50 transition-colors"
                            onclick="app.handlePreviewClick(this, ${isCorrect})">
                            <span class="font-bold mr-2 text-stone-500">${idx+1}.</span> ${opt}
                        </div>`;
                    });
                } else if(q.type === 'ox') {
                    const isO = q.answer === 'O';
                    html += `<div class="flex gap-4 h-24">
                        <button class="flex-1 border-2 rounded-xl text-3xl font-bold text-blue-500 hover:bg-blue-50 hover:border-blue-300 transition" onclick="alert('${isO ? 'â­• ì •ë‹µì…ë‹ˆë‹¤!' : 'âŒ ì˜¤ë‹µì…ë‹ˆë‹¤!'}')">O</button>
                        <button class="flex-1 border-2 rounded-xl text-3xl font-bold text-red-500 hover:bg-red-50 hover:border-red-300 transition" onclick="alert('${!isO ? 'â­• ì •ë‹µì…ë‹ˆë‹¤!' : 'âŒ ì˜¤ë‹µì…ë‹ˆë‹¤!'}')">X</button>
                    </div>`;
                } else if(q.type === 'word') { 
                    html += `<input type="text" class="w-full p-3 border-b-2 border-stone-300 outline-none text-center text-lg" placeholder="ì •ë‹µ ì…ë ¥ í›„ ì—”í„°"
                        onkeydown="if(event.key==='Enter') { alert(this.value.trim() === '${q.answer}' ? 'â­• ì •ë‹µì…ë‹ˆë‹¤!' : 'âŒ ì˜¤ë‹µì…ë‹ˆë‹¤! (ì •ë‹µ: ${q.answer})'); }">`;
                } else if(q.type === 'order') {
                     html += `<div class="p-4 bg-gray-100 rounded text-center text-gray-500">ìˆœì„œ ë§ì¶”ê¸° ìœ í˜•ì€ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ë“œë˜ê·¸/í´ë¦­ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>(ì •ë‹µ: ${q.answer})</div>`;
                }

                html += `</div>`;
                html += `<div class="mt-6 pt-4 border-t text-sm text-gray-500 text-center bg-gray-50 rounded p-2">ğŸ’¡ ì‹¤ì œ í•™ìƒ í™”ë©´ê³¼ ìœ ì‚¬í•˜ê²Œ ë™ì‘í•©ë‹ˆë‹¤. í´ë¦­í•˜ì—¬ ì •ë‹µì„ í™•ì¸í•´ë³´ì„¸ìš”.</div>`;

                document.getElementById('preview-content').innerHTML = html;
                document.getElementById('preview-modal').style.display = 'flex';
            },
            handlePreviewClick: function(el, isCorrect) {
                const parent = el.parentNode;
                Array.from(parent.children).forEach(child => {
                    child.className = "choice-btn p-3 border rounded cursor-pointer hover:bg-stone-50 transition-colors";
                });
                el.className = "choice-btn p-3 border-2 border-amber-500 bg-amber-50 rounded cursor-pointer font-bold text-amber-900";
                setTimeout(() => { alert(isCorrect ? "â­• ì •ë‹µì…ë‹ˆë‹¤!" : "âŒ ì˜¤ë‹µì…ë‹ˆë‹¤!"); }, 100);
            },
            
            deleteSelectedLogs: function() { 
                const checked = Array.from(document.querySelectorAll('.log-checkbox:checked')).map(cb => cb.value); 
                if(checked.length && confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { 
                    this.showLoading(true);
                    const batch = db.batch(); 
                    checked.forEach(id => batch.delete(db.collection("quiz_results").doc(id))); 
                    batch.commit().then(() => { 
                        this.loadByClass(document.getElementById('select-class-trigger').value); 
                    }).catch(e=>{
                        this.showLoading(false);
                        alert("ì‚­ì œ ì‹¤íŒ¨: "+e.message);
                    }); 
                } 
            },
            deleteLog: function(docId) { 
                if(confirm("ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { 
                    this.showLoading(true);
                    db.collection("quiz_results").doc(docId).delete().then(() => {
                        this.loadByClass(document.getElementById('select-class-trigger').value); 
                    }).catch(e=>{
                        this.showLoading(false);
                        alert("ì‚­ì œ ì‹¤íŒ¨: "+e.message);
                    }); 
                } 
            },
            deleteSelectedQuestions: function() { 
                const checked = Array.from(document.querySelectorAll('.q-checkbox:checked')).map(cb => cb.value); 
                if(checked.length && confirm("ì„ íƒí•œ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { 
                    this.showLoading(true);
                    const batch = db.batch(); 
                    checked.forEach(id => batch.delete(db.collection("quiz_questions").doc(id))); 
                    batch.commit().then(() => { 
                        this.loadQuestionsFromFirebase(); 
                    }).catch(e=>{
                        this.showLoading(false);
                        alert("ì‚­ì œ ì‹¤íŒ¨: "+e.message);
                    }); 
                } 
            },
            resetServerQuestions: function() { 
                if(confirm("ì „ì²´ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { 
                    this.showLoading(true);
                    db.collection("quiz_questions").get().then(s => { 
                        const batch = db.batch(); 
                        s.docs.forEach(d => batch.delete(d.ref)); 
                        return batch.commit(); 
                    }).then(() => { 
                        this.state.allQuestions=[]; 
                        this.renderBank(); 
                        this.showLoading(false);
                    }).catch(e=>{
                        this.showLoading(false);
                        alert("ì‹¤íŒ¨: "+e.message);
                    }); 
                } 
            },
            
            showStudentDetail: function(docId) { const log = this.state.logs.find(l => l.docId === docId); if(!log) return; let html = `<div class="font-bold mb-2">${log.class}ë°˜ ${log.number}ë²ˆ ${log.name} (${log.score}ì )</div>`; log.details.forEach((d,i)=>{ const q=this.state.allQuestions.find(x=>x.id===d.id); html+=`<div class="p-2 border mb-2 ${d.correct?'bg-green-50':'bg-red-50'}"><div class="text-sm font-bold">Q${i+1}. ${q?q.question:'ì‚­ì œëœ ë¬¸ì œ'}</div><div class="text-xs">ë‹µ: ${d.u} (ì •ë‹µì—¬ë¶€:${d.correct?'O':'X'})</div></div>`; }); document.getElementById('student-detail-content').innerHTML=html; document.getElementById('student-detail-modal').style.display='flex'; },
            
            editQuestion: function(id) { const q = this.state.allQuestions.find(q => q.id === id); if(!q) return; document.getElementById('edit-q-id').value = q.id; document.getElementById('edit-q-unit').value = q.unit; document.getElementById('edit-q-type').value = q.type; document.getElementById('edit-q-text').value = q.question; document.getElementById('edit-q-answer').value = q.answer; document.getElementById('edit-q-exp').value = q.explanation; document.getElementById('edit-q-options').value = q.options ? q.options.join(', ') : ''; this.toggleOptionInput('edit'); document.getElementById('edit-q-image-base64').value = q.image || ''; const img = document.getElementById('edit-q-image-preview'); if(q.image) { img.src = q.image; img.style.display='block'; } else img.style.display='none'; document.getElementById('edit-modal').style.display='flex'; },
            closeEditModal: function() { document.getElementById('edit-modal').style.display='none'; },
            
            saveEditedQuestion: function() { 
                this.showLoading(true);
                const id = parseInt(document.getElementById('edit-q-id').value); 
                const updatedQ = { id, unit: document.getElementById('edit-q-unit').value, type: document.getElementById('edit-q-type').value, question: document.getElementById('edit-q-text').value, options: document.getElementById('edit-q-options').value.split(',').map(s=>s.trim()), answer: document.getElementById('edit-q-answer').value, explanation: document.getElementById('edit-q-exp').value, image: document.getElementById('edit-q-image-base64').value || null }; 
                db.collection("quiz_questions").doc(String(id)).set(updatedQ).then(() => { 
                    alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); 
                    this.closeEditModal(); 
                    this.loadQuestionsFromFirebase(); 
                }).catch(e=>{
                    this.showLoading(false);
                    alert("ì‹¤íŒ¨: "+e.message);
                }); 
            },
            toggleOptionInput: function(prefix) { const t = document.getElementById(prefix + '-q-type').value; document.getElementById('option-container-' + prefix).style.display = (t==='choice'||t==='order')?'block':'none'; },
            updateNextQuestionNumber: function() { const maxId = this.state.allQuestions.reduce((max, item) => Math.max(max, item.id), 0); document.getElementById('next-q-id-display').innerText = `ë‹¤ìŒ ë²ˆí˜¸: ${maxId + 1}`; },
            handleImageUpload: function(input, prefix) { if(input.files[0]) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById(prefix + '-q-image-base64').value = e.target.result; document.getElementById(prefix + '-q-image-preview').src = e.target.result; document.getElementById(prefix + '-q-image-preview').style.display='block'; }; reader.readAsDataURL(input.files[0]); } },
            
            addCustomQuestion: function() { 
                this.showLoading(true);
                const newQ = { id: this.state.allQuestions.reduce((m,i)=>Math.max(m,i.id),0)+1, unit: document.getElementById('new-q-unit').value, type: document.getElementById('new-q-type').value, question: document.getElementById('new-q-text').value, options: document.getElementById('new-q-options').value.split(',').map(s=>s.trim()), answer: document.getElementById('new-q-answer').value, explanation: document.getElementById('new-q-exp').value, image: document.getElementById('new-q-image-base64').value || null }; 
                db.collection("quiz_questions").doc(String(newQ.id)).set(newQ).then(() => { 
                    alert("ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."); 
                    this.loadQuestionsFromFirebase(); 
                }).catch(e=>{
                    this.showLoading(false);
                    alert("ì‹¤íŒ¨: "+e.message);
                }); 
            },
            
            uploadExcel: function() { 
                const f = document.getElementById('excel-file').files[0]; 
                if(!f) return; 
                this.showLoading(true); // ë¡œë”© ì‹œì‘
                const r = new FileReader(); 
                r.onload = async (e) => { 
                    try {
                        const wb = XLSX.read(e.target.result, {type:'array'}); 
                        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1}); 
                        let batch = db.batch(), cnt=0, id=this.state.allQuestions.reduce((m,i)=>Math.max(m,i.id),0); 
                        for(let i=1; i<rows.length; i++) { 
                            if(!rows[i][2]) continue; 
                            id++; 
                            batch.set(db.collection("quiz_questions").doc(String(id)), { id, unit: rows[i][0]||"ê¸°íƒ€", type: "choice", question: rows[i][2], options: (rows[i][3]||"").split(','), answer: String(rows[i][4]), explanation: rows[i][5]||"", image: null }); 
                            cnt++; 
                            if(cnt%400===0) { await batch.commit(); batch=db.batch(); } 
                        } 
                        await batch.commit(); 
                        alert(cnt+"ê°œ ë¬¸ì œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."); 
                        this.loadQuestionsFromFirebase(); 
                    } catch(e) {
                        this.showLoading(false);
                        alert("ì—…ë¡œë“œ ì‹¤íŒ¨: " + e.message);
                    }
                }; 
                r.readAsArrayBuffer(f); 
            },
            downloadTemplate: function() { XLSX.writeFile(XLSX.utils.book_new(), "ì–‘ì‹.xlsx"); },
            downloadExcel: function() { let csv="\uFEFFì‹œê°„,ë°˜,ë²ˆí˜¸,ì´ë¦„,ì ìˆ˜\n"+this.state.logs.map(l=>`${l.timeString},${l.class},${l.number},${l.name},${l.score}`).join("\n"); const a=document.createElement("a"); a.href="data:text/csv;charset=utf-8,"+encodeURI(csv); a.download="ê²°ê³¼.csv"; a.click(); },

            // --- [í•™ìƒ ê´€ë¦¬ ê¸°ëŠ¥] ---

            // 1. í•™ìƒ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ì‚¬ìš©ì ëª©ë¡ë§Œ ë¶ˆëŸ¬ì˜´ - ê°€ë²¼ì›€)
            loadStudents: function() {
                this.showLoading(true);
                // â˜… users ì»¬ë ‰ì…˜ì—ì„œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. (í€´ì¦ˆ ê¸°ë¡ ì•„ë‹˜)
                db.collection("users").get().then((snapshot) => {
                    const list = [];
                    snapshot.forEach(doc => {
                        let d = doc.data();
                        d.docId = doc.id;
                        d.class = d.class ? parseInt(d.class) : 0;
                        d.number = d.number ? parseInt(d.number) : 0;
                        list.push(d);
                    });
                    
                    list.sort((a, b) => {
                        if (a.class !== b.class) return a.class - b.class;
                        return a.number - b.number;
                    });

                    this.state.students = list;
                    this.renderStudentList(list);
                    this.showLoading(false);
                }).catch(e => {
                    this.showLoading(false);
                    console.error(e);
                    alert("í•™ìƒ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: " + e.message);
                });
            },

            // 2. í™”ë©´ ê·¸ë¦¬ê¸°
            renderStudentList: function(list) {
                document.getElementById('student-total-count').innerText = `(${list.length}ëª…)`;
                
                let html = '';
                if(list.length === 0) {
                    html = '<tr><td colspan="6" class="p-10 text-center text-stone-400">ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                } else {
                    list.forEach(s => {
                        let dateStr = '-';
                        if(s.createdAt && s.createdAt.toDate) dateStr = s.createdAt.toDate().toLocaleDateString();
                        else if(s.timestamp && s.timestamp.toDate) dateStr = s.timestamp.toDate().toLocaleDateString();

                        html += `<tr class="border-b hover:bg-stone-50 student-row">
                            <td class="p-3 text-center font-bold text-lg text-stone-700">${s.class}</td>
                            <td class="p-3 text-center font-bold text-lg text-stone-700">${s.number}</td>
                            <td class="p-3 font-bold">
                                <span class="student-name-link" onclick="app.viewStudentProfile('${s.docId}')">${s.name} <i class="fas fa-external-link-alt text-xs ml-1 opacity-50"></i></span>
                            </td>
                            <td class="p-3 text-xs text-gray-500">${s.email || '-'}</td>
                            <td class="p-3 text-center text-xs text-gray-400">${dateStr}</td>
                            <td class="p-3 text-center">
                                <button onclick="app.openStudentEdit('${s.docId}')" class="bg-blue-100 text-blue-600 hover:bg-blue-200 px-2 py-1 rounded text-xs font-bold mr-1">ìˆ˜ì •</button>
                                <button onclick="app.deleteStudent('${s.docId}')" class="bg-red-100 text-red-600 hover:bg-red-200 px-2 py-1 rounded text-xs font-bold">ì‚­ì œ</button>
                            </td>
                        </tr>`;
                    });
                }
                document.getElementById('student-list-body').innerHTML = html;
            },

            filterStudents: function() {
                const keyword = document.getElementById('search-student-mgmt').value.trim();
                if(!keyword) {
                    this.renderStudentList(this.state.students);
                    return;
                }
                const filtered = this.state.students.filter(s => 
                    s.name.includes(keyword) || String(s.class) === keyword
                );
                this.renderStudentList(filtered);
            },

            openStudentEdit: function(docId) {
                const s = this.state.students.find(x => x.docId === docId);
                if(!s) return;
                document.getElementById('edit-std-docId').value = s.docId;
                document.getElementById('edit-std-email').value = s.email || '';
                document.getElementById('edit-std-class').value = s.class;
                document.getElementById('edit-std-number').value = s.number;
                document.getElementById('edit-std-name').value = s.name;
                document.getElementById('student-edit-modal').style.display = 'flex';
            },

            saveStudentInfo: function() {
                const docId = document.getElementById('edit-std-docId').value;
                const newClass = parseInt(document.getElementById('edit-std-class').value);
                const newNumber = parseInt(document.getElementById('edit-std-number').value);
                const newName = document.getElementById('edit-std-name').value.trim();

                if(!newName || isNaN(newClass) || isNaN(newNumber)) {
                    alert("ë°˜, ë²ˆí˜¸, ì´ë¦„ì„ ëª¨ë‘ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                this.showLoading(true);
                db.collection("users").doc(docId).update({
                    class: newClass,
                    number: newNumber,
                    name: newName,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    alert("í•™ìƒ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    document.getElementById('student-edit-modal').style.display = 'none';
                    this.loadStudents(); 
                }).catch(e => {
                    this.showLoading(false);
                    alert("ìˆ˜ì • ì‹¤íŒ¨: " + e.message);
                });
            },

            deleteStudent: function(docId) {
                if(confirm("ì •ë§ë¡œ ì´ í•™ìƒì˜ ì •ë³´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(í•´ë‹¹ í•™ìƒì€ ë‹¤ì‹œ ê°€ì…í•´ì•¼ í•©ë‹ˆë‹¤.)")) {
                    this.showLoading(true);
                    db.collection("users").doc(docId).delete().then(() => {
                        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        this.loadStudents();
                    }).catch(e => {
                        this.showLoading(false);
                        alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
                    });
                }
            },

            // [NEW] í•™ìƒ ë§ˆì´í˜ì´ì§€ ë³´ê¸° (í´ë¦­ ì‹œì—ë§Œ í˜¸ì¶œë¨)
            viewStudentProfile: function(docId) {
                const s = this.state.students.find(x => x.docId === docId);
                if(!s) return;

                // â˜… ì—¬ê¸°ì„œ ë¡œë”© ì‹œì‘ (ë°ì´í„° ì ˆì•½ í•µì‹¬)
                this.showLoading(true);

                // í•´ë‹¹ í•™ìƒì˜ í€´ì¦ˆ ê¸°ë¡ ì¡°íšŒ (ì´ë¦„+ë°˜+ë²ˆí˜¸ ë§¤ì¹­)
                db.collection("quiz_results")
                    .where("name", "==", s.name)
                    .where("class", "==", String(s.class))
                    .orderBy("timestamp", "desc")
                    .get()
                    .then(snapshot => {
                        const history = [];
                        let totalScore = 0;
                        snapshot.forEach(doc => {
                            let d = doc.data();
                            if(String(d.number) === String(s.number)) {
                                history.push(d);
                                totalScore += d.score;
                            }
                        });

                        const avg = history.length > 0 ? Math.round(totalScore / history.length) : 0;
                        
                        let html = `
                            <div class="flex items-center gap-4 mb-6 bg-stone-100 p-4 rounded-lg">
                                <div class="bg-white p-3 rounded-full shadow-sm">
                                    <i class="fas fa-user text-3xl text-stone-400"></i>
                                </div>
                                <div>
                                    <h4 class="text-xl font-bold text-stone-800">${s.class}ë°˜ ${s.number}ë²ˆ ${s.name}</h4>
                                    <p class="text-xs text-stone-500">${s.email || 'ì´ë©”ì¼ ì—†ìŒ'}</p>
                                </div>
                                <div class="ml-auto text-right">
                                    <div class="text-xs text-stone-500">ì´ í•™ìŠµ íšŸìˆ˜</div>
                                    <div class="text-2xl font-bold text-indigo-600">${history.length}íšŒ</div>
                                </div>
                                <div class="text-right border-l pl-4 border-stone-300">
                                    <div class="text-xs text-stone-500">í‰ê·  ì ìˆ˜</div>
                                    <div class="text-2xl font-bold text-amber-600">${avg}ì </div>
                                </div>
                            </div>

                            <h5 class="font-bold text-sm mb-2 text-stone-600"><i class="fas fa-history mr-1"></i>ìµœê·¼ í•™ìŠµ ê¸°ë¡</h5>
                            <div class="border rounded overflow-hidden">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-stone-50 border-b">
                                        <tr>
                                            <th class="p-2">ì‹œê°„</th>
                                            <th class="p-2 text-center">ì ìˆ˜</th>
                                            <th class="p-2 text-center">ìƒíƒœ</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y">
                        `;

                        if(history.length === 0) {
                            html += `<tr><td colspan="3" class="p-4 text-center text-gray-400">í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                        } else {
                            history.forEach(h => {
                                html += `
                                    <tr>
                                        <td class="p-2 text-xs text-gray-500">${h.timeString}</td>
                                        <td class="p-2 text-center font-bold text-amber-600">${h.score}ì </td>
                                        <td class="p-2 text-center text-xs">${h.status}</td>
                                    </tr>
                                `;
                            });
                        }

                        html += `</tbody></table></div>`;

                        document.getElementById('student-profile-content').innerHTML = html;
                        document.getElementById('student-profile-modal').style.display = 'flex';
                        this.showLoading(false);

                    }).catch(e => {
                        this.showLoading(false);
                        console.error(e);
                        if(e.message.includes("index")) {
                            alert("âš ï¸ íŒŒì´ì–´ë² ì´ìŠ¤ ì¸ë±ìŠ¤ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. (ì½˜ì†” í™•ì¸)");
                        } else {
                            alert("í•™ìŠµ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n" + e.message);
                        }
                    });
            }
        };
        window.onload = function() { app.init(); };
    </script>
</body>
</html>
