<script>
        const firebaseConfig = { apiKey: "AIzaSyAOlPQ5PFmL0zxmGrGcuEBnqBXisph7kPU", authDomain: "history-quiz-yongsin.firebaseapp.com", projectId: "history-quiz-yongsin", storageBucket: "history-quiz-yongsin.firebasestorage.app", messagingSenderId: "177587430482", appId: "1:177587430482:web:d79cc145c11e335cc3ab8b", measurementId: "G-LHN97D7R2R" };
        let db; try { if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); } db = firebase.firestore(); } catch(e) { alert("Firebase 오류"); }

        // [중요] 여기에 선생님의 '구글 이메일 주소'를 정확히 입력하세요.
        // 이 이메일과 일치하는 구글 계정만 접속이 허용됩니다.
        const TEACHER_EMAIL = "선생님구글이메일@gmail.com";

        const app = {
            state: { allQuestions:[], logs:[], questionStats: {}, logPage: 1, logsPerPage: 50 },
            
            init: function() {
                // 로그인 상태 감지
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        // 로그인 된 상태라면 이메일 확인
                        if(user.email === westoria28@gmail.com) {
                            console.log("관리자 인증 성공");
                            this.loadQuestionsFromFirebase();
                            this.loadServerLogs();
                            this.setTeacherTab('log');
                        } else {
                            // 구글 로그인은 됐는데, 선생님 이메일이 아닌 경우
                            alert("등록된 교사 계정이 아닙니다.\n(" + user.email + ")");
                            firebase.auth().signOut();
                        }
                    } else {
                        // 로그인이 안 된 상태면 로그인 시도
                        this.login();
                    }
                });
            },

            login: function() {
                // 구글 로그인 팝업 띄우기
                const provider = new firebase.auth.GoogleAuthProvider();
                
                // 팝업이 차단되는 것을 방지하기 위해 버튼 클릭 유도 없이 바로 실행하지만, 
                // 브라우저에 따라 팝업 차단이 될 수 있으므로 안내 메시지 추가 가능
                firebase.auth().signInWithPopup(provider)
                    .then((result) => {
                        // 로그인 성공 시 onAuthStateChanged가 자동으로 실행됨
                    })
                    .catch((error) => {
                        // 팝업을 닫거나 에러가 난 경우
                        console.error(error);
                        document.body.innerHTML = `
                            <div class="flex items-center justify-center h-screen flex-col">
                                <h1 class="text-2xl font-bold mb-4">교사 인증이 필요합니다</h1>
                                <button onclick="app.login()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold shadow-lg hover:bg-blue-700">
                                    <i class="fab fa-google mr-2"></i> 구글 계정으로 로그인
                                </button>
                                <p class="text-gray-500 mt-4 text-sm">팝업이 차단되었다면 허용해주세요.</p>
                            </div>
                        `;
                    });
            },

            // --- 아래부터는 기존 기능과 동일합니다 ---

            showLoading: function(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; },
            setTeacherTab: function(tab) {
                ['log','bank','add'].forEach(t => {
                    document.getElementById('tab-'+t).classList.add('hidden');
                    const btn = document.getElementById('btn-tab-'+t);
                    if(t===tab) btn.className = "px-5 py-2 rounded-full bg-stone-800 text-white text-sm font-bold shadow transition";
                    else btn.className = "px-5 py-2 rounded-full bg-stone-100 text-stone-600 text-sm font-bold shadow transition";
                });
                document.getElementById('tab-'+tab).classList.remove('hidden');
                if(tab === 'log') this.loadServerLogs(); else if (tab === 'add') this.updateNextQuestionNumber(); else this.renderBank();
            },
            loadServerLogs: function() {
                if(!db) return;
                document.getElementById('teacher-log-body').innerHTML = '<tr><td colspan="6" class="p-4 text-center">로딩 중...</td></tr>';
                db.collection("quiz_results").orderBy("timestamp", "desc").get().then((querySnapshot) => {
                    let logs = []; querySnapshot.forEach((doc) => { let d = doc.data(); d.docId = doc.id; logs.push(d); });
                    this.state.logs = logs; this.state.logPage = 1; this.renderLogs(); document.getElementById('log-count').innerText = `(${logs.length}건)`;
                }).catch(e => {
                    console.error(e);
                    // 보안 규칙 때문에 권한 없으면 여기서 에러가 남
                    alert("데이터를 불러올 권한이 없습니다. (이메일 불일치)");
                });
            },
            renderLogs: function() {
                const clsFilter = document.getElementById('filter-class').value;
                const sortType = document.getElementById('sort-logs').value;
                let filtered = [...this.state.logs];
                if (clsFilter !== 'all') filtered = filtered.filter(l => l.class === clsFilter);
                if (sortType === 'number') filtered.sort((a,b) => parseInt(a.number) - parseInt(b.number));
                else if (sortType === 'score_desc') filtered.sort((a,b) => b.score - a.score);
                const start = (this.state.logPage - 1) * this.state.logsPerPage;
                const end = start + this.state.logsPerPage;
                const pageData = filtered.slice(start, end);
                let html = '';
                if(filtered.length===0) html='<tr><td colspan="6" class="p-4 text-center">기록 없음</td></tr>';
                else pageData.forEach((d) => { html += `<tr class="border-b hover:bg-stone-50 cursor-pointer" onclick="app.showStudentDetail('${d.docId}')"><td class="p-3 text-center"><input type="checkbox" class="log-checkbox" value="${d.docId}" onclick="event.stopPropagation()"></td><td class="p-3 text-stone-500 text-xs">${d.timeString}</td><td class="p-3 font-medium">${d.class}반 ${d.number}번 ${d.name}</td><td class="p-3 font-bold text-amber-600">${d.score}</td><td class="p-3 text-xs">${d.status}</td><td class="p-3 text-center"><button onclick="app.deleteLog('${d.docId}')" class="text-red-500" onclick="event.stopPropagation()"><i class="fas fa-trash-alt"></i></button></td></tr>`; });
                document.getElementById('teacher-log-body').innerHTML = html;
                const totalPages = Math.ceil(filtered.length / this.state.logsPerPage);
                let pHtml = ''; if(totalPages > 1) { for(let i=1; i<=totalPages; i++) pHtml += `<button class="page-btn ${i===this.state.logPage ? 'active' : ''}" onclick="app.changeLogPage(${i})">${i}</button>`; }
                document.getElementById('pagination-controls').innerHTML = pHtml;
            },
            changeLogPage: function(p) { this.state.logPage = p; this.renderLogs(); },
            loadQuestionsFromFirebase: function() {
                this.showLoading(true);
                db.collection("quiz_questions").get().then((querySnapshot) => {
                    const loadedData = []; querySnapshot.forEach((doc) => { let data = doc.data(); data.id = parseInt(doc.id); loadedData.push(data); });
                    loadedData.sort((a, b) => a.id - b.id); this.state.allQuestions = loadedData; this.showLoading(false); if(!document.getElementById('tab-bank').classList.contains('hidden')) this.renderBank();
                }).catch(() => { this.showLoading(false); });
            },
            calculateStats: function() {
                const stats = {};
                this.state.logs.forEach(log => { if (log.details) log.details.forEach(item => { if (!stats[item.id]) stats[item.id] = { total: 0, correct: 0 }; stats[item.id].total++; if (item.correct) stats[item.id].correct++; }); });
                this.state.questionStats = stats;
            },
            renderBank: function() {
                this.calculateStats();
                let filtered = [...this.state.allQuestions];
                const unitFilter = document.getElementById('bank-filter-unit').value; if (unitFilter !== 'all') filtered = filtered.filter(q => (q.unit || "").indexOf(unitFilter) !== -1);
                const sortType = document.getElementById('bank-sort').value;
                if (sortType === 'id') filtered.sort((a, b) => a.id - b.id);
                else if (sortType.startsWith('rate')) filtered.sort((a, b) => { const sA = this.state.questionStats[a.id]||{t:0,c:0}, sB = this.state.questionStats[b.id]||{t:0,c:0}; return (sA.total>0?sA.correct/sA.total:0) - (sB.total>0?sB.correct/sB.total:0); });
                document.getElementById('total-q-count').innerText = `(${filtered.length}문항)`;
                document.getElementById('bank-body').innerHTML = filtered.map(q => {
                    const stat = this.state.questionStats[q.id] || { total: 0, correct: 0 };
                    const rate = stat.total > 0 ? Math.round((stat.correct / stat.total) * 100) : 0;
                    return `<tr class="border-b hover:bg-stone-50"><td class="p-3 text-center"><input type="checkbox" class="q-checkbox" value="${q.id}"></td><td class="p-3 text-xs text-center">${q.id}</td><td class="p-3 text-xs text-gray-500">${q.unit || '기타'}</td><td class="p-3 text-center text-xs">${q.type}</td><td class="p-3 text-sm cursor-pointer text-blue-600" onclick="app.editQuestion(${q.id})">${q.question}</td><td class="p-3 text-center"><button onclick="app.previewQuestion(${q.id})"><i class="fas fa-eye"></i></button></td><td class="p-3 text-xs font-bold text-center col-answer">${q.answer}</td><td class="p-3 text-center w-24 text-xs font-bold">${rate}%<div class="rate-bar-bg"><div class="rate-bar-fill ${rate<60?'bg-red-500':'bg-green-500'}" style="width:${rate}%"></div></div></td></tr>`;
                }).join('');
            },
            deleteSelectedLogs: function() { const checked = Array.from(document.querySelectorAll('.log-checkbox:checked')).map(cb => cb.value); if(checked.length && confirm("삭제?")) { this.showLoading(true); const batch = db.batch(); checked.forEach(id => batch.delete(db.collection("quiz_results").doc(id))); batch.commit().then(() => { this.showLoading(false); this.loadServerLogs(); }).catch(e=>alert("삭제 권한이 없습니다.")); } },
            deleteLog: function(docId) { if(confirm("삭제?")) { db.collection("quiz_results").doc(docId).delete().then(() => this.loadServerLogs()).catch(e=>alert("삭제 권한이 없습니다.")); } },
            deleteSelectedQuestions: function() { const checked = Array.from(document.querySelectorAll('.q-checkbox:checked')).map(cb => cb.value); if(checked.length && confirm("삭제?")) { this.showLoading(true); const batch = db.batch(); checked.forEach(id => batch.delete(db.collection("quiz_questions").doc(id))); batch.commit().then(() => { this.showLoading(false); this.loadQuestionsFromFirebase(); }).catch(e=>alert("삭제 권한이 없습니다.")); } },
            resetServerQuestions: function() { if(confirm("전체 초기화(복구불가)?")) { this.showLoading(true); db.collection("quiz_questions").get().then(s => { const batch = db.batch(); s.docs.forEach(d => batch.delete(d.ref)); return batch.commit(); }).then(() => { this.showLoading(false); this.state.allQuestions=[]; this.renderBank(); }).catch(e=>alert("삭제 권한이 없습니다.")); } },
            showStudentDetail: function(docId) { const log = this.state.logs.find(l => l.docId === docId); if(!log) return; let html = `<div class="font-bold mb-2">${log.class}반 ${log.number}번 ${log.name} (${log.score}점)</div>`; log.details.forEach((d,i)=>{ const q=this.state.allQuestions.find(x=>x.id===d.id); html+=`<div class="p-2 border mb-2 ${d.correct?'bg-green-50':'bg-red-50'}"><div class="text-sm font-bold">Q${i+1}. ${q?q.question:'삭제된 문제'}</div><div class="text-xs">답: ${d.u} (정답여부:${d.correct?'O':'X'})</div></div>`; }); document.getElementById('student-detail-content').innerHTML=html; document.getElementById('student-detail-modal').classList.remove('hidden'); },
            previewQuestion: function(id) { const q = this.state.allQuestions.find(x => x.id === id); if(!q) return; let html = `<div class="mb-4 font-bold text-lg">${q.question}</div>`; if(q.image) html+=`<img src="${q.image}" class="q-image-thumb mb-4">`; if(q.type==='choice') q.options.forEach(o=>html+=`<div class="choice-btn p-2 border rounded mb-1">${o}</div>`); else if(q.type==='ox') html+=`<div class="flex gap-2"><button class="ox-btn">O</button><button class="ox-btn">X</button></div>`; else html+=`<input class="border p-2 w-full" placeholder="정답 입력">`; document.getElementById('preview-content').innerHTML=html; document.getElementById('preview-modal').classList.remove('hidden'); },
            editQuestion: function(id) { const q = this.state.allQuestions.find(q => q.id === id); if(!q) return; document.getElementById('edit-q-id').value = q.id; document.getElementById('edit-q-unit').value = q.unit; document.getElementById('edit-q-type').value = q.type; document.getElementById('edit-q-text').value = q.question; document.getElementById('edit-q-answer').value = q.answer; document.getElementById('edit-q-exp').value = q.explanation; document.getElementById('edit-q-options').value = q.options ? q.options.join(', ') : ''; this.toggleOptionInput('edit'); document.getElementById('edit-q-image-base64').value = q.image || ''; const img = document.getElementById('edit-q-image-preview'); if(q.image) { img.src = q.image; img.classList.remove('hidden'); } else img.classList.add('hidden'); document.getElementById('edit-modal').classList.remove('hidden'); },
            closeEditModal: function() { document.getElementById('edit-modal').classList.add('hidden'); },
            saveEditedQuestion: function() { const id = parseInt(document.getElementById('edit-q-id').value); const updatedQ = { id, unit: document.getElementById('edit-q-unit').value, type: document.getElementById('edit-q-type').value, question: document.getElementById('edit-q-text').value, options: document.getElementById('edit-q-options').value.split(',').map(s=>s.trim()), answer: document.getElementById('edit-q-answer').value, explanation: document.getElementById('edit-q-exp').value, image: document.getElementById('edit-q-image-base64').value || null }; db.collection("quiz_questions").doc(String(id)).set(updatedQ).then(() => { alert("수정됨"); this.closeEditModal(); this.loadQuestionsFromFirebase(); }).catch(e=>alert("수정 권한이 없습니다.")); },
            toggleOptionInput: function(prefix) { const t = document.getElementById(prefix + '-q-type').value; document.getElementById('option-container-' + prefix).classList.toggle('hidden', !(t==='choice'||t==='order')); },
            updateNextQuestionNumber: function() { const maxId = this.state.allQuestions.reduce((max, item) => Math.max(max, item.id), 0); document.getElementById('next-q-id-display').innerText = `다음 번호: ${maxId + 1}`; },
            handleImageUpload: function(input, prefix) { if(input.files[0]) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById(prefix + '-q-image-base64').value = e.target.result; document.getElementById(prefix + '-q-image-preview').src = e.target.result; document.getElementById(prefix + '-q-image-preview').classList.remove('hidden'); }; reader.readAsDataURL(input.files[0]); } },
            addCustomQuestion: function() { const newQ = { id: this.state.allQuestions.reduce((m,i)=>Math.max(m,i.id),0)+1, unit: document.getElementById('new-q-unit').value, type: document.getElementById('new-q-type').value, question: document.getElementById('new-q-text').value, options: document.getElementById('new-q-options').value.split(',').map(s=>s.trim()), answer: document.getElementById('new-q-answer').value, explanation: document.getElementById('new-q-exp').value, image: document.getElementById('new-q-image-base64').value || null }; db.collection("quiz_questions").doc(String(newQ.id)).set(newQ).then(() => { alert("추가됨"); this.loadQuestionsFromFirebase(); }).catch(e=>alert("권한이 없습니다.")); },
            uploadExcel: function() { const f = document.getElementById('excel-file').files[0]; if(!f) return; const r = new FileReader(); r.onload = async (e) => { const wb = XLSX.read(e.target.result, {type:'array'}); const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1}); let batch = db.batch(), cnt=0, id=this.state.allQuestions.reduce((m,i)=>Math.max(m,i.id),0); for(let i=1; i<rows.length; i++) { if(!rows[i][2]) continue; id++; batch.set(db.collection("quiz_questions").doc(String(id)), { id, unit: rows[i][0]||"기타", type: "choice", question: rows[i][2], options: (rows[i][3]||"").split(','), answer: String(rows[i][4]), explanation: rows[i][5]||"", image: null }); cnt++; if(cnt%400===0) { await batch.commit(); batch=db.batch(); } } await batch.commit(); alert(cnt+"개 추가됨"); this.loadQuestionsFromFirebase(); }; r.readAsArrayBuffer(f); },
            downloadTemplate: function() { XLSX.writeFile(XLSX.utils.book_new(), "양식.xlsx"); },
            downloadExcel: function() { let csv="\uFEFF시간,반,번호,이름,점수\n"+this.state.logs.map(l=>`${l.timeString},${l.class},${l.number},${l.name},${l.score}`).join("\n"); const a=document.createElement("a"); a.href="data:text/csv;charset=utf-8,"+encodeURI(csv); a.download="결과.csv"; a.click(); }
        };
        window.onload = function() { app.init(); };
    </script>
