<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì‚¬ ëŒ€ì‹œë³´ë“œ - ë°©ì¬ì„</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f5f5f4; margin: 0; padding: 0; }
        .admin-table th, .admin-table td { border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        .admin-table th:not(:last-child), .admin-table td:not(:last-child) { border-right: 2px solid #d6d3d1; }
        .col-answer { background-color: #fffbeb; color: #b45309; font-weight: bold; }
        .rate-bar-bg { background-color: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden; width: 100%; margin-top: 4px; }
        .rate-bar-fill { height: 100%; transition: width 0.5s ease; }
        .page-btn { padding: 6px 12px; margin: 0 2px; border: 1px solid #d1d5db; border-radius: 4px; background: white; cursor: pointer; font-size: 0.9rem; }
        .page-btn.active { background-color: #4b5563; color: white; border-color: #4b5563; font-weight: bold; }
        .choice-btn { width: 100%; text-align: left; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; background-color: white; margin-bottom: 0.5rem; }
        .choice-btn.selected { border: 2px solid #d97706; background-color: #fffbeb; color: #92400e; font-weight: bold; }
        .ox-btn { height: 60px; font-size: 1.5rem; font-weight: bold; width: 100%; border: 1px solid #ccc; border-radius: 8px; }
        #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        .q-image-thumb { max-width: 100%; max-height: 200px; border-radius: 4px; border: 1px solid #ddd; cursor: zoom-in; }
        #image-zoom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; cursor: zoom-out; }
        #image-zoom-content { max-width: 95%; max-height: 95%; border-radius: 4px; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body class="text-stone-800 min-h-screen">

    <div id="loading-overlay"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-amber-600 border-solid mb-4"></div><p class="text-xl font-bold">ì²˜ë¦¬ ì¤‘...</p></div>
    <div id="image-zoom-modal" onclick="document.getElementById('image-zoom-modal').style.display='none'"><img id="image-zoom-content" src=""></div>

    <div id="view-login-screen" style="display: flex;" class="items-center justify-center min-h-screen flex-col bg-stone-100 p-4">
        <div class="bg-white p-8 rounded-xl shadow-xl max-w-sm w-full text-center border-t-4 border-amber-600">
            <h1 class="text-2xl font-bold mb-2">êµì‚¬ ì¸ì¦</h1>
            <p class="text-stone-500 mb-8 text-sm">êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
            <button onclick="app.login()" class="w-full bg-white border border-gray-300 text-gray-700 font-bold py-3 px-4 rounded shadow hover:bg-gray-50 flex items-center justify-center gap-2 transition cursor-pointer">
                <i class="fab fa-google text-red-500"></i> êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
            </button>
            <p class="text-xs text-gray-400 mt-4">ìš©ì‹ ì¤‘í•™êµ ì—­ì‚¬ê³¼ ë°©ì¬ì„</p>
        </div>
    </div>

    <div id="view-dashboard" style="display: none;" class="p-6 max-w-7xl mx-auto">
        <div class="bg-white p-6 rounded shadow-xl border border-stone-300">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div class="flex items-center gap-4">
                    <div>
                        <h2 class="font-bold text-2xl text-stone-800"><i class="fas fa-chalkboard-teacher text-amber-600 mr-2"></i>êµì‚¬ ëŒ€ì‹œë³´ë“œ</h2>
                        <p class="text-xs text-stone-500 mt-1">Firebase ì—°ë™ë¨</p>
                    </div>
                    <div class="flex bg-stone-100 p-1 rounded border border-stone-300 ml-4">
                        <input type="text" id="search-student-name" placeholder="í•™ìƒ ì´ë¦„ ê²€ìƒ‰" class="bg-transparent px-2 py-1 text-sm outline-none" onkeypress="if(event.key==='Enter') app.searchStudent()">
                        <button onclick="app.searchStudent()" class="bg-stone-800 text-white px-3 py-1 rounded text-xs font-bold hover:bg-stone-700">ê²€ìƒ‰</button>
                    </div>
                </div>
                <button onclick="app.logout()" class="bg-stone-200 hover:bg-stone-300 text-stone-700 px-4 py-2 rounded text-sm font-bold">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <div class="flex flex-wrap gap-2 mb-6">
                <button onclick="app.setTeacherTab('log')" id="btn-tab-log" class="px-5 py-2 rounded-full bg-stone-800 text-white text-sm font-bold shadow transition">ì‹¤ì‹œê°„ ê¸°ë¡</button>
                <button onclick="app.setTeacherTab('bank')" id="btn-tab-bank" class="px-5 py-2 rounded-full bg-stone-100 text-stone-600 text-sm font-bold shadow transition">ë¬¸ì œ ì€í–‰</button>
                <button onclick="app.setTeacherTab('add')" id="btn-tab-add" class="px-5 py-2 rounded-full bg-stone-100 text-stone-600 text-sm font-bold shadow transition">ë¬¸ì œ ì¶”ê°€</button>
            </div>

            <div id="tab-log">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <h3 class="font-bold text-lg flex items-center">ì œì¶œ í˜„í™© <span id="log-count" class="text-sm font-normal text-stone-500 ml-2"></span></h3>
                    <div class="flex gap-2 items-center flex-wrap">
                        <span class="text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded">â–¼ ë°˜ ì„ íƒ</span>
                        <select id="select-class-trigger" onchange="app.loadByClass(this.value)" class="p-2 border-2 border-amber-500 rounded text-sm font-bold bg-amber-50 cursor-pointer">
                            <option value="">ì„ íƒ ëŒ€ê¸°</option>
                            <option value="1">1ë°˜</option><option value="2">2ë°˜</option><option value="3">3ë°˜</option><option value="4">4ë°˜</option><option value="5">5ë°˜</option>
                            <option value="6">6ë°˜</option><option value="7">7ë°˜</option><option value="8">8ë°˜</option><option value="9">9ë°˜</option><option value="10">10ë°˜</option>
                            <option value="all">ì „ì²´ (ìµœê·¼ 50ê°œ)</option>
                        </select>
                        <button onclick="app.analyzeClassStats()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded text-sm font-bold shadow"><i class="fas fa-chart-bar mr-1"></i> í†µê³„ ë¶„ì„</button>
                        <select id="sort-logs" onchange="app.renderLogs()" class="p-2 border rounded text-sm"><option value="time">ìµœì‹ ìˆœ</option><option value="number">ë²ˆí˜¸ìˆœ</option><option value="score_desc">ì ìˆ˜ ë†’ì€ìˆœ</option></select>
                        <button onclick="app.deleteSelectedLogs()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm font-bold"><i class="fas fa-trash"></i></button>
                        <button onclick="app.downloadExcel()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm font-bold"><i class="fas fa-file-excel"></i> ì—‘ì…€</button>
                    </div>
                </div>
                <div class="overflow-auto max-h-[600px] border rounded bg-stone-50">
                    <table class="w-full text-sm text-left admin-table"><thead class="bg-stone-200 text-stone-700 sticky top-0 font-bold"><tr><th class="p-3 w-10 text-center"><input type="checkbox" onchange="document.querySelectorAll('.log-checkbox').forEach(cb=>cb.checked=this.checked)"></th><th class="p-3">ì‹œê°„</th><th class="p-3">ì •ë³´</th><th class="p-3">ì ìˆ˜</th><th class="p-3">ìƒíƒœ</th><th class="p-3">ì‚­ì œ</th></tr></thead><tbody id="teacher-log-body" class="bg-white"><tr><td colspan="6" class="p-10 text-center text-stone-500 font-bold">ğŸ‘† ìœ„ì—ì„œ ë°˜ì„ ì„ íƒí•˜ë©´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.</td></tr></tbody></table>
                </div>
                <div id="pagination-controls" class="flex justify-center gap-2 mt-4"></div>
            </div>

            <div id="tab-bank" style="display:none;">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 bg-stone-50 p-3 rounded border border-stone-200 gap-3">
                    <h3 class="font-bold text-lg">ì „ì²´ ë¬¸ì œ <span id="total-q-count" class="text-sm text-stone-500"></span></h3>
                    <div class="flex gap-2 flex-wrap">
                        <select id="bank-sort" onchange="app.renderBank()" class="p-2 border rounded text-xs"><option value="id">ë²ˆí˜¸ìˆœ</option><option value="unit">ë‹¨ì›ìˆœ</option><option value="type">ìœ í˜•ìˆœ</option><option value="rate_asc">ì·¨ì•½ ìœ í˜•ìˆœ</option></select>
                        <select id="bank-filter-unit" onchange="app.renderBank()" class="p-2 border rounded text-xs w-32"><option value="all">ëª¨ë“  ë‹¨ì›</option><option value="I.">I. ê³ ëŒ€</option><option value="II.">II. ì¢…êµ/ë¬¸í™”</option><option value="III.">III. ì§€ì—­êµë¥˜</option><option value="IV.">IV. ì œêµ­ì£¼ì˜</option><option value="V.">V. ì„¸ê³„ëŒ€ì „</option></select>
                        <button onclick="app.deleteSelectedQuestions()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-xs font-bold"><i class="fas fa-trash"></i> ì‚­ì œ</button>
                        <button onclick="app.resetServerQuestions()" class="bg-red-100 text-red-600 border border-red-200 px-3 py-2 rounded text-xs font-bold hover:bg-red-200">ì´ˆê¸°í™”</button>
                    </div>
                </div>
                <div class="overflow-auto max-h-[500px] border rounded bg-stone-50">
                    <table class="w-full text-sm text-left admin-table"><thead class="bg-stone-200 text-stone-700 sticky top-0 font-bold"><tr><th class="p-3 w-10 text-center"><input type="checkbox" onchange="document.querySelectorAll('.q-checkbox').forEach(cb=>cb.checked=this.checked)"></th><th class="p-3 w-16 text-center">ID</th><th class="p-3 w-32">ë‹¨ì›</th><th class="p-3 w-20 text-center">ìœ í˜•</th><th class="p-3">ë¬¸ì œ</th><th class="p-3 w-20 text-center">ë³´ê¸°</th><th class="p-3 w-32 col-answer text-center">ì •ë‹µ</th><th class="p-3 w-24 text-center">ì •ë‹µë¥ </th></tr></thead><tbody id="bank-body" class="bg-white"></tbody></table>
                </div>
            </div>

            <div id="tab-add" style="display:none;">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-stone-50 p-6 rounded border border-stone-200">
                        <div class="flex justify-between items-center mb-4 border-b pb-2"><h3 class="font-bold text-xl">ë¬¸ì œ ë§Œë“¤ê¸°</h3><span id="next-q-id-display" class="bg-amber-100 text-amber-800 text-xs font-bold px-3 py-1 rounded-full border border-amber-200"></span></div>
                        <div class="space-y-4">
                            <div><label class="block text-sm font-bold mb-1">ë‹¨ì›</label><select id="new-q-unit" class="w-full p-2 border rounded"><option value="I. ë¬¸ëª…ì˜ ë°œìƒê³¼ ê³ ëŒ€ ì„¸ê³„ì˜ í˜•ì„±">I. ê³ ëŒ€ ì„¸ê³„</option><option value="II. ì„¸ê³„ ì¢…êµì˜ í™•ì‚°ê³¼ ì§€ì—­ ë¬¸í™”ì˜ í˜•ì„±">II. ì„¸ê³„ ì¢…êµ</option><option value="III. ì§€ì—­ ì„¸ê³„ì˜ êµë¥˜ì™€ ë³€í™”">III. ì§€ì—­ ì„¸ê³„</option><option value="IV. ì œêµ­ì£¼ì˜ ì¹¨ëµê³¼ êµ­ë¯¼ êµ­ê°€ ê±´ì„¤ ìš´ë™">IV. ì œêµ­ì£¼ì˜</option><option value="V. ì„¸ê³„ ëŒ€ì „ê³¼ ì‚¬íšŒ ë³€ë™">V. ì„¸ê³„ ëŒ€ì „</option></select></div>
                            <div><label class="block text-sm font-bold mb-1">ìœ í˜•</label><select id="new-q-type" class="w-full p-2 border rounded" onchange="app.toggleOptionInput('new')"><option value="choice">ê°ê´€ì‹</option><option value="word">ë‹¨ë‹µí˜•</option><option value="order">ìˆœì„œ ë§ì¶”ê¸°</option><option value="ox">O/X í€´ì¦ˆ</option></select></div>
                            <div><label class="block text-sm font-bold mb-1">ì´ë¯¸ì§€</label><input type="file" id="new-q-image" accept="image/*" class="w-full text-xs" onchange="app.handleImageUpload(this, 'new')"><img id="new-q-image-preview" style="display:none;" class="mt-2 h-20 rounded border"><input type="hidden" id="new-q-image-base64"></div>
                            <div><label class="block text-sm font-bold mb-1">ë¬¸ì œ</label><textarea id="new-q-text" class="w-full p-2 border rounded h-20"></textarea></div>
                            <div id="option-container-new"><label class="block text-sm font-bold mb-1">ë³´ê¸°</label><input type="text" id="new-q-options" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm font-bold mb-1">ì •ë‹µ</label><input type="text" id="new-q-answer" class="w-full p-2 border rounded"></div>
                            <div><label class="block text-sm font-bold mb-1">í•´ì„¤</label><input type="text" id="new-q-exp" class="w-full p-2 border rounded"></div>
                            <button onclick="app.addCustomQuestion()" class="w-full bg-amber-600 text-white font-bold py-3 rounded hover:bg-amber-700">ì¶”ê°€í•˜ê¸°</button>
                        </div>
                    </div>
                    <div class="bg-green-50 p-6 rounded border border-green-200 h-fit">
                        <h3 class="font-bold text-xl mb-4 border-b pb-2 text-green-800">ì—‘ì…€ ì—…ë¡œë“œ</h3>
                        <input type="file" id="excel-file" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500 mb-4"/>
                        <button onclick="app.uploadExcel()" class="w-full bg-green-600 text-white font-bold py-3 rounded hover:bg-green-700 mb-4">ì—‘ì…€ ì—…ë¡œë“œ ì‹œì‘</button>
                        <div class="text-center"><button onclick="app.downloadTemplate()" class="text-xs text-gray-500 underline">ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="student-detail-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center"><div class="modal-overlay absolute inset-0" onclick="document.getElementById('student-detail-modal').style.display='none'"></div><div class="bg-white p-8 rounded-lg shadow-2xl z-10 w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto"><h3 class="font-bold text-xl mb-4 border-b pb-2">ìƒì„¸ ì •ë³´</h3><div id="student-detail-content"></div><div class="mt-4 text-center"><button onclick="document.getElementById('student-detail-modal').style.display='none'" class="bg-gray-200 px-4 py-2 rounded">ë‹«ê¸°</button></div></div></div>
    <div id="preview-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center"><div class="modal-overlay absolute inset-0" onclick="document.getElementById('preview-modal').style.display='none'"></div><div class="bg-white p-8 rounded-lg shadow-2xl z-10 w-full max-w-lg mx-4 max-h-[80vh] overflow-y-auto"><div id="preview-content"></div><div class="mt-6 text-center"><button onclick="document.getElementById('preview-modal').style.display='none'" class="bg-gray-200 px-4 py-2 rounded">ë‹«ê¸°</button></div></div></div>
    <div id="edit-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center"><div class="modal-overlay absolute inset-0" onclick="app.closeEditModal()"></div><div class="bg-white p-6 rounded-lg shadow-xl z-10 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto"><h3 class="font-bold text-xl mb-4 border-b pb-2">ë¬¸ì œ ìˆ˜ì •</h3><input type="hidden" id="edit-q-id"><div class="space-y-4"><div><label class="block text-sm font-bold mb-1">ë‹¨ì›</label><select id="edit-q-unit" class="w-full p-2 border rounded"><option value="I. ë¬¸ëª…ì˜ ë°œìƒê³¼ ê³ ëŒ€ ì„¸ê³„ì˜ í˜•ì„±">I. ê³ ëŒ€ ì„¸ê³„</option><option value="II. ì„¸ê³„ ì¢…êµì˜ í™•ì‚°ê³¼ ì§€ì—­ ë¬¸í™”ì˜ í˜•ì„±">II. ì„¸ê³„ ì¢…êµ</option><option value="III. ì§€ì—­ ì„¸ê³„ì˜ êµë¥˜ì™€ ë³€í™”">III. ì§€ì—­ ì„¸ê³„</option><option value="IV. ì œêµ­ì£¼ì˜ ì¹¨ëµê³¼ êµ­ë¯¼ êµ­ê°€ ê±´ì„¤ ìš´ë™">IV. ì œêµ­ì£¼ì˜</option><option value="V. ì„¸ê³„ ëŒ€ì „ê³¼ ì‚¬íšŒ ë³€ë™">V. ì„¸ê³„ ëŒ€ì „</option></select></div><div><label class="block text-sm font-bold mb-1">ìœ í˜•</label><select id="edit-q-type" class="w-full p-2 border rounded" onchange="app.toggleOptionInput('edit')"><option value="choice">ê°ê´€ì‹</option><option value="word">ë‹¨ë‹µí˜•</option><option value="order">ìˆœì„œ ë§ì¶”ê¸°</option><option value="ox">O/X í€´ì¦ˆ</option></select></div><div><label class="block text-sm font-bold mb-1">ì´ë¯¸ì§€</label><input type="file" id="edit-q-image-input" accept="image/*" class="w-full text-xs" onchange="app.handleImageUpload(this, 'edit')"><img id="edit-q-image-preview" class="hidden q-image-thumb mt-2"><input type="hidden" id="edit-q-image-base64"><button onclick="document.getElementById('edit-q-image-preview').style.display='none';document.getElementById('edit-q-image-base64').value='';" class="text-red-500 text-xs">ì´ë¯¸ì§€ ì‚­ì œ</button></div><div><label class="block text-sm font-bold mb-1">ë¬¸ì œ</label><textarea id="edit-q-text" class="w-full p-2 border rounded h-20"></textarea></div><div id="option-container-edit"><label class="block text-sm font-bold mb-1">ë³´ê¸°</label><input type="text" id="edit-q-options" class="w-full p-2 border rounded"></div><div><label class="block text-sm font-bold mb-1">ì •ë‹µ</label><input type="text" id="edit-q-answer" class="w-full p-2 border rounded"></div><div><label class="block text-sm font-bold mb-1">í•´ì„¤</label><input type="text" id="edit-q-exp" class="w-full p-2 border rounded"></div><div class="flex gap-2 pt-2"><button onclick="app.saveEditedQuestion()" class="flex-1 bg-green-600 text-white font-bold py-3 rounded">ì €ì¥</button><button onclick="app.closeEditModal()" class="flex-1 bg-stone-200 text-stone-700 font-bold py-3 rounded">ì·¨ì†Œ</button></div></div></div></div>
    
    <div id="stats-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center"><div class="modal-overlay absolute inset-0" onclick="document.getElementById('stats-modal').style.display='none'"></div><div class="bg-white p-8 rounded-lg shadow-2xl z-10 w-full max-w-2xl mx-4 max-h-[80vh] overflow-y-auto"><h3 class="font-bold text-xl mb-4 border-b pb-2">í†µê³„ ë¶„ì„ (í•™ìƒë³„ ì •ë‹µë¥ )</h3><div id="stats-content"></div><div class="mt-4 text-center"><button onclick="document.getElementById('stats-modal').style.display='none'" class="bg-gray-200 px-4 py-2 rounded">ë‹«ê¸°</button></div></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAOlPQ5PFmL0zxmGrGcuEBnqBXisph7kPU", authDomain: "history-quiz-yongsin.firebaseapp.com", projectId: "history-quiz-yongsin", storageBucket: "history-quiz-yongsin.firebasestorage.app", messagingSenderId: "177587430482", appId: "1:177587430482:web:d79cc145c11e335cc3ab8b", measurementId: "G-LHN97D7R2R" };
        let db; 
        try { 
            if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); } 
            db = firebase.firestore(); 
        } catch(e) { console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨", e); }

        const TEACHER_EMAIL = "westoria28@gmail.com";

        const app = {
            state: { allQuestions:[], logs:[], questionStats: {}, logPage: 1, logsPerPage: 50 },
            init: function() {
                if (typeof firebase === 'undefined' || !firebase.auth) { alert("Firebase ë¡œë“œ ì‹¤íŒ¨"); return; }
                
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        if(user.email === TEACHER_EMAIL) {
                            document.getElementById('view-login-screen').style.display = 'none';
                            document.getElementById('view-dashboard').style.display = 'block';
                            this.loadQuestionsFromFirebase();
                            this.setTeacherTab('log');
                        } else {
                            alert("í—ˆìš©ë˜ì§€ ì•Šì€ ê³„ì •: " + user.email);
                            firebase.auth().signOut();
                        }
                    } else {
                        document.getElementById('view-login-screen').style.display = 'flex';
                        document.getElementById('view-dashboard').style.display = 'none';
                    }
                });
            },
            login: function() {
                const provider = new firebase.auth.GoogleAuthProvider();
                firebase.auth().signInWithPopup(provider).catch(e => {
                    alert("ë¡œê·¸ì¸ ì—ëŸ¬: " + e.message);
                });
            },
            logout: function() {
                firebase.auth().signOut().then(() => location.reload());
            },
            showLoading: function(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; },
            
            setTeacherTab: function(tab) {
                ['log','bank','add'].forEach(t => {
                    document.getElementById('tab-'+t).style.display = 'none'; 
                    const btn = document.getElementById('btn-tab-'+t);
                    if(t===tab) btn.className = "px-5 py-2 rounded-full bg-stone-800 text-white text-sm font-bold shadow transition";
                    else btn.className = "px-5 py-2 rounded-full bg-stone-100 text-stone-600 text-sm font-bold shadow transition";
                });
                document.getElementById('tab-'+tab).style.display = 'block'; 
                if (tab === 'add') this.updateNextQuestionNumber(); else if (tab === 'bank') this.renderBank();
            },
            loadByClass: function(cls) {
                if(!db || !cls) return;
                this.showLoading(true);
                let query = db.collection("quiz_results");
                if (cls === 'all') { query = query.orderBy("timestamp", "desc").limit(50); } 
                else { query = query.where("class", "==", cls).orderBy("timestamp", "desc"); } 

                query.get().then((querySnapshot) => {
                    let logs = []; 
                    querySnapshot.forEach((doc) => { let d = doc.data(); d.docId = doc.id; logs.push(d); });
                    this.state.logs = logs; this.state.logPage = 1; this.renderLogs(); 
                    document.getElementById('log-count').innerText = `(${logs.length}ê±´)`;
                    this.showLoading(false);
                }).catch(e => {
                    this.showLoading(false);
                    if(e.message.includes("index")) alert("âš ï¸ ì¸ë±ìŠ¤ ì„¤ì • í•„ìš”: F12 ì½˜ì†” ë§í¬ í´ë¦­");
                    else alert("ë¡œë“œ ì‹¤íŒ¨: " + e.message);
                });
            },
            searchStudent: function() {
                const name = document.getElementById('search-student-name').value.trim();
                if(!name) { alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"); return; }
                this.showLoading(true);
                db.collection("quiz_results").where("name", "==", name).orderBy("timestamp", "desc").get().then(snapshot => {
                    let logs = [];
                    snapshot.forEach(doc => { let d = doc.data(); d.docId = doc.id; logs.push(d); });
                    if(logs.length === 0) { alert("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤."); this.showLoading(false); return; }
                    
                    let totalScore = logs.reduce((sum, l) => sum + l.score, 0);
                    let avg = Math.round(totalScore / logs.length);
                    let html = `<div class="bg-blue-50 p-4 rounded mb-4 border border-blue-200">
                        <h4 class="font-bold text-lg text-blue-800">${name} í•™ìƒ ê²€ìƒ‰ ê²°ê³¼</h4>
                        <p class="text-sm">ì´ ì‘ì‹œ: <b>${logs.length}íšŒ</b> / í‰ê·  ì ìˆ˜: <b>${avg}ì </b></p>
                    </div><div class="space-y-2">`;
                    
                    logs.forEach(l => {
                        html += `<div class="border p-3 rounded flex justify-between items-center hover:bg-stone-50 cursor-pointer" onclick="app.showStudentDetail('${l.docId}')">
                            <div><span class="font-bold">${l.class}ë°˜ ${l.number}ë²ˆ</span> <span class="text-xs text-gray-500">${l.timeString}</span></div>
                            <div class="font-bold text-amber-600">${l.score}ì </div>
                        </div>`;
                    });
                    html += `</div>`;
                    
                    document.getElementById('stats-content').innerHTML = html;
                    document.getElementById('stats-modal').style.display = 'flex';
                    this.showLoading(false);
                }).catch(e => {
                    this.showLoading(false);
                    if(e.message.includes("index")) alert("âš ï¸ ì¸ë±ìŠ¤ ì„¤ì • í•„ìš”: ì½˜ì†”ì°½ í™•ì¸");
                    else alert("ê²€ìƒ‰ ì‹¤íŒ¨: " + e.message);
                });
            },
            analyzeClassStats: function() {
                if(!this.state.logs || this.state.logs.length === 0) { alert("ë¨¼ì € ë°˜ì„ ì„ íƒí•˜ì—¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”."); return; }
                const studentMap = {};
                this.state.logs.forEach(log => {
                    const key = `${log.class}-${log.number}-${log.name}`;
                    if(!studentMap[key]) studentMap[key] = { name: log.name, cls: log.class, num: log.number, total: 0, count: 0 };
                    studentMap[key].total += log.score;
                    studentMap[key].count++;
                });

                const list = Object.values(studentMap).map(s => ({
                    ...s, avg: Math.round(s.total / s.count)
                })).sort((a, b) => b.avg - a.avg);

                let html = `<div class="mb-2 text-sm text-gray-500">í˜„ì¬ ëª©ë¡ì— ìˆëŠ” í•™ìƒë“¤ì˜ í‰ê·  ì ìˆ˜ì…ë‹ˆë‹¤.</div>
                <table class="w-full text-sm text-left border"><thead class="bg-stone-100"><tr><th class="p-2 border">ìˆœìœ„</th><th class="p-2 border">í•™ìƒ</th><th class="p-2 border">ì‘ì‹œ íšŸìˆ˜</th><th class="p-2 border">í‰ê·  ì ìˆ˜</th></tr></thead><tbody>`;
                
                list.forEach((s, i) => {
                    let rankColor = i < 3 ? 'bg-yellow-50 font-bold' : '';
                    html += `<tr class="${rankColor} border-b"><td class="p-2 border text-center">${i+1}</td><td class="p-2 border">${s.cls}ë°˜ ${s.num}ë²ˆ ${s.name}</td><td class="p-2 border text-center">${s.count}</td><td class="p-2 border text-center text-blue-600 font-bold">${s.avg}ì </td></tr>`;
                });
                html += `</tbody></table>`;

                document.getElementById('stats-content').innerHTML = html;
                document.getElementById('stats-modal').style.display = 'flex';
            },
            renderLogs: function() {
                const sortType = document.getElementById('sort-logs').value;
                let filtered = [...this.state.logs];
                if (sortType === 'number') filtered.sort((a,b) => parseInt(a.number) - parseInt(b.number));
                else if (sortType === 'score_desc') filtered.sort((a,b) => b.score - a.score);
                const start = (this.state.logPage - 1) * this.state.logsPerPage;
                const end = start + this.state.logsPerPage;
                const pageData = filtered.slice(start, end);
                let html = '';
                if(filtered.length===0) html='<tr><td colspan="6" class="p-10 text-center text-stone-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                else pageData.forEach((d) => { html += `<tr class="border-b hover:bg-stone-50 cursor-pointer" onclick="app.showStudentDetail('${d.docId}')"><td class="p-3 text-center"><input type="checkbox" class="log-checkbox" value="${d.docId}" onclick="event.stopPropagation()"></td><td class="p-3 text-stone-500 text-xs">${d.timeString}</td><td class="p-3 font-medium">${d.class}ë°˜ ${d.number}ë²ˆ ${d.name}</td><td class="p-3 font-bold text-amber-600">${d.score}</td><td class="p-3 text-xs">${d.status}</td><td class="p-3 text-center"><button onclick="app.deleteLog('${d.docId}')" class="text-red-500" onclick="event.stopPropagation()"><i class="fas fa-trash-alt"></i></button></td></tr>`; });
                document.getElementById('teacher-log-body').innerHTML = html;
                const totalPages = Math.ceil(filtered.length / this.state.logsPerPage);
                let pHtml = ''; if(totalPages > 1) { for(let i=1; i<=totalPages; i++) pHtml += `<button class="page-btn ${i===this.state.logPage ? 'active' : ''}" onclick="app.changeLogPage(${i})">${i}</button>`; }
                document.getElementById('pagination-controls').innerHTML = pHtml;
            },
            changeLogPage: function(p) { this.state.logPage = p; this.renderLogs(); },
            
            // [í•µì‹¬] ë¬¸ì œ ë¡œë“œ í•¨ìˆ˜ (sync=trueë©´ ì„œë²„ì˜ ë©”íƒ€ë°ì´í„°ë„ ê°±ì‹ )
            loadQuestionsFromFirebase: function(sync = false) {
                db.collection("quiz_questions").get().then((querySnapshot) => {
                    const loadedData = []; querySnapshot.forEach((doc) => { let data = doc.data(); data.id = parseInt(doc.id); loadedData.push(data); });
                    loadedData.sort((a, b) => a.id - b.id); this.state.allQuestions = loadedData; 
                    if(document.getElementById('tab-bank').style.display !== 'none') this.renderBank();
                    
                    // ë§Œì•½ ë¬¸ì œ ì¶”ê°€/ì‚­ì œë¡œ ì¸í•´ í˜¸ì¶œëœ ê²ƒì´ë¼ë©´, ì„œë²„ì˜ 'ì´ ë¬¸ì œ ìˆ˜'ë„ ì—…ë°ì´íŠ¸
                    if(sync) { this.updateServerCount(loadedData.length); }
                }).catch((e) => { console.error("ë¬¸ì œ ë¡œë“œ ì—ëŸ¬:", e); });
            },
            // [ì¶”ê°€] ì„œë²„ì— ì´ ë¬¸ì œ ê°œìˆ˜ ì €ì¥í•˜ëŠ” í•¨ìˆ˜
            updateServerCount: function(count) {
                db.collection("metadata").doc("count_info").set({ total_questions: count })
                .then(() => console.log(`ì„œë²„ ë¬¸ì œ ìˆ˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ${count}ê°œ`))
                .catch(e => console.error("ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨", e));
            },
            
            calculateStats: function() {
                const stats = {};
                this.state.logs.forEach(log => { if (log.details) log.details.forEach(item => { if (!stats[item.id]) stats[item.id] = { total: 0, correct: 0 }; stats[item.id].total++; if (item.correct) stats[item.id].correct++; }); });
                this.state.questionStats = stats;
            },
            renderBank: function() {
                this.calculateStats();
                let filtered = [...this.state.allQuestions];
                const unitFilter = document.getElementById('bank-filter-unit').value; if (unitFilter !== 'all') filtered = filtered.filter(q => (q.unit || "").indexOf(unitFilter) !== -1);
                const sortType = document.getElementById('bank-sort').value;
                if (sortType === 'id') filtered.sort((a, b) => a.id - b.id);
                else if (sortType.startsWith('rate')) filtered.sort((a, b) => { const sA = this.state.questionStats[a.id]||{t:0,c:0}, sB = this.state.questionStats[b.id]||{t:0,c:0}; return (sA.total>0?sA.correct/sA.total:0) - (sB.total>0?sB.correct/sB.total:0); });
                document.getElementById('total-q-count').innerText = `(${filtered.length}ë¬¸í•­)`;
                document.getElementById('bank-body').innerHTML = filtered.map(q => {
                    const stat = this.state.questionStats[q.id] || { total: 0, correct: 0 };
                    const rate = stat.total > 0 ? Math.round((stat.correct / stat.total) * 100) : 0;
                    return `<tr class="border-b hover:bg-stone-50"><td class="p-3 text-center"><input type="checkbox" class="q-checkbox" value="${q.id}"></td><td class="p-3 text-xs text-center">${q.id}</td><td class="p-3 text-xs text-gray-500">${q.unit || 'ê¸°íƒ€'}</td><td class="p-3 text-center text-xs">${q.type}</td><td class="p-3 text-sm cursor-pointer text-blue-600" onclick="app.editQuestion(${q.id})">${q.question}</td><td class="p-3 text-center"><button onclick="app.previewQuestion(${q.id})"><i class="fas fa-eye"></i></button></td><td class="p-3 text-xs font-bold text-center col-answer">${q.answer}</td><td class="p-3 text-center w-24 text-xs font-bold">${rate}%<div class="rate-bar-bg"><div class="rate-bar-fill ${rate<60?'bg-red-500':'bg-green-500'}" style="width:${rate}%"></div></div></td></tr>`;
                }).join('');
            },
            deleteSelectedLogs: function() { const checked = Array.from(document.querySelectorAll('.log-checkbox:checked')).map(cb => cb.value); if(checked.length && confirm("ì‚­ì œ?")) { const batch = db.batch(); checked.forEach(id => batch.delete(db.collection("quiz_results").doc(id))); batch.commit().then(() => { 
                this.loadByClass(document.getElementById('select-class-trigger').value); 
            }).catch(e=>alert("ì‚­ì œ ì‹¤íŒ¨: "+e.message)); } },
            deleteLog: function(docId) { if(confirm("ì‚­ì œ?")) { db.collection("quiz_results").doc(docId).delete().then(() => {
                this.loadByClass(document.getElementById('select-class-trigger').value); 
            }).catch(e=>alert("ì‚­ì œ ì‹¤íŒ¨: "+e.message)); } },
            // [ìˆ˜ì •] ì‚­ì œ ì‹œ ì„œë²„ ì¹´ìš´íŠ¸ ê°±ì‹ 
            deleteSelectedQuestions: function() { const checked = Array.from(document.querySelectorAll('.q-checkbox:checked')).map(cb => cb.value); if(checked.length && confirm("ì‚­ì œ?")) { const batch = db.batch(); checked.forEach(id => batch.delete(db.collection("quiz_questions").doc(id))); batch.commit().then(() => { this.loadQuestionsFromFirebase(true); }).catch(e=>alert("ì‚­ì œ ì‹¤íŒ¨: "+e.message)); } },
            // [ìˆ˜ì •] ì´ˆê¸°í™” ì‹œ ì„œë²„ ì¹´ìš´íŠ¸ 0ìœ¼ë¡œ ì„¤ì •
            resetServerQuestions: function() { if(confirm("ì „ì²´ ì´ˆê¸°í™”?")) { db.collection("quiz_questions").get().then(s => { const batch = db.batch(); s.docs.forEach(d => batch.delete(d.ref)); return batch.commit(); }).then(() => { this.state.allQuestions=[]; this.renderBank(); this.updateServerCount(0); }).catch(e=>alert("ì‹¤íŒ¨: "+e.message)); } },
            showStudentDetail: function(docId) { const log = this.state.logs.find(l => l.docId === docId); if(!log) return; let html = `<div class="font-bold mb-2">${log.class}ë°˜ ${log.number}ë²ˆ ${log.name} (${log.score}ì )</div>`; log.details.forEach((d,i)=>{ const q=this.state.allQuestions.find(x=>x.id===d.id); html+=`<div class="p-2 border mb-2 ${d.correct?'bg-green-50':'bg-red-50'}"><div class="text-sm font-bold">Q${i+1}. ${q?q.question:'ì‚­ì œëœ ë¬¸ì œ'}</div><div class="text-xs">ë‹µ: ${d.u} (ì •ë‹µì—¬ë¶€:${d.correct?'O':'X'})</div></div>`; }); document.getElementById('student-detail-content').innerHTML=html; document.getElementById('student-detail-modal').style.display='flex'; },
            previewQuestion: function(id) { const q = this.state.allQuestions.find(x => x.id === id); if(!q) return; let html = `<div class="mb-4 font-bold text-lg">${q.question}</div>`; if(q.image) html+=`<img src="${q.image}" class="q-image-thumb mb-4">`; if(q.type==='choice') q.options.forEach(o=>html+=`<div class="choice-btn p-2 border rounded mb-1">${o}</div>`); else if(q.type==='ox') html+=`<div class="flex gap-2"><button class="ox-btn">O</button><button class="ox-btn">X</button></div>`; else html+=`<input class="border p-2 w-full" placeholder="ì •ë‹µ ì…ë ¥">`; document.getElementById('preview-content').innerHTML=html; document.getElementById('preview-modal').style.display='flex'; },
            editQuestion: function(id) { const q = this.state.allQuestions.find(q => q.id === id); if(!q) return; document.getElementById('edit-q-id').value = q.id; document.getElementById('edit-q-unit').value = q.unit; document.getElementById('edit-q-type').value = q.type; document.getElementById('edit-q-text').value = q.question; document.getElementById('edit-q-answer').value = q.answer; document.getElementById('edit-q-exp').value = q.explanation; document.getElementById('edit-q-options').value = q.options ? q.options.join(', ') : ''; this.toggleOptionInput('edit'); document.getElementById('edit-q-image-base64').value = q.image || ''; const img = document.getElementById('edit-q-image-preview'); if(q.image) { img.src = q.image; img.style.display='block'; } else img.style.display='none'; document.getElementById('edit-modal').style.display='flex'; },
            closeEditModal: function() { document.getElementById('edit-modal').style.display='none'; },
            saveEditedQuestion: function() { const id = parseInt(document.getElementById('edit-q-id').value); const updatedQ = { id, unit: document.getElementById('edit-q-unit').value, type: document.getElementById('edit-q-type').value, question: document.getElementById('edit-q-text').value, options: document.getElementById('edit-q-options').value.split(',').map(s=>s.trim()), answer: document.getElementById('edit-q-answer').value, explanation: document.getElementById('edit-q-exp').value, image: document.getElementById('edit-q-image-base64').value || null }; db.collection("quiz_questions").doc(String(id)).set(updatedQ).then(() => { alert("ìˆ˜ì •ë¨"); this.closeEditModal(); this.loadQuestionsFromFirebase(true); }).catch(e=>alert("ì‹¤íŒ¨: "+e.message)); },
            toggleOptionInput: function(prefix) { const t = document.getElementById(prefix + '-q-type').value; document.getElementById('option-container-' + prefix).style.display = (t==='choice'||t==='order')?'block':'none'; },
            updateNextQuestionNumber: function() { const maxId = this.state.allQuestions.reduce((max, item) => Math.max(max, item.id), 0); document.getElementById('next-q-id-display').innerText = `ë‹¤ìŒ ë²ˆí˜¸: ${maxId + 1}`; },
            handleImageUpload: function(input, prefix) { if(input.files[0]) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById(prefix + '-q-image-base64').value = e.target.result; document.getElementById(prefix + '-q-image-preview').src = e.target.result; document.getElementById(prefix + '-q-image-preview').style.display='block'; }; reader.readAsDataURL(input.files[0]); } },
            // [ìˆ˜ì •] ë¬¸ì œ ì¶”ê°€ ì‹œ ì„œë²„ ì¹´ìš´íŠ¸ ê°±ì‹ 
            addCustomQuestion: function() { const newQ = { id: this.state.allQuestions.reduce((m,i)=>Math.max(m,i.id),0)+1, unit: document.getElementById('new-q-unit').value, type: document.getElementById('new-q-type').value, question: document.getElementById('new-q-text').value, options: document.getElementById('new-q-options').value.split(',').map(s=>s.trim()), answer: document.getElementById('new-q-answer').value, explanation: document.getElementById('new-q-exp').value, image: document.getElementById('new-q-image-base64').value || null }; db.collection("quiz_questions").doc(String(newQ.id)).set(newQ).then(() => { alert("ì¶”ê°€ë¨"); this.loadQuestionsFromFirebase(true); }).catch(e=>alert("ì‹¤íŒ¨: "+e.message)); },
            // [ìˆ˜ì •] ì—‘ì…€ ì—…ë¡œë“œ ì‹œ ì„œë²„ ì¹´ìš´íŠ¸ ê°±ì‹ 
            uploadExcel: function() { const f = document.getElementById('excel-file').files[0]; if(!f) return; const r = new FileReader(); r.onload = async (e) => { const wb = XLSX.read(e.target.result, {type:'array'}); const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1}); let batch = db.batch(), cnt=0, id=this.state.allQuestions.reduce((m,i)=>Math.max(m,i.id),0); for(let i=1; i<rows.length; i++) { if(!rows[i][2]) continue; id++; batch.set(db.collection("quiz_questions").doc(String(id)), { id, unit: rows[i][0]||"ê¸°íƒ€", type: "choice", question: rows[i][2], options: (rows[i][3]||"").split(','), answer: String(rows[i][4]), explanation: rows[i][5]||"", image: null }); cnt++; if(cnt%400===0) { await batch.commit(); batch=db.batch(); } } await batch.commit(); alert(cnt+"ê°œ ì¶”ê°€ë¨"); this.loadQuestionsFromFirebase(true); }; r.readAsArrayBuffer(f); },
            downloadTemplate: function() { XLSX.writeFile(XLSX.utils.book_new(), "ì–‘ì‹.xlsx"); },
            downloadExcel: function() { let csv="\uFEFFì‹œê°„,ë°˜,ë²ˆí˜¸,ì´ë¦„,ì ìˆ˜\n"+this.state.logs.map(l=>`${l.timeString},${l.class},${l.number},${l.name},${l.score}`).join("\n"); const a=document.createElement("a"); a.href="data:text/csv;charset=utf-8,"+encodeURI(csv); a.download="ê²°ê³¼.csv"; a.click(); }
        };
        window.onload = function() { app.init(); };
    </script>
</body>
</html>
