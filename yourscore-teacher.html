<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        // ★수정됨: Firestore(데이터베이스) 관련 도구만 가져옵니다.
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        // ★추가됨: Auth(로그인) 관련 도구는 여기서 따로 가져옵니다.
        import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAOlPQ5PFmL0zxmGrGcuEBnqBXisph7kPU",
          authDomain: "history-quiz-yongsin.firebaseapp.com",
          projectId: "history-quiz-yongsin",
          storageBucket: "history-quiz-yongsin.firebasestorage.app",
          messagingSenderId: "177587430482",
          appId: "1:177587430482:web:1188e0f661368040c3ab8b",
          measurementId: "G-YG2SLS45D8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); // 이제 정상적으로 작동합니다.

        // 행 추가 함수
        window.addRow = () => {
            const div = document.createElement('div');
            div.className = 'criteria-row';
            div.innerHTML = `
                <select class="c-type">
                    <option value="지필">지필평가</option>
                    <option value="수행">수행평가</option>
                </select>
                <input type="text" placeholder="항목명 (예: 기말고사)" class="c-name" required>
                <input type="number" placeholder="만점" class="c-max" min="1" required>
                <input type="number" placeholder="반영비율(%)" class="c-ratio" min="1" max="100" required>
                <button class="remove-btn" onclick="removeRow(this)">삭제</button>
            `;
            document.getElementById('criteriaList').appendChild(div);
        };

        window.removeRow = (button) => {
            button.parentElement.remove();
        };

        // 페이지 로드 시 빈 칸 하나 만들기
        addRow();

        // 저장 함수
        window.saveToFirebase = async () => {
            const user = auth.currentUser;
            
            // 로그인 확인
            if (!user) {
                alert("⚠️ 로그인이 확인되지 않습니다.\n기존 교사 대시보드(teacher.html)에서 로그인하신 상태여야 합니다.");
                return;
            }

            const semester = document.getElementById('semesterSelect').value;
            const subject = document.getElementById('subjectName').value.trim();
            
            if (!subject) { alert("과목명을 입력해주세요."); return; }

            const rows = document.querySelectorAll('.criteria-row');
            const items = [];
            let totalRatio = 0;

            for (const row of rows) {
                const type = row.querySelector('.c-type').value;
                const name = row.querySelector('.c-name').value.trim();
                const maxScore = row.querySelector('.c-max').value;
                const ratio = row.querySelector('.c-ratio').value;

                if (!name || !maxScore || !ratio) {
                    alert("모든 빈칸을 채워주세요.");
                    return;
                }

                totalRatio += Number(ratio);
                items.push({
                    type: type,
                    name: name,
                    maxScore: Number(maxScore),
                    ratio: Number(ratio)
                });
            }

            if (items.length === 0) { alert("항목을 추가해주세요."); return; }
            if (totalRatio !== 100) { alert(`반영 비율 합계가 ${totalRatio}% 입니다. 100%를 맞춰주세요.`); return; }

            try {
                await addDoc(collection(db, "grading_plans"), {
                    semester: semester,
                    subject: subject,
                    items: items,
                    createdAt: new Date(),
                    teacherEmail: user.email
                });
                
                alert(`✅ [${semester}] ${subject} 평가 기준이 저장되었습니다!`);
                location.reload(); 
            } catch (e) {
                console.error("Error: ", e);
                alert("저장 실패: " + e.message);
            }
        };
    </script>
