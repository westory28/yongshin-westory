<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나의 성적표 - WeStory</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        /* 기본 스타일 */
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f5f7fa; margin: 0; padding: 0; color: #333; display: flex; flex-direction: column; min-height: 100vh; }
        
        /* 헤더 스타일 */
        .main-header {
            background-color: #fff;
            border-bottom: 1px solid #eee;
            padding: 0 40px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }

        .header-left { display: flex; align-items: center; }
        
        .logo-area { font-size: 26px; font-weight: 800; letter-spacing: -0.5px; cursor: pointer; margin-right: 60px; }
        .text-we { color: #2563eb; }   /* We - 파랑 */
        .text-story { color: #f59e0b; } /* story - 노랑 */

        .nav-menu { display: flex; gap: 40px; }
        .nav-item { 
            text-decoration: none; color: #666; font-size: 16px; font-weight: 500; 
            position: relative; padding: 22px 0; transition: color 0.2s;
        }
        .nav-item:hover { color: #2563eb; }
        
        /* 활성화 된 메뉴 스타일 */
        .nav-item.active { color: #2563eb; font-weight: 700; }
        .nav-item.active::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background-color: #2563eb;
        }

        .btn-logout-pill {
            background-color: #f3f4f6;
            color: #4b5563;
            border: none;
            padding: 10px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-logout-pill:hover { background-color: #e5e7eb; }

        /* 메인 컨테이너 */
        .container { max-width: 1100px; margin: 0 auto; padding: 40px 20px; flex: 1; width: 100%; box-sizing: border-box; }

        .page-header { margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
        .page-title { font-size: 24px; font-weight: 700; color: #111; margin: 0; }
        
        .alert-box { 
            background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;
            padding: 15px; border-radius: 6px; margin-bottom: 25px; 
            font-size: 14px; font-weight: bold; text-align: center; line-height: 1.6;
        }

        /* 컨트롤 패널 */
        .control-panel {
            background-color: #fff; border-radius: 8px; padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px;
            display: flex; gap: 15px; flex-wrap: wrap; align-items: center;
        }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-label { font-size: 14px; font-weight: bold; color: #555; }
        select { 
            padding: 8px 12px; font-size: 14px; border: 1px solid #ccc; 
            border-radius: 4px; background: white; cursor: pointer; min-width: 100px;
        }
        select:focus { border-color: #4a90e2; outline: none; }

        /* 대시보드 그리드 */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 340px; gap: 25px; }
        @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }

        /* 과목 카드 */
        .subject-card { 
            background: #fff; border-radius: 8px; margin-bottom: 15px; 
            border: 1px solid #e1e4e8; border-left: 5px solid #ccc; 
            transition: all 0.2s;
        }
        .subject-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-2px); }
        
        .card-header { padding: 18px 25px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .subject-name { font-size: 18px; font-weight: 700; color: #222; }
        .score-info { text-align: right; }
        .total-score { font-size: 20px; font-weight: bold; color: #333; }
        .grade-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; color: #fff; margin-left: 8px; vertical-align: middle; }
        .toggle-text { font-size: 12px; color: #999; margin-top: 4px; }

        .card-body { padding: 0 25px 25px 25px; display: none; background-color: #fafbfc; border-top: 1px solid #eee; }
        .card-body.expanded { display: block; }

        /* 입력 폼 */
        .input-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #eee; }
        .input-item:last-child { border-bottom: none; }
        .item-label { font-size: 14px; color: #333; }
        .item-sub { font-size: 12px; color: #888; margin-top: 2px; }
        .type-tag { font-size: 11px; padding: 2px 5px; border-radius: 3px; background: #eee; color: #555; margin-right: 6px; }
        .score-input { width: 70px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-size: 15px; }

        /* 차트 패널 */
        .chart-panel { 
            background: #fff; padding: 20px; border-radius: 8px; 
            border: 1px solid #e1e4e8; height: fit-content; position: sticky; top: 20px;
        }
        .chart-title { font-size: 16px; font-weight: bold; margin-bottom: 15px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px;}
        .chart-wrapper { position: relative; height: 300px; width: 100%; }

        .grade-scale-bar { 
            display: flex; height: 30px; border-radius: 6px; overflow: hidden; margin-top: 20px; 
            font-weight: bold; color: white; text-shadow: 0 1px 1px rgba(0,0,0,0.2); font-size: 11px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .scale-segment { flex: 1; display: flex; justify-content: center; align-items: center; }

        /* 푸터 */
        .main-footer {
            text-align: center;
            padding: 30px 0;
            color: #9ca3af;
            font-size: 13px;
            border-top: 1px solid #eee;
            margin-top: auto;
            background-color: #fff;
        }

        #loginSection { max-width: 400px; margin: 100px auto; text-align: center; background: #fff; padding: 50px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .btn-google { background-color: #fff; color: #444; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 12px; padding: 12px; font-size: 15px; width: 100%; cursor: pointer; border-radius: 4px; margin-top: 20px; transition: background 0.2s; }

        .hidden { display: none !important; }
        
        /* 색상 */
        .bg-A { background-color: #fa5252; } 
        .bg-B { background-color: #fd7e14; } 
        .bg-C { background-color: #fab005; } 
        .bg-D { background-color: #51cf66; } 
        .bg-E { background-color: #339af0; } 
        .bg-none { background-color: #adb5bd; } 

    </style>
</head>
<body>

    <div id="loginSection">
        <h2 style="margin-bottom:10px;">성적 관리 시스템</h2>
        <p style="color:#666; font-size:14px;">학교 구글 계정으로 로그인해주세요.</p>
        <button class="btn-google" onclick="loginWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G" width="18">
            Google 계정으로 로그인
        </button>
    </div>

    <div id="appSection" class="hidden">
        
        <header class="main-header">
            <div class="header-left">
                <div class="logo-area">
                    <span class="text-we">We</span><span class="text-story">story</span>
                </div>
                <nav class="nav-menu">
                    <a href="#" class="nav-item">역사 퀴즈</a>
                    <a href="#" class="nav-item">학습 기록</a>
                    <a href="#" class="nav-item active">나의 성적표</a>
                </nav>
            </div>
            <button class="btn-logout-pill" onclick="logout()">로그아웃</button>
        </header>

        <div class="container">
            <div class="page-header">
                <h1 class="page-title">나의 성적표</h1>
            </div>

            <div class="alert-box">
                ⚠️ 이 결과는 참고용 시뮬레이션이며, 정확한 성적은 <u>나이스(NEIS)</u> 및 <u>성적 통지표</u>를 확인하세요.<br>
                <span style="font-size:12px; font-weight:normal; color:#664d03;">(입력한 점수는 서버에 저장되지 않고 내 컴퓨터에만 임시로 남습니다.)</span>
            </div>

            <div class="control-panel">
                <div class="filter-group">
                    <span class="filter-label">연도</span>
                    <select id="yearFilter" onchange="renderDashboard()">
                        <option value="2025">2025학년도</option>
                        <option value="2026">2026학년도</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">학기</span>
                    <select id="semesterFilter" onchange="renderDashboard()">
                        <option value="1학기">1학기</option>
                        <option value="2학기">2학기</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">학년</span>
                    <select id="gradeFilter" onchange="renderDashboard()">
                        <option value="1">1학년</option>
                        <option value="2">2학년</option>
                        <option value="3">3학년</option>
                    </select>
                </div>

                <div class="filter-group" style="margin-left:auto;">
                    <span class="filter-label">정렬</span>
                    <select id="sortFilter" onchange="renderDashboard()">
                        <option value="default">교과표 순서 (국영수...)</option>
                        <option value="score_high">성적 높은 순</option>
                        <option value="name">가나다 순</option>
                    </select>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="left-content">
                    <div id="subjectsList">
                        </div>
                </div>

                <div class="right-sidebar">
                    <div class="chart-panel">
                        <div class="chart-title">성취도 그래프</div>
                        <div class="chart-wrapper">
                            <canvas id="gradeChart"></canvas>
                        </div>
                        <div class="grade-scale-bar">
                            <div class="scale-segment bg-A">A (90~)</div>
                            <div class="scale-segment bg-B">B (80~)</div>
                            <div class="scale-segment bg-C">C (70~)</div>
                            <div class="scale-segment bg-D">D (60~)</div>
                            <div class="scale-segment bg-E">E (~59)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="main-footer">
            Copyright © 역사교사 방재석. All rights reserved.
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAOlPQ5PFmL0zxmGrGcuEBnqBXisph7kPU",
          authDomain: "history-quiz-yongsin.firebaseapp.com",
          projectId: "history-quiz-yongsin",
          storageBucket: "history-quiz-yongsin.firebasestorage.app",
          messagingSenderId: "177587430482",
          appId: "1:177587430482:web:1188e0f661368040c3ab8b",
          measurementId: "G-YG2SLS45D8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let allGradingPlans = [];
        let myChart = null;

        const FIXED_SUBJECT_ORDER = ['국어', '영어', '수학', '과학', '역사', '기가', '한문', '일본어', '미술', '체육'];

        function getGradeInfo(score, hasData) {
            if (!hasData) return { grade: '-', colorCode: '#adb5bd', class: 'bg-none', text: '미입력' }; 
            if (score >= 90) return { grade: 'A', colorCode: '#fa5252', class: 'bg-A', text: `${score}점` };
            if (score >= 80) return { grade: 'B', colorCode: '#fd7e14', class: 'bg-B', text: `${score}점` };
            if (score >= 70) return { grade: 'C', colorCode: '#fab005', class: 'bg-C', text: `${score}점` };
            if (score >= 60) return { grade: 'D', colorCode: '#51cf66', class: 'bg-D', text: `${score}점` };
            return { grade: 'E', colorCode: '#339af0', class: 'bg-E', text: `${score}점` };
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('appSection').classList.remove('hidden');
                loadAllData();
            } else {
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('appSection').classList.add('hidden');
            }
        });

        window.loginWithGoogle = async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (e) { alert("로그인 실패"); } };
        window.logout = async () => { if(confirm("로그아웃 하시겠습니까?")) { await signOut(auth); location.reload(); } };

        async function loadAllData() {
            try {
                const q = query(collection(db, "grading_plans"), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);
                allGradingPlans = [];
                snapshot.forEach(doc => allGradingPlans.push({ id: doc.id, ...doc.data() }));
                renderDashboard();
            } catch (e) { console.error(e); }
        }

        window.toggleCard = (header) => {
            const body = header.nextElementSibling;
            const hint = header.querySelector('.toggle-text');
            if (body.classList.contains('expanded')) {
                body.classList.remove('expanded');
                hint.innerText = '▼ 점수 입력하기';
            } else {
                body.classList.add('expanded');
                hint.innerText = '▲ 접기';
            }
        };

        function calculateTotal(plan) {
            let total = 0;
            let hasData = false; 

            plan.items.forEach((item, idx) => {
                const saved = localStorage.getItem(`score_${plan.id}_${idx}`);
                if(saved !== null && saved !== "") {
                    hasData = true;
                    const val = parseFloat(saved);
                    if(!isNaN(val)) total += (val / item.maxScore) * item.ratio;
                }
            });
            
            return { 
                score: parseFloat(total.toFixed(1)), 
                hasData: hasData 
            };
        }

        window.renderDashboard = () => {
            const gradeFilter = document.getElementById('gradeFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const semesterFilter = document.getElementById('semesterFilter').value;
            const sortMode = document.getElementById('sortFilter').value;
            
            const container = document.getElementById('subjectsList');
            container.innerHTML = '';

            let filteredPlans = allGradingPlans.filter(plan => {
                const pGrade = plan.targetGrade || "2"; 
                const pYear = plan.academicYear || "2025";
                const pSem = plan.semester || "1학기";
                return String(pGrade) === gradeFilter && pYear === yearFilter && pSem === semesterFilter;
            });

            filteredPlans = filteredPlans.map(plan => {
                const result = calculateTotal(plan);
                return { ...plan, currentScore: result.score, hasData: result.hasData };
            });

            if (sortMode === 'score_high') {
                filteredPlans.sort((a, b) => b.currentScore - a.currentScore);
            } else if (sortMode === 'name') {
                filteredPlans.sort((a, b) => a.subject.localeCompare(b.subject));
            } else {
                filteredPlans.sort((a, b) => {
                    let idxA = FIXED_SUBJECT_ORDER.indexOf(a.subject);
                    let idxB = FIXED_SUBJECT_ORDER.indexOf(b.subject);
                    if(idxA === -1) idxA = 999; 
                    if(idxB === -1) idxB = 999;
                    return idxA - idxB;
                });
            }

            if (filteredPlans.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:50px; color:#888; background:#fff; border-radius:8px; border:1px solid #eee;">
                    해당 학기(${gradeFilter}학년 ${yearFilter} ${semesterFilter})의 데이터가 없습니다.</div>`;
                updateChart([], [], []);
                return;
            }

            const chartLabels = []; const chartData = []; const chartColors = [];

            filteredPlans.forEach(plan => {
                const { currentScore, hasData } = plan;
                const info = getGradeInfo(currentScore, hasData);

                chartLabels.push(plan.subject);
                chartData.push(currentScore); 
                chartColors.push(info.colorCode);

                const card = document.createElement('div');
                card.className = 'subject-card';
                card.style.borderLeftColor = info.colorCode;

                let itemsHtml = '';
                plan.items.forEach((item, idx) => {
                    const savedVal = localStorage.getItem(`score_${plan.id}_${idx}`) || "";
                    itemsHtml += `
                        <div class="input-item">
                            <div>
                                <div class="item-label">
                                    <span class="type-tag">${item.type}</span>${item.name}
                                </div>
                                <div class="item-sub">${item.maxScore}점 만점 / ${item.ratio}% 반영</div>
                            </div>
                            <input type="number" class="score-input" 
                                data-planid="${plan.id}" data-idx="${idx}" data-max="${item.maxScore}" 
                                value="${savedVal}" placeholder="0" onclick="event.stopPropagation()">
                        </div>
                    `;
                });

                card.innerHTML = `
                    <div class="card-header" onclick="toggleCard(this)">
                        <div class="subject-name">${plan.subject}</div>
                        <div class="score-info">
                            <span class="total-score" id="score_text_${plan.id}" style="color:${info.colorCode}">${info.text}</span>
                            <span class="grade-badge ${info.class}" id="grade_badge_${plan.id}">${info.grade}</span>
                            <div class="toggle-text">▼ 점수 입력하기</div>
                        </div>
                    </div>
                    <div class="card-body">${itemsHtml}</div>
                `;
                container.appendChild(card);
            });

            document.querySelectorAll('.score-input').forEach(input => input.addEventListener('input', handleInput));
            updateChart(chartLabels, chartData, chartColors);
        };

        function handleInput(e) {
            const planId = e.target.dataset.planid;
            const idx = e.target.dataset.idx;
            const max = parseFloat(e.target.dataset.max);
            let val = parseFloat(e.target.value);

            if (!isNaN(val)) {
                if(val > max) { val = max; e.target.value = max; }
                if(val < 0) { val = 0; e.target.value = 0; }
            }

            localStorage.setItem(`score_${planId}_${idx}`, e.target.value);
            updateCardUI(planId);
        }

        function updateCardUI(planId) {
            const plan = allGradingPlans.find(p => p.id === planId);
            if(!plan) return;

            const { score, hasData } = calculateTotal(plan);
            const info = getGradeInfo(score, hasData);

            const textEl = document.getElementById(`score_text_${planId}`);
            const badgeEl = document.getElementById(`grade_badge_${planId}`);
            
            textEl.innerText = info.text; 
            textEl.style.color = info.colorCode;
            
            badgeEl.innerText = info.grade;
            badgeEl.className = `grade-badge ${info.class}`;
            
            badgeEl.closest('.subject-card').style.borderLeftColor = info.colorCode;

            if(myChart) {
                const idx = myChart.data.labels.indexOf(plan.subject);
                if(idx !== -1) {
                    myChart.data.datasets[0].data[idx] = score;
                    myChart.data.datasets[0].backgroundColor[idx] = info.colorCode;
                    myChart.update();
                }
            }
        }

        function updateChart(labels, data, colors) {
            const ctx = document.getElementById('gradeChart').getContext('2d');
            if(myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '환산 점수',
                        data: data,
                        backgroundColor: colors,
                        borderRadius: 4,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100 },
                        x: { ticks: { font: { size: 12 } } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
    </script>
</body>
</html>
