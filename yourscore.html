<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë‚˜ì˜ ë“±ê¸‰ ì‹œë®¬ë ˆì´í„°</title>
    <style>
        .result-box { border: 2px solid #333; padding: 15px; margin-top: 20px; border-radius: 10px; }
        .simulation-tip { color: #d32f2f; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>ğŸ“Š ì„±ì  ì‹œë®¬ë ˆì´í„°</h1>
    
    <label>ê³¼ëª© ì„ íƒ: </label>
    <select id="subjectSelect"></select>

    <div id="inputContainer" style="margin-top: 20px;"></div>

    <div class="result-box">
        <h3>í˜„ì¬ ì„±ì : <span id="currentScore">0</span>ì  (<span id="currentGrade">E</span>)</h3>
        <div id="simulationResult" class="simulation-tip"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { /* ì„ ìƒë‹˜ì˜ config ê°’ */ };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentPlan = []; // í˜„ì¬ ì„ íƒëœ ê³¼ëª©ì˜ ê¸°ì¤€ ë°ì´í„°

        // 1. ê³¼ëª© ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadSubjects() {
            const querySnapshot = await getDocs(collection(db, "grading_plans"));
            const select = document.getElementById("subjectSelect");
            
            querySnapshot.forEach((doc) => {
                const option = document.createElement("option");
                option.value = doc.id;
                option.text = doc.data().subject;
                option.dataset.plan = JSON.stringify(doc.data().items);
                select.appendChild(option);
            });

            select.addEventListener('change', renderInputs);
            if(querySnapshot.size > 0) renderInputs(); // ì²« í•­ëª© ìë™ ë¡œë“œ
        }

        // 2. ì…ë ¥ì¹¸ ìƒì„± ë° ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ë°ì´í„° ë¡œë“œ
        function renderInputs() {
            const select = document.getElementById("subjectSelect");
            const items = JSON.parse(select.options[select.selectedIndex].dataset.plan);
            currentPlan = items;
            
            const container = document.getElementById("inputContainer");
            container.innerHTML = ""; // ì´ˆê¸°í™”

            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤: subjectID_itemName
            const subjectId = select.value;

            items.forEach((item, index) => {
                const savedScore = localStorage.getItem(`${subjectId}_${index}`) || "";
                
                const div = document.createElement("div");
                div.innerHTML = `
                    <label>${item.name} (${item.maxScore}ì  ë§Œì , ${item.ratio}%): </label>
                    <input type="number" class="score-input" data-index="${index}" 
                           placeholder="ì ìˆ˜ ì…ë ¥" value="${savedScore}" 
                           max="${item.maxScore}">
                `;
                container.appendChild(div);
            });

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‹¤ì‹œ ì—°ê²°
            document.querySelectorAll('.score-input').forEach(input => {
                input.addEventListener('input', handleInput);
            });
            
            calculateAndSimulate(); // ì´ˆê¸° ê³„ì‚°
        }

        // 3. ì ìˆ˜ ì…ë ¥ ì²˜ë¦¬ (ë¡œì»¬ ì €ì¥ + ê³„ì‚° íŠ¸ë¦¬ê±°)
        function handleInput(e) {
            const subjectId = document.getElementById("subjectSelect").value;
            const index = e.target.dataset.index;
            const value = e.target.value;

            // â˜… í•µì‹¬: ì„œë²„ ì „ì†¡ ì—†ì´ ë‚´ ì»´í“¨í„°(ë¸Œë¼ìš°ì €)ì—ë§Œ ì €ì¥
            localStorage.setItem(`${subjectId}_${index}`, value);
            calculateAndSimulate();
        }

        // 4. ê³„ì‚° ë° ì‹œë®¬ë ˆì´ì…˜ ë¡œì§
        function calculateAndSimulate() {
            let totalConverted = 0;
            let totalRatio = 0;
            let remainingItems = [];

            const inputs = document.querySelectorAll('.score-input');
            
            // í˜„ì¬ ì ìˆ˜ ê³„ì‚°
            inputs.forEach((input, idx) => {
                const score = parseFloat(input.value);
                const item = currentPlan[idx];

                if (!isNaN(score)) {
                    // í™˜ì‚° ê³µì‹: (ë‚´ì ìˆ˜ / ë§Œì ) * ë°˜ì˜ë¹„ìœ¨
                    totalConverted += (score / item.maxScore) * item.ratio;
                } else {
                    // ì ìˆ˜ê°€ ì…ë ¥ë˜ì§€ ì•Šì€ í•­ëª©ì€ 'ë‚¨ì€ ì‹œí—˜'ìœ¼ë¡œ ë¶„ë¥˜
                    remainingItems.push(item);
                }
                totalRatio += item.ratio;
            });

            // ë“±ê¸‰ ì‚°ì¶œ (ì†Œìˆ˜ì  1ìë¦¬ ë°˜ì˜¬ë¦¼)
            const finalScore = totalConverted.toFixed(1);
            let grade = "E";
            if (finalScore >= 90) grade = "A";
            else if (finalScore >= 80) grade = "B";
            else if (finalScore >= 70) grade = "C";
            else if (finalScore >= 60) grade = "D";

            document.getElementById('currentScore').innerText = finalScore;
            document.getElementById('currentGrade').innerText = grade;

            // ì‹œë®¬ë ˆì´ì…˜: Aë“±ê¸‰(90ì ) ê¹Œì§€ ë‚¨ì€ ì ìˆ˜ ê³„ì‚°
            const targetScore = 90;
            const gap = targetScore - totalConverted;
            const simBox = document.getElementById('simulationResult');

            if (gap <= 0) {
                simBox.innerText = "ğŸ‰ ì´ë¯¸ Aë“±ê¸‰ ê¸°ì¤€ì„ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!";
                simBox.style.color = "green";
            } else if (remainingItems.length === 0) {
                simBox.innerText = "ëª¨ë“  ì‹œí—˜ì´ ëë‚¬ìŠµë‹ˆë‹¤. ìµœì¢… ë“±ê¸‰ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.";
                simBox.style.color = "black";
            } else {
                // ë‚¨ì€ í•­ëª©ì´ í•˜ë‚˜ì¼ ë•Œ êµ¬ì²´ì ì¸ ì ìˆ˜ ì œì‹œ (ê°€ì¥ í”í•œ ì¼€ì´ìŠ¤)
                if (remainingItems.length === 1) {
                    const item = remainingItems[0];
                    // ê³µì‹ ì—­ì‚°: (í•„ìš”ì ìˆ˜ / ë§Œì  * ë¹„ìœ¨) = ë¶€ì¡±í•œì ìˆ˜
                    // í•„ìš”ì ìˆ˜ = (ë¶€ì¡±í•œì ìˆ˜ * ë§Œì ) / ë¹„ìœ¨
                    const requiredRawScore = (gap * item.maxScore) / item.ratio;
                    
                    if (requiredRawScore > item.maxScore) {
                        simBox.innerText = `ğŸ˜“ ë‚¨ì€ ${item.name}ì—ì„œ ë§Œì ì„ ë°›ì•„ë„ Aë“±ê¸‰ì€ ì–´ë µìŠµë‹ˆë‹¤. (ìµœëŒ€ ${item.maxScore}ì )`;
                    } else {
                        simBox.innerText = `ğŸ’¡ íŒ: ë‚¨ì€ '${item.name}'ì—ì„œ ${Math.ceil(requiredRawScore)}ì  ì´ìƒ ë°›ìœ¼ë©´ Aë“±ê¸‰ ê°€ëŠ¥!`;
                    }
                } else {
                    // ë‚¨ì€ í•­ëª©ì´ ì—¬ëŸ¬ ê°œì¼ ë•Œ
                    simBox.innerText = `ğŸ’¡ Aë“±ê¸‰ê¹Œì§€ í™˜ì‚°ì ìˆ˜ ${gap.toFixed(1)}ì ì´ ë” í•„ìš”í•©ë‹ˆë‹¤. ë‚¨ì€ ì‹œí—˜ì—ì„œ í˜ë‚´ì„¸ìš”!`;
                }
            }
        }
        
        // ì´ˆê¸° ì‹¤í–‰
        loadSubjects();
    </script>
</body>
</html>
