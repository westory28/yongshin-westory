<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ ì„±ì  ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f5f7fa; margin: 0; padding: 0; color: #333; }
        
        /* í—¤ë” */
        .brand-header {
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .brand-logo { font-size: 18px; font-weight: bold; color: #2c3e50; display: flex; align-items: center; gap: 8px; }
        
        .container { max-width: 1100px; margin: 0 auto; padding: 30px 20px; }

        /* íƒ€ì´í‹€ ì˜ì—­ */
        .page-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #333; padding-bottom: 15px; }
        .page-title { font-size: 24px; font-weight: 700; color: #111; margin: 0; }
        .btn-logout { background-color: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        
        /* ê²½ê³  ë°•ìŠ¤ (ìš”ì²­í•˜ì‹  ë¬¸êµ¬ ë³µêµ¬) */
        .alert-box { 
            background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;
            padding: 15px; border-radius: 6px; margin-bottom: 25px; 
            font-size: 14px; font-weight: bold; text-align: center; line-height: 1.6;
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ (í•„í„°) */
        .control-panel {
            background-color: #fff; border-radius: 8px; padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px;
            display: flex; gap: 15px; flex-wrap: wrap; align-items: center;
        }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-label { font-size: 14px; font-weight: bold; color: #555; }
        select { 
            padding: 8px 12px; font-size: 14px; border: 1px solid #ccc; 
            border-radius: 4px; background: white; cursor: pointer; min-width: 100px;
        }
        select:focus { border-color: #4a90e2; outline: none; }

        /* ëŒ€ì‹œë³´ë“œ ê·¸ë¦¬ë“œ */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 340px; gap: 25px; }
        @media (max-width: 900px) { .dashboard-grid { grid-template-columns: 1fr; } }

        /* ê³¼ëª© ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .subject-card { 
            background: #fff; border-radius: 8px; margin-bottom: 15px; 
            border: 1px solid #e1e4e8; border-left: 5px solid #ccc; 
            transition: all 0.2s;
        }
        .subject-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-2px); }
        
        .card-header { padding: 18px 25px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .subject-name { font-size: 18px; font-weight: 700; color: #222; }
        .score-info { text-align: right; }
        .total-score { font-size: 20px; font-weight: bold; color: #333; }
        .grade-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; color: #fff; margin-left: 8px; vertical-align: middle; }
        .toggle-text { font-size: 12px; color: #999; margin-top: 4px; }

        .card-body { padding: 0 25px 25px 25px; display: none; background-color: #fafbfc; border-top: 1px solid #eee; }
        .card-body.expanded { display: block; }

        /* ì…ë ¥ í¼ */
        .input-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #eee; }
        .input-item:last-child { border-bottom: none; }
        .item-label { font-size: 14px; color: #333; }
        .item-sub { font-size: 12px; color: #888; margin-top: 2px; }
        .type-tag { font-size: 11px; padding: 2px 5px; border-radius: 3px; background: #eee; color: #555; margin-right: 6px; }
        .score-input { width: 70px; padding: 6px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-size: 15px; }

        /* ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” (ì°¨íŠ¸) */
        .chart-panel { 
            background: #fff; padding: 20px; border-radius: 8px; 
            border: 1px solid #e1e4e8; height: fit-content; position: sticky; top: 20px;
        }
        .chart-title { font-size: 16px; font-weight: bold; margin-bottom: 15px; color: #333; border-bottom: 1px solid #eee; padding-bottom: 10px;}
        .chart-wrapper { position: relative; height: 300px; width: 100%; }

        /* â˜… ë“±ê¸‰ ê°€ì´ë“œ ë°” (ë³µêµ¬ë¨) */
        .grade-scale-bar { 
            display: flex; height: 30px; border-radius: 6px; overflow: hidden; margin-top: 20px; 
            font-weight: bold; color: white; text-shadow: 0 1px 1px rgba(0,0,0,0.2); font-size: 11px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .scale-segment { flex: 1; display: flex; justify-content: center; align-items: center; }

        /* ë¡œê·¸ì¸ ì„¹ì…˜ */
        #loginSection { max-width: 400px; margin: 100px auto; text-align: center; background: #fff; padding: 50px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .btn-google { background-color: #fff; color: #444; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 12px; padding: 12px; font-size: 15px; width: 100%; cursor: pointer; border-radius: 4px; margin-top: 20px; transition: background 0.2s; }

        .hidden { display: none !important; }
        
        /* ë“±ê¸‰ ìƒ‰ìƒ */
        .bg-A { background-color: #fa5252; } /* ë¹¨ê°• */
        .bg-B { background-color: #fd7e14; } /* ì£¼í™© */
        .bg-C { background-color: #fab005; } /* ë…¸ë‘ */
        .bg-D { background-color: #51cf66; } /* ì´ˆë¡ */
        .bg-E { background-color: #339af0; } /* íŒŒë‘ */

    </style>
</head>
<body>

    <div id="loginSection">
        <h2 style="margin-bottom:10px;">ì„±ì  ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
        <p style="color:#666; font-size:14px;">í•™êµ êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.</p>
        <button class="btn-google" onclick="loginWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G" width="18">
            Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
        </button>
    </div>

    <div id="appSection" class="hidden">
        <header class="brand-header">
            <div class="brand-logo">ğŸ« ìš©ì‹ ì¤‘í•™êµ</div>
            <div id="userName" style="font-size:14px; color:#555;"></div>
        </header>

        <div class="container">
            <div class="page-header">
                <h1 class="page-title">ë‚˜ì˜ ì„±ì í‘œ</h1>
                <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <div class="alert-box">
                âš ï¸ ì´ ê²°ê³¼ëŠ” ì°¸ê³ ìš© ì‹œë®¬ë ˆì´ì…˜ì´ë©°, ì •í™•í•œ ì„±ì ì€ <u>ë‚˜ì´ìŠ¤(NEIS)</u> ë° <u>ì„±ì  í†µì§€í‘œ</u>ë¥¼ í™•ì¸í•˜ì„¸ìš”.<br>
                <span style="font-size:12px; font-weight:normal; color:#664d03;">(ì…ë ¥í•œ ì ìˆ˜ëŠ” ì„œë²„ì— ì €ì¥ë˜ì§€ ì•Šê³  ë‚´ ì»´í“¨í„°ì—ë§Œ ì„ì‹œë¡œ ë‚¨ìŠµë‹ˆë‹¤.)</span>
            </div>

            <div class="control-panel">
                <div class="filter-group">
                    <span class="filter-label">í•™ë…„</span>
                    <select id="gradeFilter" onchange="renderDashboard()">
                        <option value="1">1í•™ë…„</option>
                        <option value="2">2í•™ë…„</option>
                        <option value="3">3í•™ë…„</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">ì—°ë„</span>
                    <select id="yearFilter" onchange="renderDashboard()">
                        <option value="2025">2025í•™ë…„ë„</option>
                        <option value="2026">2026í•™ë…„ë„</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">í•™ê¸°</span>
                    <select id="semesterFilter" onchange="renderDashboard()">
                        <option value="1í•™ê¸°">1í•™ê¸°</option>
                        <option value="2í•™ê¸°">2í•™ê¸°</option>
                    </select>
                </div>
                <div class="filter-group" style="margin-left:auto;">
                    <span class="filter-label">ì •ë ¬</span>
                    <select id="sortFilter" onchange="renderDashboard()">
                        <option value="default">êµê³¼í‘œ ìˆœì„œ (êµ­ì˜ìˆ˜...)</option>
                        <option value="score_high">ì„±ì  ë†’ì€ ìˆœ</option>
                        <option value="name">ê°€ë‚˜ë‹¤ ìˆœ</option>
                    </select>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="left-content">
                    <div id="subjectsList">
                        </div>
                </div>

                <div class="right-sidebar">
                    <div class="chart-panel">
                        <div class="chart-title">ì„±ì·¨ë„ ê·¸ë˜í”„</div>
                        <div class="chart-wrapper">
                            <canvas id="gradeChart"></canvas>
                        </div>
                        <div class="grade-scale-bar">
                            <div class="scale-segment bg-A">A (90~)</div>
                            <div class="scale-segment bg-B">B (80~)</div>
                            <div class="scale-segment bg-C">C (70~)</div>
                            <div class="scale-segment bg-D">D (60~)</div>
                            <div class="scale-segment bg-E">E (~59)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // Firebase ì„¤ì •
        const firebaseConfig = {
          apiKey: "AIzaSyAOlPQ5PFmL0zxmGrGcuEBnqBXisph7kPU",
          authDomain: "history-quiz-yongsin.firebaseapp.com",
          projectId: "history-quiz-yongsin",
          storageBucket: "history-quiz-yongsin.firebasestorage.app",
          messagingSenderId: "177587430482",
          appId: "1:177587430482:web:1188e0f661368040c3ab8b",
          measurementId: "G-YG2SLS45D8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let allGradingPlans = [];
        let myChart = null;

        const FIXED_SUBJECT_ORDER = ['êµ­ì–´', 'ì˜ì–´', 'ìˆ˜í•™', 'ê³¼í•™', 'ì—­ì‚¬', 'ê¸°ê°€', 'í•œë¬¸', 'ì¼ë³¸ì–´', 'ë¯¸ìˆ ', 'ì²´ìœ¡'];

        function getGradeInfo(score) {
            if (score >= 90) return { grade: 'A', colorCode: '#fa5252', class: 'bg-A' };
            if (score >= 80) return { grade: 'B', colorCode: '#fd7e14', class: 'bg-B' };
            if (score >= 70) return { grade: 'C', colorCode: '#fab005', class: 'bg-C' };
            if (score >= 60) return { grade: 'D', colorCode: '#51cf66', class: 'bg-D' };
            return { grade: 'E', colorCode: '#339af0', class: 'bg-E' };
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('appSection').classList.remove('hidden');
                document.getElementById('userName').innerText = `${user.displayName} í•™ìƒ`;
                loadAllData();
            } else {
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('appSection').classList.add('hidden');
            }
        });

        window.loginWithGoogle = async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (e) { alert("ë¡œê·¸ì¸ ì‹¤íŒ¨"); } };
        window.logout = async () => { if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await signOut(auth); location.reload(); } };

        async function loadAllData() {
            try {
                const q = query(collection(db, "grading_plans"), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);
                allGradingPlans = [];
                snapshot.forEach(doc => allGradingPlans.push({ id: doc.id, ...doc.data() }));
                renderDashboard();
            } catch (e) { console.error(e); }
        }

        window.toggleCard = (header) => {
            const body = header.nextElementSibling;
            const hint = header.querySelector('.toggle-text');
            if (body.classList.contains('expanded')) {
                body.classList.remove('expanded');
                hint.innerText = 'â–¼ ì ìˆ˜ ì…ë ¥í•˜ê¸°';
            } else {
                body.classList.add('expanded');
                hint.innerText = 'â–² ì ‘ê¸°';
            }
        };

        function calculateTotal(plan) {
            let total = 0;
            plan.items.forEach((item, idx) => {
                const saved = parseFloat(localStorage.getItem(`score_${plan.id}_${idx}`));
                if(!isNaN(saved)) total += (saved / item.maxScore) * item.ratio;
            });
            return parseFloat(total.toFixed(1));
        }

        window.renderDashboard = () => {
            const gradeFilter = document.getElementById('gradeFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const semesterFilter = document.getElementById('semesterFilter').value;
            const sortMode = document.getElementById('sortFilter').value;
            
            const container = document.getElementById('subjectsList');
            container.innerHTML = '';

            let filteredPlans = allGradingPlans.filter(plan => {
                const pGrade = plan.targetGrade || "2"; 
                const pYear = plan.academicYear || "2025";
                const pSem = plan.semester || "1í•™ê¸°";
                return String(pGrade) === gradeFilter && pYear === yearFilter && pSem === semesterFilter;
            });

            filteredPlans = filteredPlans.map(plan => ({
                ...plan,
                currentScore: calculateTotal(plan)
            }));

            if (sortMode === 'score_high') {
                filteredPlans.sort((a, b) => b.currentScore - a.currentScore);
            } else if (sortMode === 'name') {
                filteredPlans.sort((a, b) => a.subject.localeCompare(b.subject));
            } else {
                filteredPlans.sort((a, b) => {
                    let idxA = FIXED_SUBJECT_ORDER.indexOf(a.subject);
                    let idxB = FIXED_SUBJECT_ORDER.indexOf(b.subject);
                    if(idxA === -1) idxA = 999; 
                    if(idxB === -1) idxB = 999;
                    return idxA - idxB;
                });
            }

            if (filteredPlans.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:50px; color:#888; background:#fff; border-radius:8px; border:1px solid #eee;">
                    í•´ë‹¹ í•™ê¸°(${gradeFilter}í•™ë…„ ${yearFilter} ${semesterFilter})ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                updateChart([], [], []);
                return;
            }

            const chartLabels = []; const chartData = []; const chartColors = [];

            filteredPlans.forEach(plan => {
                const currentScore = plan.currentScore;
                const { grade, colorCode, class: bgClass } = getGradeInfo(currentScore);

                chartLabels.push(plan.subject);
                chartData.push(currentScore);
                chartColors.push(colorCode);

                const card = document.createElement('div');
                card.className = 'subject-card';
                card.style.borderLeftColor = colorCode;

                let itemsHtml = '';
                plan.items.forEach((item, idx) => {
                    const savedVal = localStorage.getItem(`score_${plan.id}_${idx}`) || "";
                    itemsHtml += `
                        <div class="input-item">
                            <div>
                                <div class="item-label">
                                    <span class="type-tag">${item.type}</span>${item.name}
                                </div>
                                <div class="item-sub">${item.maxScore}ì  ë§Œì  / ${item.ratio}% ë°˜ì˜</div>
                            </div>
                            <input type="number" class="score-input" 
                                data-planid="${plan.id}" data-idx="${idx}" data-max="${item.maxScore}" 
                                value="${savedVal}" placeholder="0" onclick="event.stopPropagation()">
                        </div>
                    `;
                });

                card.innerHTML = `
                    <div class="card-header" onclick="toggleCard(this)">
                        <div class="subject-name">${plan.subject}</div>
                        <div class="score-info">
                            <span class="total-score" id="score_text_${plan.id}" style="color:${colorCode}">${currentScore}ì </span>
                            <span class="grade-badge ${bgClass}" id="grade_badge_${plan.id}">${grade}</span>
                            <div class="toggle-text">â–¼ ì ìˆ˜ ì…ë ¥í•˜ê¸°</div>
                        </div>
                    </div>
                    <div class="card-body">${itemsHtml}</div>
                `;
                container.appendChild(card);
            });

            document.querySelectorAll('.score-input').forEach(input => input.addEventListener('input', handleInput));
            updateChart(chartLabels, chartData, chartColors);
        };

        function handleInput(e) {
            const planId = e.target.dataset.planid;
            const idx = e.target.dataset.idx;
            const max = parseFloat(e.target.dataset.max);
            let val = parseFloat(e.target.value);

            if(val > max) { val = max; e.target.value = max; }
            if(val < 0) { val = 0; e.target.value = 0; }

            localStorage.setItem(`score_${planId}_${idx}`, e.target.value);
            updateCardUI(planId);
        }

        function updateCardUI(planId) {
            const plan = allGradingPlans.find(p => p.id === planId);
            if(!plan) return;

            const total = calculateTotal(plan);
            const { grade, colorCode, class: bgClass } = getGradeInfo(total);

            const textEl = document.getElementById(`score_text_${planId}`);
            const badgeEl = document.getElementById(`grade_badge_${planId}`);
            
            textEl.innerText = `${total}ì `;
            textEl.style.color = colorCode;
            badgeEl.innerText = grade;
            badgeEl.className = `grade-badge ${bgClass}`;
            badgeEl.closest('.subject-card').style.borderLeftColor = colorCode;

            if(myChart) {
                const idx = myChart.data.labels.indexOf(plan.subject);
                if(idx !== -1) {
                    myChart.data.datasets[0].data[idx] = total;
                    myChart.data.datasets[0].backgroundColor[idx] = colorCode;
                    myChart.update();
                }
            }
        }

        function updateChart(labels, data, colors) {
            const ctx = document.getElementById('gradeChart').getContext('2d');
            if(myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'í™˜ì‚° ì ìˆ˜',
                        data: data,
                        backgroundColor: colors,
                        borderRadius: 4,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, max: 100 },
                        x: { ticks: { font: { size: 12 } } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
    </script>
</body>
</html>
