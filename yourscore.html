<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ì˜ ì„±ì  ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; color: #333; }
        
        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        .navbar { background: #fff; padding: 15px 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 1001; }
        .navbar h1 { margin: 0; font-size: 18px; color: #2c3e50; }
        .btn-logout { background-color: #95a5a6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* ë¡œê·¸ì¸ ì„¹ì…˜ */
        #loginSection { max-width: 400px; margin: 80px auto; text-align: center; background: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-google { background-color: #fff; color: #444; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 12px; padding: 15px; font-size: 16px; width: 100%; cursor: pointer; border-radius: 6px; margin-top: 20px; transition: background 0.2s; }
        .btn-google:hover { background-color: #f8f9fa; }

        /* ë©”ì¸ ëŒ€ì‹œë³´ë“œ ë ˆì´ì•„ì›ƒ (PC: Flex Row, Mobile: Column) */
        .dashboard-layout { display: flex; flex-direction: column; gap: 20px; }
        
        /* ì™¼ìª½: ê³¼ëª© ë¦¬ìŠ¤íŠ¸ */
        .subjects-section { flex: 1; order: 2; }
        
        /* ì˜¤ë¥¸ìª½: ì°¨íŠ¸ (ëª¨ë°”ì¼ì—ì„  ìƒë‹¨ ê³ ì •) */
        .chart-section { 
            order: 1; 
            background: #fff; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            padding: 15px; 
            position: sticky; 
            top: 0; 
            z-index: 999; 
            /* ëª¨ë°”ì¼ sticky ë°°ê²½ìƒ‰ í•„ìˆ˜ */
            background-color: #f0f2f5; 
            padding-bottom: 10px;
        }
        
        /* ì°¨íŠ¸ ë‚´ë¶€ ì»¨í…Œì´ë„ˆ (í°ìƒ‰ ë°•ìŠ¤) */
        .chart-inner {
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* PC ë²„ì „ ë¯¸ë””ì–´ ì¿¼ë¦¬ */
        @media (min-width: 900px) {
            .dashboard-layout { flex-direction: row; align-items: flex-start; }
            .subjects-section { flex: 1; order: 1; } /* ì™¼ìª½ */
            .chart-section { 
                flex: 0 0 400px; /* ì˜¤ë¥¸ìª½ ê³ ì • ë„ˆë¹„ */
                order: 2; 
                position: sticky; 
                top: 20px; 
                background: transparent; /* PCì—ì„  ë°°ê²½ íˆ¬ëª… */
                padding: 0;
                box-shadow: none;
            }
            .chart-inner { height: auto; min-height: 400px; }
        }

        /* í•„í„° ë°” */
        .filter-bar { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .filter-bar select { padding: 8px; border: 1px solid #ddd; border-radius: 6px; }

        /* ì°¨íŠ¸ ì˜ì—­ */
        .chart-container { 
            position: relative; 
            height: 250px; 
            width: 100%; 
            overflow-x: auto; /* ê°€ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
            overflow-y: hidden;
        }
        .chart-scroll-wrapper {
            min-width: 100%; /* ê¸°ë³¸ 100% */
            height: 100%;
        }

        /* ë“±ê¸‰ ê¸°ì¤€í‘œ ë§‰ëŒ€ */
        .grade-scale-bar { display: flex; height: 30px; border-radius: 15px; overflow: hidden; margin-top: 15px; font-weight: bold; color: white; text-shadow: 0 1px 1px rgba(0,0,0,0.3); font-size: 11px; }
        .scale-segment { flex: 1; display: flex; justify-content: center; align-items: center; }
        .bg-A { background-color: #28a745; } .bg-B { background-color: #82c91e; }
        .bg-C { background-color: #fab005; } .bg-D { background-color: #fd7e14; } .bg-E { background-color: #fa5252; }

        /* ê³¼ëª© ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .subject-card { 
            background: #fff; border-radius: 12px; margin-bottom: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            border-left: 6px solid #ddd; /* ì™¼ìª½ í…Œë‘ë¦¬ë¡œ í¬ì¸íŠ¸ ë³€ê²½ */
            cursor: pointer; /* í´ë¦­ ê°€ëŠ¥ í‘œì‹œ */
            overflow: hidden;
            transition: transform 0.2s;
        }
        .subject-card:hover { transform: translateY(-2px); }

        /* ì¹´ë“œ í—¤ë” (í•­ìƒ ë³´ì„) */
        .card-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .subject-name { font-size: 16px; font-weight: bold; color: #333; }
        .subject-score-area { text-align: right; }
        .total-score { font-size: 20px; font-weight: bold; margin-right: 5px; }
        .grade-pill { display: inline-block; width: 28px; height: 28px; line-height: 28px; border-radius: 50%; text-align: center; color: white; font-weight: bold; font-size: 14px; }
        .toggle-icon { font-size: 12px; color: #999; margin-left: 10px; transition: transform 0.3s; }

        /* ì¹´ë“œ ë°”ë”” (í´ë¦­ ì‹œ ë³´ì„) */
        .card-body { 
            padding: 0 15px 15px 15px; 
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            background-color: #fafafa;
            border-top: 1px solid #eee;
        }
        .card-body.expanded { display: block; animation: slideDown 0.3s ease-out; }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .input-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .input-row:last-child { border-bottom: none; }
        .item-name { font-size: 14px; margin-bottom: 2px; }
        .item-meta { font-size: 11px; color: #888; }
        .score-input { width: 50px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; text-align: center; font-size: 16px; background: #fff; }
        
        .badge { padding: 2px 5px; border-radius: 3px; font-size: 10px; color: white; margin-right: 4px; vertical-align: middle;}
        .b-ji { background: #e74c3c; } .b-su { background: #3498db; }

        .hidden { display: none !important; }
        .alert-box { background: #fff3cd; color: #856404; padding: 10px; border-radius: 6px; margin-bottom: 10px; text-align: center; font-size: 12px; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

    <div id="loginSection">
        <h2>ğŸ” í•™ìƒ ì„±ì  ëŒ€ì‹œë³´ë“œ</h2>
        <p>êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì—¬<br>ë‚˜ì˜ ì„±ì ì„ ê´€ë¦¬í•˜ì„¸ìš”.</p>
        <button class="btn-google" onclick="loginWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G" width="20">
            Google ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
        </button>
    </div>

    <div id="appSection" class="hidden">
        <div class="navbar">
            <h1>ğŸ“Š ì„±ì  ëŒ€ì‹œë³´ë“œ</h1>
            <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div class="container">
            <div class="dashboard-layout">
                
                <div class="chart-section">
                    <div class="chart-inner">
                        <div class="filter-bar">
                            <select id="yearFilter" onchange="renderDashboard()">
                                <option value="2025">2025í•™ë…„ë„</option>
                                <option value="2026">2026í•™ë…„ë„</option>
                                <option value="2027">2027í•™ë…„ë„</option>
                            </select>
                            <select id="semesterFilter" onchange="renderDashboard()">
                                <option value="1í•™ê¸°">1í•™ê¸°</option>
                                <option value="2í•™ê¸°">2í•™ê¸°</option>
                            </select>
                        </div>

                        <div class="chart-container">
                            <div class="chart-scroll-wrapper">
                                <canvas id="gradeChart"></canvas>
                            </div>
                        </div>

                        <div class="grade-scale-bar">
                            <div class="scale-segment bg-E">E</div>
                            <div class="scale-segment bg-D">D</div>
                            <div class="scale-segment bg-C">C</div>
                            <div class="scale-segment bg-B">B</div>
                            <div class="scale-segment bg-A">A</div>
                        </div>
                    </div>
                </div>

                <div class="subjects-section">
                    <div class="alert-box">
                        âš ï¸ ê²°ê³¼ëŠ” ì‹œë®¬ë ˆì´ì…˜ì´ë©°, ì‹¤ì œ ì„±ì ì€ ë‚˜ì´ìŠ¤(NEIS)ì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </div>
                    <div id="subjectsList">
                        </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAOlPQ5PFmL0zxmGrGcuEBnqBXisph7kPU",
          authDomain: "history-quiz-yongsin.firebaseapp.com",
          projectId: "history-quiz-yongsin",
          storageBucket: "history-quiz-yongsin.firebasestorage.app",
          messagingSenderId: "177587430482",
          appId: "1:177587430482:web:1188e0f661368040c3ab8b",
          measurementId: "G-YG2SLS45D8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let allGradingPlans = [];
        let myChart = null;

        const gradeColors = {
            A: '#28a745', B: '#82c91e', C: '#fab005', D: '#fd7e14', E: '#fa5252'
        };

        function getGradeInfo(score) {
            if (score >= 90) return { grade: 'A', color: gradeColors.A };
            if (score >= 80) return { grade: 'B', color: gradeColors.B };
            if (score >= 70) return { grade: 'C', color: gradeColors.C };
            if (score >= 60) return { grade: 'D', color: gradeColors.D };
            return { grade: 'E', color: gradeColors.E };
        }

        // ë¡œê·¸ì¸ ë¡œì§
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const q = query(collection(db, "users"), where("email", "==", user.email));
                const snap = await getDocs(q);
                if (!snap.empty) {
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('appSection').classList.remove('hidden');
                    loadAllData();
                } else {
                    alert("ë“±ë¡ëœ í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."); signOut(auth);
                }
            } else {
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('appSection').classList.add('hidden');
            }
        });

        window.loginWithGoogle = async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (e) { console.error(e); alert("ë¡œê·¸ì¸ ì‹¤íŒ¨"); } };
        window.logout = async () => { if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await signOut(auth); location.reload(); } };

        async function loadAllData() {
            try {
                const q = query(collection(db, "grading_plans"), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);
                allGradingPlans = [];
                snapshot.forEach(doc => allGradingPlans.push({ id: doc.id, ...doc.data() }));
                renderDashboard();
            } catch (e) { console.error(e); }
        }

        // ì¹´ë“œ í† ê¸€ í•¨ìˆ˜ (ì•„ì½”ë””ì–¸)
        window.toggleCard = (cardHeader) => {
            const body = cardHeader.nextElementSibling;
            const icon = cardHeader.querySelector('.toggle-icon');
            
            if (body.classList.contains('expanded')) {
                body.classList.remove('expanded');
                icon.innerText = 'â–¼ ì…ë ¥í•˜ê¸°';
            } else {
                // ë‹¤ë¥¸ ì—´ë¦° ì¹´ë“œ ë‹«ê¸° (ì„ íƒì‚¬í•­ - ì—¬ê¸°ì„  ë‹¤ì¤‘ ì˜¤í”ˆ í—ˆìš©)
                // document.querySelectorAll('.card-body').forEach(b => b.classList.remove('expanded'));
                
                body.classList.add('expanded');
                icon.innerText = 'â–² ì ‘ê¸°';
            }
        };

        window.renderDashboard = () => {
            const year = document.getElementById('yearFilter').value;
            const semester = document.getElementById('semesterFilter').value;
            const container = document.getElementById('subjectsList');
            container.innerHTML = '';

            const filteredPlans = allGradingPlans.filter(plan => {
                const planYear = plan.academicYear || "2025";
                const planSem = plan.semester || "1í•™ê¸°";
                return planYear === year && planSem === semester;
            });

            if (filteredPlans.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#888;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                updateChart([], [], []); return;
            }

            const chartLabels = []; const chartData = []; const chartColors = [];

            filteredPlans.forEach(plan => {
                const card = document.createElement('div');
                card.className = 'subject-card';
                let inputHtml = ''; let totalScore = 0;

                plan.items.forEach((item, idx) => {
                    const savedScore = localStorage.getItem(`score_${plan.id}_${idx}`) || "";
                    const badgeClass = item.type === 'ì§€í•„' ? 'b-ji' : 'b-su';
                    const scoreVal = parseFloat(savedScore);
                    if(!isNaN(scoreVal)) totalScore += (scoreVal / item.maxScore) * item.ratio;

                    inputHtml += `
                        <div class="input-row">
                            <div class="item-info">
                                <div class="item-name"><span class="badge ${badgeClass}">${item.type}</span>${item.name}</div>
                                <div class="item-meta">${item.maxScore}ì  ë§Œì  / ${item.ratio}% ë°˜ì˜</div>
                            </div>
                            <input type="number" class="score-input" data-docid="${plan.id}" data-idx="${idx}" data-max="${item.maxScore}" value="${savedScore}" placeholder="ì ìˆ˜" onclick="event.stopPropagation()">
                        </div>`;
                });

                const finalScore = totalScore.toFixed(1);
                const { grade, color } = getGradeInfo(finalScore);

                chartLabels.push(plan.subject);
                chartData.push(finalScore);
                chartColors.push(color);

                card.style.borderLeftColor = color;
                // ì¹´ë“œ í—¤ë”ì— onclick ì´ë²¤íŠ¸ ì¶”ê°€ (ì…ë ¥ì°½ ì—´ê¸°/ë‹«ê¸°)
                card.innerHTML = `
                    <div class="card-header" onclick="toggleCard(this)">
                        <div class="subject-name">${plan.subject}</div>
                        <div class="subject-score-area" style="display:flex; align-items:center;">
                            <span class="total-score" id="total_${plan.id}" style="color:${color}">${finalScore}</span>
                            <span class="grade-pill" id="grade_${plan.id}" style="background-color:${color}">${grade}</span>
                            <span class="toggle-icon">â–¼ ì…ë ¥í•˜ê¸°</span>
                        </div>
                    </div>
                    <div class="card-body">
                        ${inputHtml}
                    </div>
                `;
                container.appendChild(card);
            });

            document.querySelectorAll('.score-input').forEach(input => input.addEventListener('input', handleInput));
            
            // ë°ì´í„° ê°œìˆ˜ì— ë”°ë¼ ì°¨íŠ¸ ë„ˆë¹„ ì¡°ì • (ìŠ¤ì™€ì´í”„ ê°€ëŠ¥í•˜ê²Œ)
            const wrapper = document.querySelector('.chart-scroll-wrapper');
            if (filteredPlans.length > 5) {
                wrapper.style.width = `${filteredPlans.length * 60}px`; // í•­ëª©ë‹¹ 60px í™•ë³´
            } else {
                wrapper.style.width = '100%';
            }

            updateChart(chartLabels, chartData, chartColors);
        };

        function handleInput(e) {
            const docId = e.target.dataset.docid;
            const idx = e.target.dataset.idx;
            const max = parseFloat(e.target.dataset.max);
            let val = e.target.value;
            if(val > max) { val = max; e.target.value = max; }
            localStorage.setItem(`score_${docId}_${idx}`, val);
            updateCardScore(docId);
        }

        function updateCardScore(docId) {
            const plan = allGradingPlans.find(p => p.id === docId);
            if(!plan) return;
            let total = 0;
            plan.items.forEach((item, i) => {
                const val = parseFloat(localStorage.getItem(`score_${docId}_${i}`));
                if(!isNaN(val)) total += (val / item.maxScore) * item.ratio;
            });

            const final = total.toFixed(1);
            const { grade, color } = getGradeInfo(final);

            const scoreSpan = document.getElementById(`total_${docId}`);
            scoreSpan.innerText = final;
            scoreSpan.style.color = color;
            
            const badge = document.getElementById(`grade_${docId}`);
            badge.innerText = grade;
            badge.style.backgroundColor = color;
            badge.closest('.subject-card').style.borderLeftColor = color;

            // ì°¨íŠ¸ ê°’ë§Œ ê°±ì‹  (ì „ì²´ ë¦¬ë Œë”ë§ ë°©ì§€)
            if(myChart) {
                const dataIndex = myChart.data.labels.indexOf(plan.subject);
                if(dataIndex !== -1) {
                    myChart.data.datasets[0].data[dataIndex] = final;
                    myChart.data.datasets[0].backgroundColor[dataIndex] = color;
                    myChart.update();
                }
            }
        }

        function updateChart(labels, data, colors) {
            const ctx = document.getElementById('gradeChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'í™˜ì‚° ì ìˆ˜', data: data, backgroundColor: colors, borderWidth: 1, borderRadius: 5 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { 
                        y: { beginAtZero: true, max: 100, ticks: {font:{size:10}} },
                        x: { ticks: {font:{size:11}} }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
    </script>
</body>
</html>
