<script>
        const firebaseConfig = { apiKey: "AIzaSyAOlPQ5PFmL0zxmGrGcuEBnqBXisph7kPU", authDomain: "history-quiz-yongsin.firebaseapp.com", projectId: "history-quiz-yongsin", storageBucket: "history-quiz-yongsin.firebasestorage.app", messagingSenderId: "177587430482", appId: "1:177587430482:web:d79cc145c11e335cc3ab8b", measurementId: "G-LHN97D7R2R" };
        
        let db; 
        try { 
            if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); } 
            db = firebase.firestore(); 
        } catch(e) { 
            console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", e);
            alert("ì‹œìŠ¤í…œ ì˜¤ë¥˜: ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”. (Firebase Init Fail)"); 
        }

        const app = {
            state: { student:{}, questions:[], allQuestions:[], currentIndex:0, answers:{}, score:0, timer:null, timeLeft:60, isTimeOut:false, isQuizActive: false },
            
            init: function() { }, // ì´ˆê¸°í™” ì‹œ ìë™ ì‹¤í–‰ ì—†ìŒ

            showLoading: function(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; },

            startQuiz: async function() {
                const cls = document.getElementById('input-class').value;
                const num = document.getElementById('input-number').value;
                const name = document.getElementById('input-name').value.trim();

                if(!cls || !num || !name) { alert("ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”."); return; }
                
                this.showLoading(true);

                try {
                    // [ë¶€ì •í–‰ìœ„ ë°©ì§€] 10ë¶„ ë‚´ ì¬ì‘ì‹œ ì²´í¬
                    const logsRef = db.collection("quiz_results");
                    const snapshot = await logsRef
                        .where("class", "==", cls)
                        .where("number", "==", num)
                        .where("name", "==", name)
                        .orderBy("timestamp", "desc")
                        .limit(1)
                        .get();

                    if (!snapshot.empty) {
                        const lastDoc = snapshot.docs[0].data();
                        if (lastDoc.timestamp) {
                            const lastTime = lastDoc.timestamp.toDate();
                            const now = new Date();
                            const diffMins = (now - lastTime) / (1000 * 60);

                            if (diffMins < 10) {
                                this.showLoading(false);
                                alert(`â›” ì¬ì‘ì‹œ ë¶ˆê°€!\n\n${Math.ceil(10 - diffMins)}ë¶„ ë’¤ì— ë‹¤ì‹œ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                                return; 
                            }
                        }
                    }

                    // [ë¬¸ì œ ë¡œë“œ]
                    await this.loadRandomQuestions();

                    // ë¬¸ì œê°€ í•˜ë‚˜ë„ ì•ˆ ë½‘í˜”ì„ ê²½ìš° (ì•ˆì „ì¥ì¹˜)
                    if(!this.state.allQuestions || this.state.allQuestions.length === 0) {
                        throw new Error("ë¡œë“œëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.");
                    }

                } catch(e) {
                    console.error("Error Detail:", e);
                    this.showLoading(false);
                    // êµ¬ì²´ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ ì¶œë ¥
                    if (e.code === 'permission-denied') {
                        alert("ì˜¤ë¥˜: ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ê·œì¹™ ì„¤ì • í™•ì¸ í•„ìš”)");
                    } else {
                        alert("ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n" + e.message);
                    }
                    return;
                }

                // í€´ì¦ˆ ì‹œì‘ ì„¸íŒ…
                this.state.student = { class:cls, number:num, name:name };
                this.state.questions = this.state.allQuestions; 
                this.state.currentIndex = 0; 
                this.state.answers = {}; 
                this.state.score = 0; 
                this.state.timeLeft = 60; 
                this.state.isTimeOut = false; 
                this.state.isQuizActive = true; 
                
                this.showLoading(false);
                this.showView('view-quiz'); 
                this.renderQuestion(); 
                this.startTimer();
            },

            loadRandomQuestions: async function() {
                if(!db) return;
                
                let totalCount = 132; // [ì•ˆì „ì¥ì¹˜] ë©”íƒ€ë°ì´í„° ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ 132 ì‚¬ìš©

                try {
                    const metaDoc = await db.collection("metadata").doc("count_info").get();
                    if (metaDoc.exists) {
                        totalCount = metaDoc.data().total_questions || 132;
                    } else {
                        console.warn("âš ï¸ ë©”íƒ€ë°ì´í„° ì—†ìŒ. ê¸°ë³¸ê°’(132)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.");
                    }
                } catch(e) {
                    console.warn("âš ï¸ ë©”íƒ€ë°ì´í„° ì½ê¸° ì‹¤íŒ¨. ê¸°ë³¸ê°’(132)ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.", e);
                }
                
                // ëœë¤ ë²ˆí˜¸ 5ê°œ ì¶”ì²¨
                const randomIds = new Set();
                // ì•ˆì „ì¥ì¹˜: ì „ì²´ ë¬¸ì œ ìˆ˜ë³´ë‹¤ ì ê²Œ ë½‘ì•„ì•¼ ë¬´í•œë£¨í”„ ì•ˆ ë”
                const pickCount = Math.min(5, totalCount); 
                
                while(randomIds.size < pickCount) {
                    const rand = Math.floor(Math.random() * totalCount) + 1;
                    randomIds.add(rand.toString());
                }
                const targetIds = Array.from(randomIds);

                // í•´ë‹¹ ë²ˆí˜¸ ë¬¸ì œ ê°€ì ¸ì˜¤ê¸°
                const qSnapshot = await db.collection("quiz_questions")
                    .where(firebase.firestore.FieldPath.documentId(), 'in', targetIds)
                    .get();

                const loadedData = [];
                qSnapshot.forEach((doc) => { 
                    let data = doc.data(); 
                    data.id = parseInt(doc.id); 
                    loadedData.push(data); 
                });

                this.state.allQuestions = this.shuffleArray(loadedData);
            },

            shuffleArray: function(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; },
            
            startTimer: function() { 
                if(this.state.timer) clearInterval(this.state.timer); 
                const bar = document.getElementById('timer-bar'), txt = document.getElementById('timer-text'); 
                bar.style.width='100%'; txt.innerText='60ì´ˆ'; 
                this.state.timer = setInterval(() => { 
                    this.state.timeLeft--; 
                    txt.innerText = this.state.timeLeft + 'ì´ˆ'; 
                    bar.style.width = (this.state.timeLeft/60)*100 + '%'; 
                    if(this.state.timeLeft<=10) { bar.classList.add('timer-urgent'); txt.classList.add('animate-pulse'); } 
                    if(this.state.timeLeft<=0) { clearInterval(this.state.timer); this.state.isTimeOut=true; alert("ì¢…ë£Œ"); this.finishQuiz(); } 
                }, 1000); 
            },

            renderQuestion: function() {
                const q = this.state.questions[this.state.currentIndex];
                this.tempAnswer = this.state.answers[q.id] || null;
                document.getElementById('quiz-progress-text').innerText = `${this.state.currentIndex+1}/${this.state.questions.length}`;
                document.getElementById('question-badge').innerText = {'choice':'ê°ê´€ì‹','blank':'ë‹¨ë‹µ','word':'ë‹¨ë‹µ','order':'ìˆœì„œ','ox':'O/X'}[q.type];
                document.getElementById('student-question-unit').innerText = q.unit || "ê¸°íƒ€";
                const img = document.getElementById('question-image'); 
                if(q.image) { img.src=q.image; img.parentNode.classList.remove('hidden'); } else img.parentNode.classList.add('hidden');
                
                document.getElementById('question-text').innerHTML = this.linkify(q.question);
                
                const area = document.getElementById('answer-area'); area.innerHTML = ''; 
                document.getElementById('btn-prev').classList.toggle('hidden', this.state.currentIndex === 0);
                document.getElementById('btn-next').className = this.state.currentIndex === 0 ? "w-full bg-amber-600 text-white font-bold py-4 rounded-lg hover:bg-amber-700 transition shadow-md" : "w-2/3 bg-amber-600 text-white font-bold py-4 rounded-lg hover:bg-amber-700 transition shadow-md";
                
                if(q.type === 'choice') { 
                    const grid = document.createElement('div'); grid.className="grid grid-cols-1 gap-3"; 
                    q.options.forEach((opt,i) => { 
                        const btn = document.createElement('div'); const isSelected = this.tempAnswer === opt; 
                        btn.className = `choice-btn ${isSelected ? 'selected' : ''}`; 
                        btn.innerHTML = `<span class="choice-badge">${i+1}</span> ${this.linkify(opt)}`; 
                        btn.onclick = () => { this.state.answers[q.id] = opt; this.renderQuestion(); }; 
                        grid.appendChild(btn); 
                    }); area.appendChild(grid); 
                } else if(q.type === 'ox') { 
                    const box = document.createElement('div'); box.className="flex gap-4 h-40"; 
                    const btnO = document.createElement('button'); btnO.className=`flex-1 ox-btn btn-o ${this.tempAnswer==='O'?'selected':''}`; btnO.innerText="O"; btnO.onclick=()=>{ this.state.answers[q.id]='O'; this.renderQuestion(); }; 
                    const btnX = document.createElement('button'); btnX.className=`flex-1 ox-btn btn-x ${this.tempAnswer==='X'?'selected':''}`; btnX.innerText="X"; btnX.onclick=()=>{ this.state.answers[q.id]='X'; this.renderQuestion(); }; 
                    box.append(btnO,btnX); area.appendChild(box); 
                } else if(q.type === 'order') { 
                    this.orderTemp = this.tempAnswer ? this.tempAnswer.split('-') : []; 
                    const box = document.createElement('div'); box.className="border-2 dashed border-amber-300 rounded p-4 mb-3 bg-amber-50 min-h-[50px] flex flex-wrap gap-2"; 
                    const opts = document.createElement('div'); opts.className="flex flex-wrap gap-2"; 
                    this.orderTemp.forEach(opt => { const btn = document.createElement('button'); btn.className="seq-btn seq-btn-selected"; btn.innerText=opt; btn.onclick = () => { this.orderTemp = this.orderTemp.filter(x=>x!==opt); this.state.answers[q.id] = this.orderTemp.join('-'); this.renderQuestion(); }; box.appendChild(btn); }); 
                    q.options.filter(o => !this.orderTemp.includes(o)).forEach(opt => { const btn = document.createElement('button'); btn.className="seq-btn seq-btn-default"; btn.innerText=opt; btn.onclick = () => { this.orderTemp.push(opt); this.state.answers[q.id] = this.orderTemp.join('-'); this.renderQuestion(); }; opts.appendChild(btn); }); 
                    area.append(box, opts); 
                } else { 
                    const inp = document.createElement('input'); inp.type="text"; inp.className="w-full p-4 border-b-2 border-stone-300 focus:border-amber-500 text-center text-lg outline-none"; inp.placeholder="ì •ë‹µ ì…ë ¥"; 
                    if(this.tempAnswer) inp.value = this.tempAnswer; inp.oninput = (e) => { this.tempAnswer=e.target.value; this.state.answers[q.id] = e.target.value; }; inp.onkeydown = (e) => { if(e.key==='Enter') this.submitAnswer(); }; area.appendChild(inp); 
                }
            },

            linkify: function(text) {
                if(!text) return "";
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                return text.replace(urlRegex, function(url) {
                    return '<a href="' + url + '" target="_blank" class="text-blue-600 underline font-bold" onclick="event.stopPropagation()">ë§í¬ ì—´ê¸°</a>';
                });
            },

            prevQuestion: function() { const q = this.state.questions[this.state.currentIndex]; if (this.state.currentIndex > 0) { this.state.currentIndex--; this.renderQuestion(); } },
            
            submitAnswer: function() { const q = this.state.questions[this.state.currentIndex]; let ans = this.state.answers[q.id]; if(q.type==='order') { if(!ans || ans.split('-').length !== q.options.length) { alert("ìˆœì„œë¥¼ ì™„ì„±í•˜ì„¸ìš”"); return; } } else if(!ans) { alert("ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”"); return; } if(this.state.currentIndex < 4) { this.state.currentIndex++; this.renderQuestion(); } else this.finishQuiz(); },
            
            finishQuiz: function() {
                clearInterval(this.state.timer); this.state.isQuizActive = false;
                let correct = 0; let details = []; let detailLogs = [];
                this.state.questions.forEach(q => {
                    const u = (this.state.answers[q.id]||"").toString().replace(/\s+/g,'').trim(); const a = q.answer.toString().replace(/\s+/g,'').trim();
                    let isC = (q.type === 'word' || q.type === 'blank') ? (u.includes(a)||a.includes(u)) : (u === a);
                    if(isC) correct++; else details.push({q:q.question, u:u||"ë¯¸ì…ë ¥", a:q.answer, exp:q.explanation});
                    detailLogs.push({ id: q.id, correct: isC, u: u });
                });
                this.state.score = correct * 20; this.state.incorrectDetails = details;
                this.showView('view-results'); this.renderResults(); this.saveToFirebase(detailLogs);
            },
            
            renderResults: function() { 
                document.getElementById('result-name').innerText = this.state.student.name; 
                document.getElementById('score-text').innerText = this.state.score; 
                const ctx = document.getElementById('scoreChart').getContext('2d'); 
                if(window.myChart) window.myChart.destroy(); 
                window.myChart = new Chart(ctx, { type:'doughnut', data:{labels:['ì •ë‹µ','ì˜¤ë‹µ'], datasets:[{data:[this.state.score, 100-this.state.score], backgroundColor:['#d97706','#e5e7eb'], borderWidth:0}]}, options:{cutout:'80%', plugins:{legend:{display:false}}} }); 
                const list = document.getElementById('review-list'); 
                list.innerHTML = this.state.incorrectDetails.length===0 ? '<div class="text-center py-4">ë§Œì ì…ë‹ˆë‹¤! ğŸ‰</div>' : this.state.incorrectDetails.map(d => `<div class="border-b pb-3 last:border-0"><p class="font-bold text-stone-800 mb-1">Q. ${this.linkify(d.q)}</p><div class="flex gap-2 text-xs mb-2"><span class="text-red-600 bg-red-50 px-2 py-1 rounded">ë‚´ ë‹µ: ${d.u}</span><span class="text-green-600 bg-green-50 px-2 py-1 rounded font-bold">ì •ë‹µ: ${d.a}</span></div><p class="text-xs text-stone-500 bg-stone-50 p-2 rounded">${this.linkify(d.exp)}</p></div>`).join(''); 
            },
            
            saveToFirebase: function(detailLogs = []) {
                const status = document.getElementById('submission-status');
                if(!db) { status.innerHTML = "âš ï¸ DB ì—°ê²° ì‹¤íŒ¨"; return; }
                const data = { timestamp: firebase.firestore.FieldValue.serverTimestamp(), timeString: new Date().toLocaleString(), class: this.state.student.class, number: this.state.student.number, name: this.state.student.name, score: this.state.score, status: this.state.isTimeOut ? "ì‹œê°„ì´ˆê³¼" : "ì™„ë£Œ", details: detailLogs };
                db.collection("quiz_results").add(data).then(() => { status.className = "bg-green-100 text-green-700 p-3 rounded text-sm mb-6 border border-green-200 font-bold"; status.innerHTML = '<i class="fas fa-check-circle"></i> ì œì¶œ ì™„ë£Œ!'; }).catch((error) => { console.error("Error: ", error); status.className = "bg-red-100 text-red-700 p-3 rounded text-sm mb-6 border border-red-200"; status.innerHTML = 'âš ï¸ ì „ì†¡ ì‹¤íŒ¨'; });
            },
            
            showView: function(id) { document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); window.scrollTo(0,0); }
        };
        window.onload = function() { app.init(); };
    </script>
