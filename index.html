<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš©ì‹ ì¤‘í•™êµ ì—­ì‚¬ í‰ê°€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Noto+Serif+KR:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f5f5f4; }
        .serif { font-family: 'Noto Serif KR', serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .timer-bar { transition: width 1s linear; }
        .timer-urgent { background-color: #ef4444 !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .choice-btn { width: 100%; text-align: left; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; background-color: white; transition: all 0.2s; display: flex; align-items: center; cursor: pointer; }
        .choice-btn:hover { background-color: #f5f5f4; }
        .choice-btn.selected { border: 2px solid #d97706; background-color: #fffbeb; color: #92400e; font-weight: bold; }
        .choice-badge { width: 1.5rem; height: 1.5rem; border-radius: 9999px; background-color: #e5e7eb; display: inline-flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold; margin-right: 0.75rem; }
        .choice-btn.selected .choice-badge { background-color: #d97706; color: white; }
        .ox-btn { height: 80px; font-size: 2.5rem; font-weight: 900; border-radius: 12px; transition: all 0.2s; border: 2px solid transparent; width: 100%; cursor: pointer;}
        .ox-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-o { background-color: #e0f2fe; color: #0284c7; border-color: #0284c7; }
        .btn-o.selected { background-color: #0284c7; color: white; border: 2px solid #0c4a6e;}
        .btn-x { background-color: #fee2e2; color: #dc2626; border-color: #dc2626; }
        .btn-x.selected { background-color: #dc2626; color: white; border: 2px solid #7f1d1d;}
        .seq-btn { padding: 8px 12px; border-radius: 6px; font-weight: bold; border: 1px solid #d1d5db; transition: all 0.2s; cursor: pointer; margin: 4px; }
        .seq-btn-default { background-color: #ffffff !important; color: #1f2937 !important; }
        .seq-btn-selected { background-color: #d97706 !important; color: #ffffff !important; border-color: #b45309 !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        .q-image-thumb { max-width: 100%; max-height: 250px; border-radius: 8px; margin: 10px auto; border: 1px solid #e5e7eb; display: block; object-fit: contain; cursor: zoom-in; transition: transform 0.2s; }
        #image-zoom-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; cursor: zoom-out; }
        #image-zoom-content { max-width: 95%; max-height: 95%; border-radius: 4px; }
        .live-badge { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.4); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; }
        .live-dot { width: 8px; height: 8px; background-color: #10b981; border-radius: 50%; box-shadow: 0 0 8px #10b981; animation: pulse-dot 2s infinite; }
        @keyframes pulse-dot { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    </style>
</head>
<body class="text-stone-800 min-h-screen flex flex-col">
    <div id="loading-overlay"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-amber-600 border-solid mb-4"></div><p class="text-xl font-bold text-stone-700" id="loading-text">ë¡œë”© ì¤‘...</p></div>
    <div id="image-zoom-modal" onclick="document.getElementById('image-zoom-modal').style.display='none'"><img id="image-zoom-content" src=""></div>

    <header class="bg-stone-900 text-white py-4 shadow-lg sticky top-0 z-40 cursor-pointer" onclick="app.goHome()">
        <div class="container mx-auto px-4 flex justify-between items-center gap-4">
            <h1 class="text-lg md:text-xl font-bold tracking-tight truncate flex-1"><span class="mr-2">ğŸ§‘â€ğŸ«</span> ìš©ì‹ ì¤‘í•™êµ ì—­ì‚¬êµì‚¬ ë°©ì¬ì„</h1>
            <div class="live-badge"><div class="live-dot"></div><span id="live-count-text">ì´ ë„ì „: ...</span></div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-6">
        <section id="view-login" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg fade-in mt-8 border-t-4 border-amber-500 text-center">
            <div class="mb-8">
                <span class="bg-amber-100 text-amber-900 text-sm font-bold px-3 py-1 rounded-full">ìš©ì‹ ì¤‘í•™êµ 2í•™ë…„ 2í•™ê¸° ì—­ì‚¬1</span>
                <h2 class="text-2xl font-bold serif text-stone-900 mt-4">ì—­ì‚¬ í€´ì¦ˆ í‰ê°€</h2>
                <p class="text-stone-500 mt-2 text-sm">í•™êµ êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
            </div>
            <button onclick="app.loginWithGoogle()" class="w-full bg-white border border-stone-300 text-stone-700 font-bold py-4 rounded-lg hover:bg-stone-50 transition shadow-sm flex items-center justify-center gap-3">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6"> êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°
            </button>
            <div class="mt-6 border-t border-stone-100 pt-4">
                <a href="./student.html" class="text-stone-400 text-xs hover:text-amber-600 underline">ë‚´ ê¸°ë¡ ë³´ê¸° (í•™ìƒìš© ëŒ€ì‹œë³´ë“œ)</a>
            </div>
        </section>

        <section id="view-register" class="hidden max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg fade-in mt-8 border-t-4 border-blue-500">
            <h2 class="text-xl font-bold text-stone-900 mb-2">ğŸ‘‹ ì²« ë°©ë¬¸ì´ì‹œêµ°ìš”!</h2>
            <p class="text-stone-500 text-sm mb-6">ë³¸ì¸ í™•ì¸ì„ ìœ„í•´ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>(í•œ ë²ˆë§Œ ì…ë ¥í•˜ë©´ ë©ë‹ˆë‹¤)</p>
            <div class="space-y-4">
                <div class="flex gap-2">
                    <div class="w-1/4 bg-stone-100 border border-stone-300 rounded flex items-center justify-center font-bold text-stone-600">2í•™ë…„</div>
                    <select id="reg-class" class="w-2/4 p-3 border border-stone-300 rounded"><option value="">ë°˜</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option></select>
                    <select id="reg-number" class="w-1/4 p-3 border border-stone-300 rounded text-center"><option value="">ë²ˆí˜¸</option></select>
                </div>
                <input type="text" id="reg-name" placeholder="ì´ë¦„ (í•œê¸€ 2~4ì)" class="w-full p-3 border border-stone-300 rounded">
                <button onclick="app.registerUser()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-lg hover:bg-blue-700 transition shadow-lg">ì •ë³´ ë“±ë¡ ì™„ë£Œ</button>
            </div>
        </section>

        <section id="view-ready" class="hidden max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg fade-in mt-8 border-t-4 border-green-500 text-center">
            <h2 class="text-2xl font-bold text-stone-900 mb-2">í™˜ì˜í•©ë‹ˆë‹¤!</h2>
            <p class="text-xl font-bold text-amber-600 mb-6"><span id="user-info-display"></span> í•™ìƒ</p>
            
            <p class="text-stone-500 text-sm mb-6 bg-stone-50 p-3 rounded">âš ï¸ <strong>ì£¼ì˜ì‚¬í•­</strong><br>ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ <strong>10ë¶„ê°„ ì¬ì‘ì‹œê°€ ë¶ˆê°€ëŠ¥</strong>í•©ë‹ˆë‹¤.<br>ì¤€ë¹„ë˜ë©´ ì‹œì‘í•˜ì„¸ìš”.</p>
            
            <button onclick="location.href='student.html'" class="w-full bg-white border border-stone-300 text-stone-700 font-bold py-3 rounded-lg hover:bg-stone-50 transition shadow-sm mb-3">
                ğŸ“Š ë‚´ ê¸°ë¡ ë³´ê¸°
            </button>

            <button onclick="app.startQuiz()" class="w-full bg-green-600 text-white font-bold py-4 rounded-lg hover:bg-green-700 transition shadow-lg text-lg">ë„ì „ ì‹œì‘ <i class="fas fa-play ml-2"></i></button>
            <button onclick="firebase.auth().signOut(); location.reload();" class="mt-4 text-stone-400 text-xs underline">ë¡œê·¸ì•„ì›ƒ</button>
        </section>

        <section id="view-quiz" class="hidden max-w-2xl mx-auto fade-in">
            <div class="bg-white rounded-lg shadow-sm mb-6 sticky top-20 z-30 overflow-hidden border border-stone-200">
                <div class="flex justify-between items-center px-4 py-2 bg-stone-50 border-b border-stone-100">
                    <span class="text-sm font-bold text-stone-600" id="quiz-progress-text">1 / 5</span>
                    <span class="text-lg font-bold text-red-600 font-mono" id="timer-text">60ì´ˆ</span>
                </div>
                <div class="w-full bg-stone-200 h-2"><div id="timer-bar" class="bg-amber-500 h-full timer-bar" style="width: 100%"></div></div>
            </div>
            <div class="bg-white p-6 md:p-10 rounded-lg min-h-[400px] flex flex-col relative shadow-md">
                <div class="mb-4"><span id="student-question-unit" class="inline-block bg-stone-100 text-stone-500 text-xs font-bold px-2 py-1 rounded mb-1 border border-stone-200"></span><span id="question-badge" class="ml-2 bg-amber-100 text-amber-800 text-xs font-bold px-2 py-1 rounded border border-amber-200"></span></div>
                <div id="question-image-area" class="mb-4 hidden text-center"><img id="question-image" src="" class="q-image-thumb" onclick="document.getElementById('image-zoom-content').src=this.src;document.getElementById('image-zoom-modal').style.display='flex'"></div>
                <h3 id="question-text" class="text-xl md:text-2xl font-bold mt-2 mb-8 text-stone-900 leading-relaxed serif break-keep"></h3>
                <div id="answer-area" class="flex-grow mb-6"></div>
                <div class="flex gap-3 mt-auto">
                    <button id="btn-prev" onclick="app.prevQuestion()" class="hidden w-1/3 bg-stone-200 text-stone-700 font-bold py-4 rounded-lg hover:bg-stone-300">ì´ì „</button>
                    <button id="btn-next" onclick="app.submitAnswer()" class="w-full bg-amber-600 text-white font-bold py-4 rounded-lg hover:bg-amber-700 shadow-md">ë‹¤ìŒ</button>
                </div>
            </div>
        </section>

        <section id="view-results" class="hidden max-w-lg mx-auto fade-in mt-6">
            <div class="bg-white p-8 rounded-xl shadow-xl text-center border-t-8 border-amber-500">
                <h2 class="text-3xl font-bold serif mb-2 text-stone-800">í‰ê°€ ì¢…ë£Œ</h2>
                <p class="text-stone-500 mb-6"><span id="result-name" class="font-bold text-stone-900"></span> í•™ìƒì˜ ìµœì¢… ê¸°ë¡</p>
                <div class="relative w-48 h-48 mx-auto mb-4"><canvas id="scoreChart"></canvas><div class="absolute inset-0 flex items-center justify-center flex-col"><span class="text-5xl font-bold text-amber-600 font-mono" id="score-text">0</span><span class="text-xs text-stone-400">ì </span></div></div>
                <div id="submission-status" class="bg-stone-50 p-3 rounded text-sm mb-6 border border-stone-200 text-stone-500"><i class="fas fa-circle-notch fa-spin"></i> ë°ì´í„° ì €ì¥ ì¤‘...</div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="document.getElementById('review-section').classList.toggle('hidden')" class="bg-white border-2 border-stone-200 text-stone-700 font-bold py-3 rounded hover:bg-stone-50">ì˜¤ë‹µë…¸íŠ¸</button>
                    <button onclick="location.reload()" class="bg-stone-900 text-white font-bold py-3 rounded hover:bg-stone-700 shadow-lg">ë‹¤ì‹œ ë„ì „</button>
                </div>
            </div>
            <div id="review-section" class="hidden mt-6 bg-white p-6 rounded-xl shadow-lg border border-red-200">
                <h3 class="font-bold text-lg mb-4 text-red-600 border-b pb-2">ì˜¤ë‹µ í™•ì¸</h3>
                <div id="review-list" class="space-y-4 text-left"></div>
            </div>
        </section>
    </main>
    <footer class="bg-stone-100 py-6 mt-8 border-t border-stone-200 text-center"><p class="text-stone-400 text-xs font-bold font-mono">Copyright Â© ìš©ì‹ ì¤‘í•™êµ ì—­ì‚¬êµì‚¬ ë°©ì¬ì„.</p></footer>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAOlPQ5PFmL0zxmGrGcuEBnqBXisph7kPU", authDomain: "history-quiz-yongsin.firebaseapp.com", projectId: "history-quiz-yongsin", storageBucket: "history-quiz-yongsin.firebasestorage.app", messagingSenderId: "177587430482", appId: "1:177587430482:web:d79cc145c11e335cc3ab8b", measurementId: "G-LHN97D7R2R" };
        
        let db; 
        try { 
            if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); } 
            db = firebase.firestore(); 
        } catch(e) { console.error("Error", e); }

        const app = {
            state: { currentUser: null, userProfile: null, questions:[], allQuestions:[], currentIndex:0, answers:{}, score:0, timer:null, timeLeft:60, isTimeOut:false, isQuizActive: false },
            
            init: function() { 
                window.addEventListener('beforeunload', (e) => { if (this.state.isQuizActive) { e.preventDefault(); e.returnValue = ''; } });
                
                // ë²ˆí˜¸ ì„ íƒì§€ ìƒì„±
                const numSelect = document.getElementById('reg-number');
                for(let i=1; i<=35; i++) { const opt = document.createElement('option'); opt.value = i; opt.innerText = i; numSelect.appendChild(opt); }

                this.updateVisitCount();
                
                // [ì¤‘ìš”] ì¸ì¦ ìƒíƒœ ê°ì§€ ë¦¬ìŠ¤ë„ˆ
                firebase.auth().onAuthStateChanged((user) => {
                    if (user) {
                        this.state.currentUser = user;
                        this.checkUserProfile(user.uid);
                    } else {
                        this.showView('view-login');
                        this.showLoading(false);
                    }
                });
            },

            // êµ¬ê¸€ ë¡œê·¸ì¸
            loginWithGoogle: function() {
                const provider = new firebase.auth.GoogleAuthProvider();
                firebase.auth().signInWithPopup(provider).catch((error) => {
                    alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
                });
            },

            // ìœ ì € í”„ë¡œí•„(DB) í™•ì¸
            checkUserProfile: async function(uid) {
                this.showLoading(true, "ì •ë³´ í™•ì¸ ì¤‘...");
                const doc = await db.collection('users').doc(uid).get();
                if (doc.exists) {
                    this.state.userProfile = doc.data();
                    document.getElementById('user-info-display').innerText = `${this.state.userProfile.class}ë°˜ ${this.state.userProfile.number}ë²ˆ ${this.state.userProfile.name}`;
                    this.showView('view-ready');
                } else {
                    this.showView('view-register');
                }
                this.showLoading(false);
            },

            // ìµœì´ˆ ì •ë³´ ë“±ë¡
            registerUser: async function() {
                const cls = document.getElementById('reg-class').value;
                const num = document.getElementById('reg-number').value;
                const name = document.getElementById('reg-name').value.trim();

                if(!cls || !num || !name) { alert("ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
                const nameRegex = /^[ê°€-í£]{2,4}$/;
                if (!nameRegex.test(name)) { alert("ì´ë¦„ì€ 2~4ê¸€ì í•œê¸€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }

                this.showLoading(true, "ë“±ë¡ ì¤‘...");
                try {
                    const profile = { class: cls, number: num, name: name, email: this.state.currentUser.email };
                    await db.collection('users').doc(this.state.currentUser.uid).set(profile);
                    this.state.userProfile = profile;
                    document.getElementById('user-info-display').innerText = `${cls}ë°˜ ${num}ë²ˆ ${name}`;
                    this.showView('view-ready');
                } catch(e) {
                    alert("ë“±ë¡ ì˜¤ë¥˜: " + e.message);
                }
                this.showLoading(false);
            },

            updateVisitCount: function() {
                const badgeText = document.getElementById("live-count-text");
                const sessionKey = 'quiz_visited_session'; 
                if (!sessionStorage.getItem(sessionKey)) {
                    fetch('https://api.counterapi.dev/v1/westory28-history-quiz/visits/up').then(res=>res.json()).then(d=>{ badgeText.innerText = `ì´ ë„ì „: ${d.count}ëª…`; sessionStorage.setItem(sessionKey, 'true'); }).catch(()=>{});
                } else {
                    fetch('https://api.counterapi.dev/v1/westory28-history-quiz/visits/').then(res=>res.json()).then(d=>{ badgeText.innerText = `ì´ ë„ì „: ${d.count}ëª…`; }).catch(()=>{});
                }
            },

            showLoading: function(show, msg="ë¡œë”© ì¤‘...") { 
                document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; 
                if(msg) document.getElementById('loading-text').innerText = msg;
            },

            // [ìˆ˜ì •ë¨] goHome í•¨ìˆ˜ì—ì„œ 11ë¶„ -> 10ë¶„ìœ¼ë¡œ ì•ˆë‚´ ë¬¸êµ¬ ë³€ê²½
            goHome: function() {
                if (this.state.isQuizActive) { if (confirm("í¬ê¸°í•˜ê³  ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?\n(10ë¶„ê°„ ì¬ì‘ì‹œ ë¶ˆê°€)")) location.reload(); } 
                else location.reload();
            },

            startQuiz: async function() {
                // [ì„œë²„ ì²´í¬] 10ë¶„ ì°¨ë‹¨ ë¡œì§
                this.showLoading(true, "ì‘ì‹œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸ ì¤‘...");
                
                try {
                    // DBì—ì„œ ìµœì‹  ìœ ì € ì •ë³´(ì°¨ë‹¨ ì‹œê°„) ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
                    const userDoc = await db.collection('users').doc(this.state.currentUser.uid).get();
                    const userData = userDoc.data();
                    const blockedUntil = userData.blockedUntil || 0;
                    const now = new Date().getTime();

                    if (now < blockedUntil) {
                        const leftMins = Math.ceil((blockedUntil - now) / (1000 * 60));
                        this.showLoading(false);
                        alert(`â›” ì¬ì‘ì‹œ ë¶ˆê°€!\n\n${leftMins}ë¶„ ë’¤ì— ë‹¤ì‹œ ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                        return;
                    }

                    // ë¬¸ì œ ë¡œë“œ
                    await this.loadRandomQuestions();
                    if(!this.state.allQuestions || this.state.allQuestions.length === 0) throw new Error("ë¬¸ì œ ì—†ìŒ");

                    // [ì¤‘ìš”] [ìˆ˜ì •ë¨] ì°¨ë‹¨ ì‹œê°„ì„ 11 -> 10ìœ¼ë¡œ ë³€ê²½
                    await db.collection('users').doc(this.state.currentUser.uid).update({
                        blockedUntil: now + (10 * 60 * 1000)
                    });

                } catch(e) {
                    this.showLoading(false);
                    alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
                    return;
                }

                // í€´ì¦ˆ ì‹œì‘
                this.state.student = this.state.userProfile; // í”„ë¡œí•„ ì •ë³´ ë³µì‚¬
                this.state.questions = this.state.allQuestions; 
                this.state.currentIndex = 0; 
                this.state.answers = {}; 
                this.state.score = 0; 
                this.state.timeLeft = 60; 
                this.state.isTimeOut = false; 
                this.state.isQuizActive = true; 
                
                this.showLoading(false);
                this.showView('view-quiz'); 
                this.renderQuestion(); 
                this.startTimer();
            },

            loadRandomQuestions: async function() {
                if(!db) return;
                let totalCount = 189; 
                try { const metaDoc = await db.collection("metadata").doc("count_info").get(); if (metaDoc.exists) totalCount = metaDoc.data().total_questions || 189; } catch(e) {}
                
                const randomIds = new Set();
                const pickCount = Math.min(5, totalCount); 
                
                if (totalCount >= 5) {
                    const recentRange = 50; const startOfRecent = Math.max(1, totalCount - recentRange + 1);
                    while(randomIds.size < 3) { const rand = Math.floor(Math.random() * (totalCount - startOfRecent + 1)) + startOfRecent; randomIds.add(rand.toString()); }
                }
                while(randomIds.size < pickCount) { const rand = Math.floor(Math.random() * totalCount) + 1; randomIds.add(rand.toString()); }
                
                const targetIds = Array.from(randomIds);
                const qSnapshot = await db.collection("quiz_questions").where(firebase.firestore.FieldPath.documentId(), 'in', targetIds).get();
                const loadedData = [];
                qSnapshot.forEach((doc) => { let data = doc.data(); data.id = parseInt(doc.id); loadedData.push(data); });
                this.state.allQuestions = this.shuffleArray(loadedData);
            },

            shuffleArray: function(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; },
            
            startTimer: function() { 
                if(this.state.timer) clearInterval(this.state.timer); 
                const bar = document.getElementById('timer-bar'), txt = document.getElementById('timer-text'); 
                bar.style.width='100%'; txt.innerText='60ì´ˆ'; 
                this.state.timer = setInterval(() => { 
                    this.state.timeLeft--; 
                    txt.innerText = this.state.timeLeft + 'ì´ˆ'; 
                    bar.style.width = (this.state.timeLeft/60)*100 + '%'; 
                    if(this.state.timeLeft<=10) { bar.classList.add('timer-urgent'); txt.classList.add('animate-pulse'); } 
                    if(this.state.timeLeft<=0) { clearInterval(this.state.timer); this.state.isTimeOut=true; alert("ì¢…ë£Œ"); this.finishQuiz(); } 
                }, 1000); 
            },

            renderQuestion: function() {
                const q = this.state.questions[this.state.currentIndex];
                this.tempAnswer = this.state.answers[q.id] || null;
                document.getElementById('quiz-progress-text').innerText = `${this.state.currentIndex+1}/${this.state.questions.length}`;
                document.getElementById('question-badge').innerText = {'choice':'ê°ê´€ì‹','blank':'ë‹¨ë‹µ','word':'ë‹¨ë‹µ','order':'ìˆœì„œ','ox':'O/X'}[q.type];
                document.getElementById('student-question-unit').innerText = q.unit || "ê¸°íƒ€";
                const img = document.getElementById('question-image'); 
                if(q.image) { img.src=q.image; img.parentNode.classList.remove('hidden'); } else img.parentNode.classList.add('hidden');
                document.getElementById('question-text').innerHTML = this.linkify(q.question);
                
                const area = document.getElementById('answer-area'); area.innerHTML = ''; 
                document.getElementById('btn-prev').classList.toggle('hidden', this.state.currentIndex === 0);
                document.getElementById('btn-next').className = this.state.currentIndex === 0 ? "w-full bg-amber-600 text-white font-bold py-4 rounded-lg hover:bg-amber-700 transition shadow-md" : "w-2/3 bg-amber-600 text-white font-bold py-4 rounded-lg hover:bg-amber-700 transition shadow-md";
                
                if(q.type === 'choice') { 
                    const grid = document.createElement('div'); grid.className="grid grid-cols-1 gap-3"; 
                    q.options.forEach((opt,i) => { 
                        const btn = document.createElement('div'); const isSelected = this.tempAnswer === opt; 
                        btn.className = `choice-btn ${isSelected ? 'selected' : ''}`; 
                        btn.innerHTML = `<span class="choice-badge">${i+1}</span> ${this.linkify(opt)}`; 
                        btn.onclick = () => { this.state.answers[q.id] = opt; this.renderQuestion(); }; 
                        grid.appendChild(btn); 
                    }); area.appendChild(grid); 
                } else if(q.type === 'ox') { 
                    const box = document.createElement('div'); box.className="flex gap-4 h-40"; 
                    const btnO = document.createElement('button'); btnO.className=`flex-1 ox-btn btn-o ${this.tempAnswer==='O'?'selected':''}`; btnO.innerText="O"; btnO.onclick=()=>{ this.state.answers[q.id]='O'; this.renderQuestion(); }; 
                    const btnX = document.createElement('button'); btnX.className=`flex-1 ox-btn btn-x ${this.tempAnswer==='X'?'selected':''}`; btnX.innerText="X"; btnX.onclick=()=>{ this.state.answers[q.id]='X'; this.renderQuestion(); }; 
                    box.append(btnO,btnX); area.appendChild(box); 
                } else if(q.type === 'order') { 
                    this.orderTemp = this.tempAnswer ? this.tempAnswer.split('-') : []; 
                    const box = document.createElement('div'); box.className="border-2 dashed border-amber-300 rounded p-4 mb-3 bg-amber-50 min-h-[50px] flex flex-wrap gap-2"; 
                    const opts = document.createElement('div'); opts.className="flex flex-wrap gap-2"; 
                    this.orderTemp.forEach(opt => { const btn = document.createElement('button'); btn.className="seq-btn seq-btn-selected"; btn.innerText=opt; btn.onclick = () => { this.orderTemp = this.orderTemp.filter(x=>x!==opt); this.state.answers[q.id] = this.orderTemp.join('-'); this.renderQuestion(); }; box.appendChild(btn); }); 
                    q.options.filter(o => !this.orderTemp.includes(o)).forEach(opt => { const btn = document.createElement('button'); btn.className="seq-btn seq-btn-default"; btn.innerText=opt; btn.onclick = () => { this.orderTemp.push(opt); this.state.answers[q.id] = this.orderTemp.join('-'); this.renderQuestion(); }; opts.appendChild(btn); }); 
                    area.append(box, opts); 
                } else { 
                    const inp = document.createElement('input'); inp.type="text"; inp.className="w-full p-4 border-b-2 border-stone-300 focus:border-amber-500 text-center text-lg outline-none"; inp.placeholder="ì •ë‹µ ì…ë ¥"; 
                    if(this.tempAnswer) inp.value = this.tempAnswer; inp.oninput = (e) => { this.tempAnswer=e.target.value; this.state.answers[q.id] = e.target.value; }; inp.onkeydown = (e) => { if(e.key==='Enter') this.submitAnswer(); }; area.appendChild(inp); 
                }
            },

            linkify: function(text) {
                if(!text) return "";
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                return text.replace(urlRegex, function(url) {
                    return '<a href="' + url + '" target="_blank" class="text-blue-600 underline font-bold" onclick="event.stopPropagation()">ë§í¬ ì—´ê¸°</a>';
                });
            },

            prevQuestion: function() { const q = this.state.questions[this.state.currentIndex]; if (this.state.currentIndex > 0) { this.state.currentIndex--; this.renderQuestion(); } },
            
            submitAnswer: function() { const q = this.state.questions[this.state.currentIndex]; let ans = this.state.answers[q.id]; if(q.type==='order') { if(!ans || ans.split('-').length !== q.options.length) { alert("ìˆœì„œë¥¼ ì™„ì„±í•˜ì„¸ìš”"); return; } } else if(!ans) { alert("ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”"); return; } if(this.state.currentIndex < 4) { this.state.currentIndex++; this.renderQuestion(); } else this.finishQuiz(); },
            
            finishQuiz: function() {
                clearInterval(this.state.timer); this.state.isQuizActive = false;
                let correct = 0; let details = []; let detailLogs = [];
                this.state.questions.forEach(q => {
                    const u = (this.state.answers[q.id]||"").toString().replace(/\s+/g,'').trim(); const a = q.answer.toString().replace(/\s+/g,'').trim();
                    let isC = false; if(u.length > 0) { isC = (q.type === 'word' || q.type === 'blank') ? (u.includes(a)||a.includes(u)) : (u === a); }
                    if(isC) correct++; else details.push({q:q.question, u:u||"ë¯¸ì…ë ¥", a:q.answer, exp:q.explanation});
                    detailLogs.push({ id: q.id, correct: isC, u: u });
                });
                this.state.score = correct * 20; this.state.incorrectDetails = details;
                this.showView('view-results'); this.renderResults(); this.saveToFirebase(detailLogs);
            },
            
            renderResults: function() { 
                document.getElementById('result-name').innerText = this.state.student.name; 
                document.getElementById('score-text').innerText = this.state.score; 
                const ctx = document.getElementById('scoreChart').getContext('2d'); 
                if(window.myChart) window.myChart.destroy(); 
                window.myChart = new Chart(ctx, { type:'doughnut', data:{labels:['ì •ë‹µ','ì˜¤ë‹µ'], datasets:[{data:[this.state.score, 100-this.state.score], backgroundColor:['#d97706','#e5e7eb'], borderWidth:0}]}, options:{cutout:'80%', plugins:{legend:{display:false}}} }); 
                const list = document.getElementById('review-list'); 
                list.innerHTML = this.state.incorrectDetails.length===0 ? '<div class="text-center py-4">ë§Œì ì…ë‹ˆë‹¤! ğŸ‰</div>' : this.state.incorrectDetails.map(d => `<div class="border-b pb-3 last:border-0"><p class="font-bold text-stone-800 mb-1">Q. ${this.linkify(d.q)}</p><div class="flex gap-2 text-xs mb-2"><span class="text-red-600 bg-red-50 px-2 py-1 rounded">ë‚´ ë‹µ: ${d.u}</span><span class="text-green-600 bg-green-50 px-2 py-1 rounded font-bold">ì •ë‹µ: ${d.a}</span></div><p class="text-xs text-stone-500 bg-stone-50 p-2 rounded">${this.linkify(d.exp)}</p></div>`).join(''); 
            },
            
            saveToFirebase: function(detailLogs = []) {
                const status = document.getElementById('submission-status');
                if(!db) { status.innerHTML = "âš ï¸ DB ì—°ê²° ì‹¤íŒ¨"; return; }
                const data = { timestamp: firebase.firestore.FieldValue.serverTimestamp(), timeString: new Date().toLocaleString(), class: this.state.student.class, number: this.state.student.number, name: this.state.student.name, score: this.state.score, status: this.state.isTimeOut ? "ì‹œê°„ì´ˆê³¼" : "ì™„ë£Œ", details: detailLogs, uid: this.state.currentUser.uid };
                db.collection("metadata").doc("stats").set({ total_plays: firebase.firestore.FieldValue.increment(1) }, { merge: true });
                db.collection("quiz_results").add(data).then(() => { status.className = "bg-green-100 text-green-700 p-3 rounded text-sm mb-6 border border-green-200 font-bold"; status.innerHTML = '<i class="fas fa-check-circle"></i> ì œì¶œ ì™„ë£Œ!'; }).catch((error) => { console.error("Error: ", error); status.className = "bg-red-100 text-red-700 p-3 rounded text-sm mb-6 border border-red-200"; status.innerHTML = 'âš ï¸ ì „ì†¡ ì‹¤íŒ¨'; });
            },
            
            showView: function(id) { document.querySelectorAll('main > section').forEach(el => el.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); window.scrollTo(0,0); }
        };
        window.onload = function() { app.init(); };
    </script>
</body>
</html>
